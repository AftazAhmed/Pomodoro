<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pomodoro Tree â€” Study Mode</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-G91N05XLB3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-G91N05XLB3');
  </script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#eaf3ff; --surface:#ffffff; --surface-2:#eef6ff; --line:#caddf8;
      --text:#0b1a33; --dim:#4a6894;
      --radius-lg:18px; --shadow:0 10px 28px rgba(30,70,140,.1);
      --btn-text:#ffffff; --btn-primary:#2563eb; --btn-primary-hover:#1e40af;
      --btn-success:#16a34a; --btn-success-hover:#0f6a33;
      --btn-danger:#ef4444; --btn-danger-hover:#b91c1c;
      --btn-neutral:#334155; --btn-neutral-hover:#1f2937; --btn-focus:#0ea5e9;
      --progress-green:#16a34a; --progress-red:#ef4444; --track-bg:#e6efff;
      --xy-font:28.35px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width:1140px; margin:0 auto; padding:20px 16px 120px; }
    header,.tzBar,.stats,.chip,.timerCard,.controls,.settings,.treePanel,.tabs,.tab,.panelCard,.gridWrap,.gridHead,.grid,.bottomAuth,.modesBar,.modeEditRow,.topStack,.timerTypeBar { display:flex; align-items:center; }

    header{ justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1{ margin:0; font-size:22px; }
    .brand{ gap:10px; padding:8px 12px; border-radius:999px; background:linear-gradient(180deg,#f0f6ff,#ffffff); border:1px solid var(--line); }
    .modeTag{ font-weight:800; color:#14563a; font-size:20px; }

    .topStack{ flex-direction:column; gap:12px; margin-top:12px; width:100%; }

    .timerTypeBar{ gap:12px; justify-content:space-between; flex-wrap:wrap; background:#fff; border:1px solid var(--line); border-radius:14px; padding:10px 12px; box-shadow:var(--shadow); }
    .timerTypeLeft{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .timerTypeLeft label{ color:#4a6894; font-weight:800; }
    .timerTypeLeft select{ padding:8px 10px; border-radius:12px; border:1px solid var(--line); background:#fff; color:#0b1a33; font-weight:800; }
    .customInputs{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .customInputs input{ width:90px; padding:8px 10px; border-radius:12px; border:1px solid var(--line); text-align:center; font-weight:800; }
    .miniNote{ color:#4a6894; font-weight:700; }

    .centerBox{ width:100%; display:flex; justify-content:center; } /* keep central alignment fixed */
    .timerCard{ background:#fff; border:1px solid var(--line); border-radius:var(--radius-lg); padding:16px; box-shadow:var(--shadow); flex-direction:column; width:760px; }
    .time{ font-size:112px; font-weight:800; color:#0e2a70; text-align:center; }
    .controls{ gap:8px; margin-top:10px; flex-wrap:wrap; justify-content:center; }
    button{
      border:none; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer;
      color:#fff; background:var(--btn-neutral);
      box-shadow:0 1px 0 rgba(0,0,0,.06), 0 6px 14px rgba(15,23,42,.14);
      transition:background-color .18s ease, transform .08s ease, box-shadow .18s ease;
      border:1px solid rgba(255,255,255,.06);
    }
    button:hover{ background:var(--btn-neutral-hover); }
    button:active{ transform:translateY(1px); }
    button:focus-visible{ outline:3px solid var(--btn-focus); outline-offset:2px; }
    #startBtn{ background:var(--btn-success); }
    #startBtn:hover{ background:var(--btn-success-hover); }
    #resetBtn{ background:var(--btn-danger); }
    #resetBtn:hover{ background:var(--btn-danger-hover); }
    #lptSetBtn{ background:var(--btn-primary); }
    #lptSetBtn:hover{ background:var(--btn-primary-hover); }

    .settings{ gap:12px; margin-top:10px; flex-wrap:wrap; justify-content:center; color:var(--dim); flex-direction:column; align-items:center; width:100%; }
    input[type=range][readonly]{ pointer-events:none; }
    .numWrap{ display:flex; align-items:center; gap:8px; }
    .numWrap input{ width:96px; padding:8px 10px; border-radius:12px; border:1px solid var(--line); text-align:center; font-weight:800; }

    .estWrap{ margin-top:6px; color:#0b1a33; font-weight:800; font-size:11px; line-height:1.25; text-align:center; min-height:22px; display:flex; flex-direction:column; gap:4px; align-items:center; justify-content:center; order:-1; width:100%; }

    .progressWrap{ display:flex; align-items:center; gap:10px; }
    #lptRange{
      -webkit-appearance:none; appearance:none; width:260px; height:12px; border-radius:999px; overflow:hidden; background:var(--track-bg); border:1px solid var(--line);
      background-image:linear-gradient(90deg, var(--progress-green) 0%, var(--progress-red) 0%);
      background-size:100% 100%; background-repeat:no-repeat;
    }
    #lptRange::-webkit-slider-thumb{ -webkit-appearance:none; width:0; height:0; background:transparent; }
    #lptRange::-moz-range-thumb{ width:0; height:0; background:transparent; border:none; }
    #lptRange::-webkit-slider-runnable-track{ height:12px; border-radius:999px; background:transparent; }
    #lptRange::-moz-range-track{ height:12px; border-radius:999px; background:transparent; }

    .treePanel{ background:#fff; border:1px solid var(--line); border-radius:var(--radius-lg); padding:14px; flex-direction:column; box-shadow:var(--shadow); width:760px; }
    .treeBox{ position:relative; width:560px; height:560px; margin:6px auto; border:1px solid var(--line); border-radius:18px; overflow:hidden; }
    .sky{ position:absolute; inset:0; background:linear-gradient(180deg,#cfe8ff 0%, #8ec5ff 62%, #bfeec7 62%, #8edaa0 100%); }
    .percentLabel{ position:absolute; left:14px; bottom:8px; font:900 81px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#ef4444; text-shadow:0 3px 0 #fff, 0 0 10px rgba(255,255,255,.75); pointer-events:none; letter-spacing:1.5px; z-index:2; display:none; } /* hidden per requirements */
    .xyLabel{ position:absolute; left:16px; top:14px; font:900 28.35px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#0b1a33; text-shadow:0 2px 0 rgba(255,255,255,.65); pointer-events:none; letter-spacing:1px; z-index:2; }
    .todaySky{ position:absolute; left:16px; top:52px; font:800 21px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#14563a; text-shadow:0 2px 0 rgba(255,255,255,.65); pointer-events:none; z-index:2; background:rgba(255,255,255,.55); padding:4px 8px; border-radius:10px; border:1px solid rgba(200,216,238,.8); }

    @keyframes canopyBlink { 0%,100%{ stroke:#065f46;} 50%{ stroke:#000; } }
    @keyframes leafBlink { 0%,100%{ fill:#166534;} 50%{ fill:#86efac;} }
    .blink-canopy{ animation: canopyBlink 900ms linear infinite; }
    .blink-leaf{ animation: leafBlink 900ms linear infinite; }
    .leaf-number{ font:800 13px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; fill:#ffffff; text-anchor:middle; dominant-baseline:middle; }

    .rain{ position:absolute; inset:0; pointer-events:none; display:none; z-index:9999; }
    .rain .drop{ position:absolute; top:-12px; width:3px; height:14px; background:rgba(14,42,112,.45); border-radius:2px; animation:rainFall 0.8s linear infinite; }
    .rain .drop.far{ opacity:.6; transform:scale(.9); animation-duration:1.2s; }
    @keyframes rainFall{ to{ transform:translateY(620px); } }

    .tzBar{ gap:10px; padding:10px 12px; border-radius:14px; background:#fff; border:1px solid var(--line); box-shadow:var(--shadow); justify-content:space-between; flex-wrap:wrap; margin-top:12px; width:760px; }
    .tzLeft{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .tzLeft label{ color:#4a6894; font-weight:800; }
    .tzLeft select{ padding:8px 10px; border-radius:12px; border:1px solid var(--line); background:#fff; color:#0b1a33; font-weight:700; min-width:260px; }
    .stats{ gap:10px; flex-wrap:wrap; }
    .chip{ gap:8px; padding:8px 12px; border-radius:999px; background:#fff; border:1px solid var(--line); color:#4a6894; }

    .tabsWrap{ margin:12px auto; background:#fff; border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:14px; width:980px; }
    .tabs{ gap:8px; flex-wrap:wrap; padding:8px; border:1px solid var(--line); border-radius:999px; background:var(--surface-2); justify-content:center; }
    .tab{ gap:8px; padding:8px 12px; border-radius:999px; cursor:pointer; color:#4a6894; }
    .tab.active{ color:#0b1a33; background:linear-gradient(180deg,#e6f1ff,#ffffff); }
    .panelCard{ display:none; margin-top:12px; background:#fff; border:1px solid var(--line); border-radius:18px; padding:14px; gap:10px; flex-wrap:wrap; }

    .modesBar{ gap:10px; padding:12px; border-radius:14px; background:#fff; border:1px solid var(--line); box-shadow:var(--shadow); justify-content:space-between; flex-wrap:wrap; margin:0; width:100%; }
    .modesBar select{ padding:8px 10px; border-radius:12px; border:1px solid var(--line); font-weight:800; color:#0b1a33; min-width:260px; }
    .modeEditRow{ gap:8px; flex-wrap:wrap; }
    .modeEditRow .editGroup{ display:flex; align-items:center; gap:6px; background:#f8fbff; border:1px solid var(--line); padding:6px 8px; border-radius:10px; }
    .modeEditRow input{ padding:6px 8px; border-radius:8px; border:1px solid var(--line); font-weight:700; min-width:160px; }
    .modeNote{ color:#4a6894; font-weight:700; flex-basis:100%; }

    .gridWrap{ margin:14px auto; background:#fff; border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:14px; width:980px; display:flex; flex-direction:column; align-items:center; }
    .gridHead{ justify-content:space-between; gap:8px; color:#4a6894; width:100%; max-width:980px; }
    .grid{ display:grid; gap:10px; grid-template-columns:repeat(13, minmax(0, 1fr)); width:100%; margin-top:10px; }
    @media (max-width:980px){ .grid{ grid-template-columns:repeat(8, minmax(0, 1fr)); } }
    .cell{ position:relative; aspect-ratio:1/1; border-radius:14px; background:#f3f8ff; border:1px dashed #c8d8ee; color:#4e6ea0; display:flex; align-items:center; justify-content:center; font-weight:800; overflow:hidden; }
    .num{ position:relative; z-index:1; font-size:18px; color:#4e6ea0; }
    .icon{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:26px; z-index:2; pointer-events:none; }
    .cell.live{ background:linear-gradient(180deg,#e9fff1,#ffffff); border:2px solid #16a34a; color:#14563a; }

    .bottomAuth{ margin:18px auto 0; max-width:760px; justify-content:center; gap:10px; flex-wrap:wrap; color:#4a6894; }
    .bottomAuth input{ padding:8px 10px; border-radius:12px; border:1px solid var(--line); }
  </style>
</head>
<body data-mode="Study">
  <div class="wrap">
    <header>
      <div class="brand"><span style="font-weight:800;">ðŸŒ³</span><h1>Pomodoro Tree</h1></div>
      <div class="modeTag">Mode: <span id="modeName">Study</span></div>
    </header>

    <div class="topStack">
      <section class="timerTypeBar" aria-label="Timer type and custom duration">
        <div class="timerTypeLeft">
          <label for="timerTypeSelect">Timer</label>
          <select id="timerTypeSelect">
            <option value="pomodoro">Pomodoro timer (25 min)</option>
            <option value="custom">Custom timer</option>
            <option value="simple">Simple timer</option>
          </select>
          <div class="customInputs" id="customInputs" style="display:none;">
            <label class="miniNote" for="customMin">Minutes</label>
            <input id="customMin" type="number" min="0" max="999" step="1" value="15" />
            <label class="miniNote" for="customSec">Seconds</label>
            <input id="customSec" type="number" min="0" max="59" step="1" value="0" />
            <button id="applyCustomBtn" title="Apply custom duration">Apply</button>
          </div>
        </div>
        <div class="miniNote" id="timerTypeHint">Choose timer type and optional duration for Custom/Simple.</div>
      </section>

      <div class="centerBox">
        <section class="timerCard">
          <div class="time" id="clock">25:00</div>
          <div class="controls">
            <button id="startBtn">Start 25:00</button>
            <button id="resetBtn">Reset</button>
          </div>
          <div class="settings" id="settingsBlock">
            <div class="numWrap" style="order:1;">
              <label for="lptInput"><strong>Leaves per tree (LPT)</strong></label>
              <input id="lptInput" type="number" min="1" max="200" step="1" value="9" />
              <button id="lptSetBtn">Set</button>
              <span id="lockHint" style="color:#4a6894">Editable once per ISO week</span>
            </div>

            <div class="estWrap">
              <div class="miniNote" id="lptNote">LPT = No. of sessions per week</div>
            </div>

            <div class="progressWrap" id="progressBlock" style="order:2;">
              <input type="range" id="lptRange" min="1" max="200" step="1" value="9" readonly />
              <span id="lptVal">9</span>
            </div>
            <div id="weeklyTarget" class="miniNote" style="order:3;">Weekly target = 3 hrs 45 mins (as per LPT)</div>
          </div>
        </section>
      </div>

      <div class="centerBox">
        <section class="treePanel">
          <h3 style="margin:0 0 8px 0; text-align:center;">Current Tree</h3>
          <div class="treeBox">
            <div class="sky"></div>
            <div id="percentLabel" class="percentLabel"></div>
            <div id="xyLabel" class="xyLabel">0/9 leaves</div>
            <div id="todaySky" class="todaySky">Total duration (today): 0 mins</div>
            <div id="rainLayer" class="rain"></div>

            <svg width="560" height="560" viewBox="0 0 560 560" style="position:absolute; inset:0; pointer-events:none;">
              <g id="saplings" stroke="#2f6f3a" stroke-width="2" fill="none" stroke-linecap="round"></g>
            </svg>

            <svg id="treeSVG" width="680" height="620" viewBox="0 0 560 410" preserveAspectRatio="xMidYMid meet" style="position:absolute; left:50%; transform:translateX(-50%); bottom:20px; overflow:visible">
              <defs>
                <filter id="leafShadow" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="1" stdDeviation="1.0" flood-color="#000" flood-opacity="0.15" /></filter>
                <mask id="fillMask" maskUnits="userSpaceOnUse" x="100" y="150" width="380" height="220">
                  <rect fill="#000" x="100" y="150" width="380" height="220"/>
                  <rect id="fillRect" x="110" y="316" width="360" height="0" fill="#fff"/>
                </mask>
                <linearGradient id="canopyBaseDarker" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" stop-color="#a3e3b5" />
                  <stop offset="100%" stop-color="#7fce9d" />
                </linearGradient>
              </defs>

              <g id="canopyGroup" transform="translate(280 280) scale(1,1.2) translate(-280 -280)">
                <path id="canopyWhite" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="url(#canopyBaseDarker)"/>
                <path id="canopyFillGreen" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="#3aa85f" mask="url(#fillMask)"/>
                <path id="canopyOutline" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="transparent" stroke="#065f46" stroke-width="3" />
                <path d="M 280 380 C 280 350, 280 320, 280 284" fill="none" stroke="#4e342e" stroke-width="32" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M 280 284 C 270 270, 258 255, 248 238" fill="none" stroke="#4e342e" stroke-width="24" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M 280 284 C 290 270, 302 255, 312 238" fill="none" stroke="#4e342e" stroke-width="24" stroke-linecap="round" stroke-linejoin="round" />
                <g id="leafLayer" filter="url(#leafShadow)"></g>
              </g>
            </svg>
          </div>
        </section>
      </div>
    </div>

    <div class="centerBox">
      <div class="tzBar" id="tzBar">
        <div class="tzLeft">
          <label for="tzSelect">Time zone</label>
          <select id="tzSelect" aria-label="Time zone"></select>
        </div>
        <div class="stats" id="statsChips">
          <div class="chip" id="todayChip"><strong>Pomodoro hrs (week)</strong>: 0 hrs 0 mins</div>
          <div class="chip" id="totalTimeChip"><strong>Pomodoro hrs (overall)</strong>: 0 hrs 0 mins</div>
        </div>
      </div>
    </div>

    <section class="tabsWrap" id="tabsWrap">
      <div class="tabs">
        <div class="tab" data-tab="subPanel">Subscription</div>
        <div class="tab" data-tab="syncPanel">Sync</div>
        <div class="tab active" data-tab="modesPanel">Modes</div>
      </div>

      <div id="subPanel" class="panelCard">
        <div id="subStatus">Plan: Free â€” 4 weeks cap. Unlock remaining 48 weeks for $1/year.</div>
        <button id="subBtn">Unlock 48 weeks â€” $1</button>
      </div>

      <div id="syncPanel" class="panelCard">
        <div id="authState">Signed out</div>
        <input type="email" id="emailInput" placeholder="email@example.com" />
        <button id="sendLinkBtn">Send sign-in link</button>
        <button id="signOutBtn">Sign out</button>
      </div>

      <div id="modesPanel" class="panelCard" style="display:flex;">
        <div class="modesBar">
          <div class="modeEditRow" style="flex-basis:100%;">
            <label for="modeSelect" class="modeNote">Mode</label>
            <select id="modeSelect" title="Switch mode"></select>
          </div>
          <div class="modeEditRow" id="editableNamesRow">
            <div class="editGroup"><span>Subject 1</span><input id="subject1Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>Subject 2</span><input id="subject2Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>Subject 3</span><input id="subject3Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>User 1</span><input id="user1Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>User 2</span><input id="user2Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>User 3</span><input id="user3Input" placeholder="Edit name" /></div>
            <button id="saveNamesBtn">Save names</button>
          </div>
          <div class="modeNote">Each mode has its own timer/data. Selecting from dropdown switches instantly.</div>
        </div>
      </div>
    </section>

    <section class="gridWrap" id="gridWrap">
      <div class="gridHead">
        <div class="chip">Completed Trees</div>
        <div class="chip" id="gridCount">0 / 52</div>
      </div>
      <div class="grid" id="treeGrid"></div>
    </section>

    <div class="bottomAuth" id="bottomAuth">
      <input type="email" id="emailInputBottom" placeholder="email@example.com" />
      <button id="sendLinkBtnBottom">Sign in</button>
      <button id="signOutBtnBottom">Sign out</button>
    </div>
  </div>

  <script>
    const APP_KEY = 'pomodoroTree_SimpleCustomPomodoro_V2';
    const NAMES_KEY = APP_KEY + '_customNames';
    const GLOBAL_KEY = APP_KEY + '_global';
    const svgns='http://www.w3.org/2000/svg';

    const TIMER_TYPES = { pomodoro:'pomodoro', custom:'custom', simple:'simple' };
    const POMODORO_SECONDS = 25*60;

    const DEFAULT_MODE_NAMES = {
      'exercise': 'Exercise mode',
      'cycling': 'Cycling mode',
      'digitalDetox': 'Digital detox mode',
      'bedTime': 'Bed-time mode',
      'quran': 'Quran mode',
      'dikhr': 'Dikhr mode',
      'maths': 'Maths mode',
      'subject1': 'Subject 1 mode',
      'subject2': 'Subject 2 mode',
      'subject3': 'Subject 3 mode',
      'user1': 'User 1 mode',
      'user2': 'User 2 mode',
      'user3': 'User 3 mode'
    };

    const loadGlobal = () => JSON.parse(localStorage.getItem(GLOBAL_KEY) || '{}');
    const G = Object.assign({
      timeZone:'UTC',
      selectedMode:'maths',
      timerType:TIMER_TYPES.pomodoro,
      customSeconds: 15*60
    }, loadGlobal());
    function saveGlobal(){ localStorage.setItem(GLOBAL_KEY, JSON.stringify(G)); }

    const loadNames = () => JSON.parse(localStorage.getItem(NAMES_KEY) || '{}');
    const CUSTOM_NAMES = Object.assign({}, loadNames());
    function saveNames(){ localStorage.setItem(NAMES_KEY, JSON.stringify(CUSTOM_NAMES)); }

    const modeKey = (modeId)=> `${APP_KEY}_mode_${modeId}`;
    const DEFAULT_STATE = {
      leavesPerTree:9, placed:0, secondsLeft:POMODORO_SECONDS, running:false,
      leavesTotal:0, leavesToday:0, weeklyLeaves:0,
      weeklyFocusSeconds:0, totalFocusSeconds:0,
      completedSessions:0,
      grid:[],
      subActive:true, plan:'Free',
      week:undefined, year:undefined,
      weeklyComplete:false,
      weeklyTargetLocked:false, weeklyTargetSetValue:9,
      freeWeeksCap:4
    };
    function loadState(modeId){
      const raw = localStorage.getItem(modeKey(modeId));
      try{ return Object.assign({}, DEFAULT_STATE, raw? JSON.parse(raw): {}); }
      catch{ return Object.assign({}, DEFAULT_STATE); }
    }
    function saveState(modeId, S){
      localStorage.setItem(modeKey(modeId), JSON.stringify(S));
    }

    let currentMode = G.selectedMode || 'maths';
    let S = loadState(currentMode);

    const intervals = {};
    function clearModeInterval(modeId){ if(intervals[modeId]){ clearInterval(intervals[modeId]); intervals[modeId]=null; } }

    const el=id=>document.getElementById(id);
    const clockEl=el('clock');
    const startBtn=el('startBtn');
    const resetBtn=el('resetBtn');

    const lptInput=el('lptInput'), lptSetBtn=el('lptSetBtn'), lptRange=el('lptRange'), lptVal=el('lptVal'), lockHint=el('lockHint');
    const weeklyTargetEl=el('weeklyTarget'), lptNoteEl=el('lptNote');

    const todayChip=el('todayChip');
    const totalTimeChip=el('totalTimeChip');

    const percentLabel=document.getElementById('percentLabel');
    const xyLabel=document.getElementById('xyLabel');
    const rainLayer=el('rainLayer');
    const treeGrid=el('treeGrid'); const gridCount=el('gridCount');
    const leafLayer=document.querySelector('#treeSVG #leafLayer');
    const fillRect=document.getElementById('fillRect');
    const todaySky=el('todaySky');
    const modeNameEl=document.getElementById('modeName');

    const timerTypeSelect = document.getElementById('timerTypeSelect');
    const customInputsDiv = document.getElementById('customInputs');
    const customMinInput = document.getElementById('customMin');
    const customSecInput = document.getElementById('customSec');
    const applyCustomBtn = document.getElementById('applyCustomBtn');
    const timerTypeHint = document.getElementById('timerTypeHint');

    const tzBar = document.getElementById('tzBar');
    const statsChips = document.getElementById('statsChips');
    const tabsWrap = document.getElementById('tabsWrap');
    const gridWrap = document.getElementById('gridWrap');
    const bottomAuth = document.getElementById('bottomAuth');
    const settingsBlock = document.getElementById('settingsBlock');
    const progressBlock = document.getElementById('progressBlock');

    const tzSelect = document.getElementById('tzSelect');
    const modeSelect = document.getElementById('modeSelect');
    const subject1Input = document.getElementById('subject1Input');
    const subject2Input = document.getElementById('subject2Input');
    const subject3Input = document.getElementById('subject3Input');
    const user1Input = document.getElementById('user1Input');
    const user2Input = document.getElementById('user2Input');
    const user3Input = document.getElementById('user3Input');
    const saveNamesBtn = document.getElementById('saveNamesBtn');

    const tabsContainer=document.querySelector('.tabs');
    tabsContainer?.addEventListener('click', (e)=>{
      const t=e.target.closest('.tab'); if(!t) return;
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const id=t.getAttribute('data-tab');
      document.querySelectorAll('.panelCard').forEach(p=>p.style.display='none');
      const panel=document.getElementById(id);
      if(panel) panel.style.display='flex';
    });

    let audioCtx=null;
    function ensureAudioUnlocked(){
      const AC=window.AudioContext||window.webkitAudioContext;
      if(!AC) return;
      if(!audioCtx){ audioCtx=new AC(); }
      if(audioCtx.state==='suspended'){ audioCtx.resume().catch(()=>{}); }
    }
    function playAlarm10s(){
      const isBedtime = (currentMode === 'bedTime');
      if(isBedtime) return;
      if(!audioCtx || audioCtx.state==='suspended') return;
      const now = audioCtx.currentTime;
      const master = audioCtx.createGain();
      master.gain.setValueAtTime(0.0001, now);
      master.gain.linearRampToValueAtTime(0.85, now + 0.03);
      master.gain.setValueAtTime(0.85, now + 9.7);
      master.gain.linearRampToValueAtTime(0.0001, now + 10.0);
      master.connect(audioCtx.destination);
      const oscA = audioCtx.createOscillator(); oscA.type='square'; oscA.frequency.setValueAtTime(880, now);
      const oscB = audioCtx.createOscillator(); oscB.type='sawtooth'; oscB.frequency.setValueAtTime(440, now);
      const trem = audioCtx.createOscillator(); trem.type='sine'; trem.frequency.setValueAtTime(6, now);
      const tremGain = audioCtx.createGain(); tremGain.gain.setValueAtTime(0.5, now);
      trem.connect(tremGain); tremGain.connect(master.gain);
      oscA.connect(master); oscB.connect(master);
      trem.start(now); oscA.start(now); oscB.start(now);
      oscA.stop(now + 10.1); oscB.stop(now + 10.1); trem.stop(now + 10.1);
    }

    function nowInTZ(){
      try{
        const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: G.timeZone, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false });
        const parts = fmt.formatToParts(new Date());
        const get = k => Number(parts.find(p=>p.type===k)?.value);
        const y=get('year'), m=get('month'), d=get('day'), hh=get('hour'), mm=get('minute'), ss=get('second');
        return new Date(Date.UTC(y, m-1, d, hh, mm, ss));
      }catch(e){
        return new Date();
      }
    }
    function isoWeekOf(date){
      const d = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const week = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return { week, year: d.getUTCFullYear() };
    }

    function save(){ saveState(currentMode, S); saveGlobal(); }
    function unshiftWeekToGrid(week, year, live){
      S.grid.unshift({week,year,live,ts:Date.now()});
      if(S.grid.length>52) S.grid.pop();
      save();
    }

    function rolloverWeekIfNeeded(){
      const nowTz = nowInTZ();
      const { week:wk, year:yr } = isoWeekOf(nowTz);
      if(S.week===undefined || S.year===undefined){ S.week=wk; S.year=yr; save(); return; }
      if(S.week!==wk || S.year!==yr){
        const completed = (S.placed>=S.leavesPerTree && S.leavesPerTree>0);
        unshiftWeekToGrid(S.week, S.year, completed);
        S.week=wk; S.year=yr;
        S.weeklyLeaves=0; S.leavesToday=0; S.weeklyFocusSeconds=0;
        S.weeklyComplete=false; S.weeklyTargetLocked=false; S.weeklyTargetSetValue=S.leavesPerTree;
        S.placed=0; S.secondsLeft=getCurrentSessionSeconds();
        if(leafLayer) leafLayer.innerHTML='';
        save();
      }
    }

    const baseAnchors=[{x:280,y:250},{x:220,y:255},{x:350,y:250},{x:220,y:300},{x:340,y:300},{x:255,y:205},{x:340,y:205},{x:390,y:260},{x:190,y:260}];
    function anchorForIndex(i){
      if(i<baseAnchors.length) return baseAnchors[i];
      const k=i-baseAnchors.length+1, a=k*137.508*Math.PI/180, r=30+0.9*Math.sqrt(k)*8, cx=280, cy=260;
      return {x:cx+r*Math.cos(a), y:cy+r*Math.sin(a)*0.7};
    }
    function createLeafG(n){
      const g=document.createElementNS(svgns,'g'); g.setAttribute('filter','url(#leafShadow)');
      const p=document.createElementNS(svgns,'path');
      p.setAttribute('d','M 0 -16 C 10 -10, 12 0, 0 14 C -12 0, -10 -10, 0 -16 Z');
      p.setAttribute('fill','#166534');
      p.setAttribute('stroke','#0b3d22'); p.setAttribute('stroke-width','1.2');
      const t=document.createElementNS(svgns,'text'); t.setAttribute('class','leaf-number'); t.setAttribute('x','0'); t.setAttribute('y','0'); t.textContent=String(n);
      g.appendChild(p); g.appendChild(t); return g;
    }
    function placeLeaf(g,a){ g.setAttribute('transform',`translate(${a.x} ${a.y}) scale(1.05)`); }

    const CANOPY_BOTTOM=316, FILL_OVERSCAN=165;
    function setFillPercent(pct){
      const p=Math.max(0, Math.min(100, Number(pct)||0));
      const targetH=FILL_OVERSCAN*(p/100);
      const targetY=CANOPY_BOTTOM-targetH;
      fillRect.setAttribute('x','110'); fillRect.setAttribute('width','360');
      fillRect.setAttribute('y', String(targetY)); fillRect.setAttribute('height', String(targetH));
      // percentage hidden per requirements
    }
    function percentFromState(){ const denom=Math.max(1, S.leavesPerTree|0); return (S.placed/denom)*100; }
    function applyProgress(){ const p=S.weeklyComplete?100:percentFromState(); setFillPercent(p); }

    function renderLeavesFromState(){
      const layer=document.querySelector('#treeSVG #leafLayer');
      if(!layer) return;
      layer.innerHTML='';
      for(let i=0;i<S.placed;i++){
        const g=createLeafG(i+1); placeLeaf(g, anchorForIndex(i)); layer.appendChild(g);
      }
    }

    function buildSaplings(){
      const g=document.getElementById('saplings');
      if(!g) return;
      g.innerHTML='';
      const cols=7, rows=7;
      const startX=28, endX=532;
      const grassYStart=560*0.62 + 18;
      const rowGap=26;
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const x = Math.round(startX + c * ((endX - startX)/(cols-1)));
          const y = Math.round(grassYStart + r*rowGap);
          const stem = document.createElementNS(svgns,'path');
          stem.setAttribute('d', `M ${x} ${y} l 0 -14`);
          stem.setAttribute('stroke','#2f6f3a');
          stem.setAttribute('stroke-width','2');
          stem.setAttribute('fill','none');
          stem.setAttribute('stroke-linecap','round');

          const leafL = document.createElementNS(svgns,'path');
          leafL.setAttribute('d', `M ${x} ${y-12} c -6 -2, -10 -6, -12 -10`);
          leafL.setAttribute('stroke','#2f6f3a');
          leafL.setAttribute('stroke-width','2');
          leafL.setAttribute('fill','none');
          leafL.setAttribute('stroke-linecap','round');
          leafL.setAttribute('stroke-linejoin','round');

          const leafR = document.createElementNS(svgns,'path');
          leafR.setAttribute('d', `M ${x} ${y-12} c 6 -2, 10 -6, 12 -10`);
          leafR.setAttribute('stroke','#2f6f3a');
          leafR.setAttribute('stroke-width','2');
          leafR.setAttribute('fill','none');
          leafR.setAttribute('stroke-linecap','round');
          leafR.setAttribute('stroke-linejoin','round');

          g.appendChild(stem);
          g.appendChild(leafL);
          g.appendChild(leafR);
        }
      }
    }

    function buildGrid(){
      treeGrid.innerHTML='';
      for(let i=0;i<52;i++){
        const cell=document.createElement('div'); cell.className='cell';
        const num=document.createElement('div'); num.className='num'; num.textContent=String(i+1);
        const icon=document.createElement('div'); icon.className='icon';
        const entry=S.grid[i];
        if(entry){
          icon.textContent = entry.live ? 'ðŸŒ³' : '';
          if(entry.live){ cell.classList.add('live'); }
        }else{
          icon.textContent = '';
        }
        cell.appendChild(num); cell.appendChild(icon); treeGrid.appendChild(cell);
      }
      gridCount.textContent=`${Math.min(S.grid.length, 52)} / 52`;
    }

    function updateWeeklyTarget(){
      const secsPer = getCurrentSessionSeconds();
      const totalSecs = (S.leavesPerTree * secsPer);
      const h = Math.floor(totalSecs/3600);
      const m = Math.round((totalSecs%3600)/60);
      weeklyTargetEl.textContent = `Weekly target = ${h>0? h+' hrs ':''}${m} mins (as per LPT)`;
      lptNoteEl.textContent = 'LPT = No. of sessions per week';
    }

    function formatTimeHM(sec){ const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); return {h,m}; }

    function renderTotals(){
      const w=formatTimeHM(S.weeklyFocusSeconds||0), o=formatTimeHM(S.totalFocusSeconds||0);
      const isCustom = (G.timerType === 'custom');
      todayChip.innerHTML = `<strong>${isCustom? 'Work hrs (week)':'Pomodoro hrs (week)'}</strong>: ${w.h} hrs ${w.m} mins`;
      totalTimeChip.innerHTML = `<strong>${isCustom? 'Work hrs (overall)':'Pomodoro hrs (overall)'}</strong>: ${o.h} hrs ${o.m} mins`;
      const totalTodaySecs = (S.leavesToday * getCurrentSessionSeconds());
      const minsToday = Math.round(totalTodaySecs/60);
      todaySky.textContent = `Total duration (today): ${minsToday} mins`;
      xyLabel.textContent = `${Math.min(S.placed, S.leavesPerTree)}/${S.leavesPerTree} leaves`;
    }

    function paintProgressUI(){
      const total = Math.max(1, Number(S.leavesPerTree)||1);
      const done = Math.max(0, Math.min(S.placed, total));
      const pct = (done/total)*100;
      lptRange.style.backgroundImage = `linear-gradient(90deg, var(--progress-green) ${pct}%, var(--progress-red) ${pct}%)`;
    }

    function format(sec){
      const m=String(Math.floor(sec/60)).padStart(2,'0');
      const s=String(sec%60).padStart(2,'0');
      return `${m}:${s}`;
    }

    function getCurrentSessionSeconds(){
      if(G.timerType==='custom' || G.timerType==='simple') return Math.max(10, Number(G.customSeconds)||900);
      return POMODORO_SECONDS;
    }

    function setClockUIToCurrentType(){
      const secs = getCurrentSessionSeconds();
      const label = format(secs);
      clockEl.textContent = format(S.secondsLeft || secs);
      startBtn.textContent = `Start ${label}`;

      // Hide blocks in Simple; hide slider and percentage in Custom; show all in Pomodoro
      const isSimple = (G.timerType==='simple');
      const isCustom = (G.timerType==='custom');

      // Hide/show lower UI containers
      [tzBar, statsChips, tabsWrap, gridWrap, bottomAuth].forEach(el=>{
        if(!el) return;
        el.style.display = isSimple ? 'none' : '';
      });

      // Settings visibility and slider/percent per requirements
      settingsBlock.style.display = isSimple ? 'none' : '';
      progressBlock.style.display = (isSimple || isCustom) ? 'none' : ''; // no slider in Custom or Simple
      percentLabel.style.display = 'none'; // never show percentage in any mode now
    }

    function setRunning(on){
      S.running=on;
      const canopyOutline = document.getElementById('canopyOutline');
      if(canopyOutline) canopyOutline.classList.toggle('blink-canopy', !!on && G.timerType!=='simple');
      const layer=document.querySelector('#treeSVG #leafLayer');
      const cur=layer?.lastElementChild; if(cur){ cur.querySelector('path').classList.toggle('blink-leaf', !!on && G.timerType!=='simple'); }
      startBtn.disabled = !!on;
      startBtn.textContent = on ? 'Runningâ€¦' : `Start ${format(getCurrentSessionSeconds())}`;
      if(G.timerType!=='simple') showRain(!!on);
      save();
    }

    function renderHUD(){
      setClockUIToCurrentType();
      buildGrid();
      buildSaplings();
      lptVal.textContent=String(S.leavesPerTree);
      lptInput.value = S.leavesPerTree;
      lptSetBtn.disabled = !!S.weeklyTargetLocked;
      lptInput.disabled = !!S.weeklyTargetLocked;
      lockHint.textContent = S.weeklyTargetLocked
        ? `Target locked for ISO Week ${S.week}-${S.year} at ${S.weeklyTargetSetValue}`
        : 'Editable once per ISO week';
      applyProgress();
      if(G.timerType==='pomodoro') paintProgressUI(); // slider only in pomodoro
      updateWeeklyTarget();
      renderTotals();
      populateTimeZonesIfNeeded();
      populateModesUI();
      save();
    }

    function showRain(on){
      rainLayer.style.display=on?'block':'none';
      if(on && rainLayer.childElementCount===0){
        const mk=(n, cls='')=>{
          for(let i=0;i<n;i++){
            const d=document.createElement('div'); d.className='drop'+cls;
            d.style.left=(Math.random()*560)+'px';
            d.style.animationDelay=(Math.random()*0.9)+'s';
            d.style.animationDuration=(cls? (1.0+Math.random()*0.9)+'s' : (0.6+Math.random()*0.6)+'s');
            rainLayer.appendChild(d);
          }
        };
        mk(160,''); mk(120,' far');
      }
    }

    function onSessionComplete(){
      playAlarm10s();

      if(G.timerType!=='simple'){
        const dur = getCurrentSessionSeconds();
        S.weeklyFocusSeconds = (S.weeklyFocusSeconds||0) + dur;
        S.totalFocusSeconds  = (S.totalFocusSeconds||0)  + dur;
        S.completedSessions = (S.completedSessions||0) + 1;

        S.placed+=1; S.leavesTotal+=1; S.leavesToday+=1; S.weeklyLeaves+=1;

        applyProgress();
        setRunning(false);
        showRain(false);

        if(S.placed===S.leavesPerTree){
          S.weeklyComplete=true;
          if(S.week!==undefined && S.year!==undefined){
            S.grid.unshift({week:S.week,year:S.year,live:true,ts:Date.now()});
            if(S.grid.length>52) S.grid.pop();
          }
        }else{
          S.secondsLeft=getCurrentSessionSeconds();
        }
        clockEl.textContent=format(S.secondsLeft);
        save();
        renderHUD();
      }else{
        // Simple: still add a leaf to visualize count, but no stats
        S.placed+=1; S.leavesTotal+=1; S.leavesToday+=1;
        renderLeavesFromState();
        setRunning(false);
        S.secondsLeft=getCurrentSessionSeconds();
        clockEl.textContent=format(S.secondsLeft);
        save();
        // Only update today's label
        const totalTodaySecs = (S.leavesToday * getCurrentSessionSeconds());
        const minsToday = Math.round(totalTodaySecs/60);
        todaySky.textContent = `Total duration (today): ${minsToday} mins`;
      }
    }

    function startSessionWallClock(){
      const thisMode = currentMode;
      const targetEpoch = Date.now() + (S.secondsLeft * 1000);

      const tick = ()=>{
        if(thisMode !== currentMode){ clearModeInterval(thisMode); return; }
        const remainingMs = Math.max(0, targetEpoch - Date.now());
        S.secondsLeft = Math.ceil(remainingMs / 1000);
        clockEl.textContent = format(S.secondsLeft);
        if(G.timerType==='pomodoro') paintProgressUI();
        if (remainingMs <= 0) {
          clearModeInterval(thisMode);
          onSessionComplete();
        }
      };

      const onVisibility=()=>{ if(document.visibilityState==='visible' && intervals[thisMode]) tick(); };

      setRunning(true);
      if(G.timerType!=='simple') renderHUD();
      tick();
      clearModeInterval(thisMode);
      intervals[thisMode] = setInterval(tick, 1000);
      document.addEventListener('visibilitychange', onVisibility, { passive:true });

      startBtn._cleanupVisibility = ()=>document.removeEventListener('visibilitychange', onVisibility);
    }

    function startFlow(){
      if(intervals[currentMode]) return;

      ensureAudioUnlocked();

      if(G.timerType!=='simple'){
        rolloverWeekIfNeeded();
      }

      // Add placeholder leaf only when tracking (custom/pomodoro)
      if(G.timerType!=='simple'){
        if(!S.weeklyComplete && S.placed < S.leavesPerTree){
          const idx=S.placed;
          const layer=document.querySelector('#treeSVG #leafLayer');
          const g=createLeafG(idx+1); placeLeaf(g, anchorForIndex(idx)); layer.appendChild(g);
        }
      }

      const maxSecs = getCurrentSessionSeconds();
      if (S.secondsLeft <= 0 || S.secondsLeft > maxSecs) {
        S.secondsLeft = maxSecs;
      }

      startSessionWallClock();
    }

    function resetTimer(){
      if(intervals[currentMode]){ clearModeInterval(currentMode); startBtn._cleanupVisibility?.(); }
      setRunning(false);
      if(G.timerType!=='simple') showRain(false);
      if(G.timerType!=='simple'){
        const layer=document.querySelector('#treeSVG #leafLayer');
        const cur=layer?.lastElementChild;
        if(cur){
          const idx=(Number(cur.querySelector('text')?.textContent)||0)-1;
          if(idx===S.placed){ layer.removeChild(cur); }
        }
      }
      S.secondsLeft=getCurrentSessionSeconds(); setClockUIToCurrentType();
    }

    const clamp = (v)=>Math.max(1, Math.min(200, Number(v)||1));
    lptInput.addEventListener('input', ()=>{
      const v = clamp(lptInput.value);
      lptVal.textContent = String(v);
      if(G.timerType==='pomodoro'){
        const secs = v * getCurrentSessionSeconds();
        const h = Math.floor(secs/3600);
        const m = Math.round((secs%3600)/60);
        weeklyTargetEl.textContent = `Weekly target = ${h>0? h+' hrs ':''}${m} mins (as per LPT)`;
      }
    });

    lptSetBtn.addEventListener('click', ()=>{
      if(G.timerType==='simple') return;
      rolloverWeekIfNeeded();
      if(S.weeklyTargetLocked) return;
      const v = clamp(lptInput.value);
      S.leavesPerTree = v;
      S.weeklyTargetLocked = true;
      S.weeklyTargetSetValue = v;

      S.placed = 0;
      S.weeklyLeaves = 0;
      S.secondsLeft = getCurrentSessionSeconds();

      const layer=document.querySelector('#treeSVG #leafLayer');
      if(layer) layer.innerHTML = '';
      applyProgress();

      lptVal.textContent = String(S.leavesPerTree);
      renderHUD();
    });

    function populateTimeZonesIfNeeded(){
      if(!tzSelect) return;
      if(tzSelect.options.length===0){
        let zones=[];
        try{ zones = Intl.supportedValuesOf('timeZone'); }
        catch{ zones = ['UTC','Europe/London','Asia/Kolkata','America/New_York','Asia/Tokyo']; }
        zones = Array.from(new Set(['UTC', ...zones]));
        const frag=document.createDocumentFragment();
        for(const z of zones){
          const opt=document.createElement('option');
          opt.value=z;
          opt.textContent=labelForTZ(z);
          frag.appendChild(opt);
        }
        tzSelect.appendChild(frag);
      }
      tzSelect.value = G.timeZone || 'UTC';
    }
    function labelForTZ(tz){
      try{
        const now = new Date();
        const short = new Intl.DateTimeFormat('en', { timeZone: tz, timeZoneName:'shortOffset' }).format(now);
        const offsetPart = short.split(', ').pop() || 'GMT';
        return `(${offsetPart}) ${tz}`;
      }catch{ return `(GMT) ${tz}`; }
    }
    tzSelect?.addEventListener('change', ()=>{
      G.timeZone = tzSelect.value || 'UTC';
      if(G.timerType!=='simple'){ rolloverWeekIfNeeded(); renderHUD(); }
      save();
    });

    function allModeIds(){ return ['exercise','cycling','digitalDetox','bedTime','quran','dikhr','maths','subject1','subject2','subject3','user1','user2','user3']; }
    function modeLabel(id){
      const custom = CUSTOM_NAMES[id];
      if(custom && String(custom).trim().length>0) return custom;
      return DEFAULT_MODE_NAMES[id] || id;
    }
    function populateModesUI(){
      const ids = allModeIds();
      if(modeSelect){
        const curVal = modeSelect.value;
        modeSelect.innerHTML='';
        const frag=document.createDocumentFragment();
        for(const id of ids){
          const opt=document.createElement('option');
          opt.value=id; opt.textContent=modeLabel(id);
          frag.appendChild(opt);
        }
        modeSelect.appendChild(frag);
        modeSelect.value = ids.includes(currentMode)? currentMode : ids[0];
        if(curVal && ids.includes(curVal)) modeSelect.value = curVal;
      }
      subject1Input.value = CUSTOM_NAMES['subject1'] || '';
      subject2Input.value = CUSTOM_NAMES['subject2'] || '';
      subject3Input.value = CUSTOM_NAMES['subject3'] || '';
      user1Input.value = CUSTOM_NAMES['user1'] || '';
      user2Input.value = CUSTOM_NAMES['user2'] || '';
      user3Input.value = CUSTOM_NAMES['user3'] || '';

      if(modeNameEl) modeNameEl.textContent = modeLabel(currentMode).replace(/ mode$/i,'');
    }

    modeSelect?.addEventListener('change', ()=>{
      switchMode(modeSelect.value);
    });

    function switchMode(toId){
      if(!toId || toId===currentMode) return;
      clearModeInterval(currentMode);
      startBtn._cleanupVisibility?.();
      if(G.timerType!=='simple') showRain(false);

      save();

      currentMode = toId;
      G.selectedMode = toId;
      S = loadState(currentMode);

      const secs = getCurrentSessionSeconds();
      if (S.secondsLeft <= 0 || S.secondsLeft > secs) S.secondsLeft = secs;

      const layer=document.querySelector('#treeSVG #leafLayer');
      if(layer) layer.innerHTML='';
      renderLeavesFromState();
      if(G.timerType!=='simple'){ rolloverWeekIfNeeded(); }
      renderHUD();
    }

    function applyTimerTypeUI(){
      timerTypeSelect.value = G.timerType;
      customInputsDiv.style.display = (G.timerType==='custom' || G.timerType==='simple') ? 'flex' : 'none';
      const secs = getCurrentSessionSeconds();
      if(S.secondsLeft <= 0 || S.secondsLeft > secs) S.secondsLeft = secs;

      setClockUIToCurrentType();

      // For custom: behave like pomodoro (tracking), but no slider and no percentage
      if(G.timerType==='custom'){
        progressBlock.style.display='none';
        percentLabel.style.display='none';
      }

      // For simple: large sections hidden already by setClockUIToCurrentType
      if(G.timerType==='simple'){
        progressBlock.style.display='none';
        percentLabel.style.display='none';
      }

      // Pomodoro: show slider
      if(G.timerType==='pomodoro'){
        progressBlock.style.display='';
      }

      save();
      renderHUD();
    }
    timerTypeSelect.addEventListener('change', ()=>{
      G.timerType = timerTypeSelect.value;
      // Enforce 25:00 in Pomodoro
      if(G.timerType==='pomodoro'){ S.secondsLeft = POMODORO_SECONDS; }
      applyTimerTypeUI();
    });
    customMinInput.value = String(Math.floor((G.customSeconds||900)/60));
    customSecInput.value = String((G.customSeconds||900)%60);
    applyCustomBtn.addEventListener('click', ()=>{
      const mins = Math.max(0, Math.floor(Number(customMinInput.value)||0));
      const secs = Math.max(0, Math.floor(Number(customSecInput.value)||0));
      const total = Math.min(23*3600+59*60+59, mins*60 + secs);
      G.customSeconds = Math.max(10, total||900);
      // If current type uses customSeconds, adjust display
      const maxSecs = getCurrentSessionSeconds();
      if (S.secondsLeft <= 0 || S.secondsLeft > maxSecs) S.secondsLeft = maxSecs;
      applyTimerTypeUI();
    });

    saveNamesBtn?.addEventListener('click', ()=>{
      CUSTOM_NAMES['subject1'] = subject1Input.value.trim();
      CUSTOM_NAMES['subject2'] = subject2Input.value.trim();
      CUSTOM_NAMES['subject3'] = subject3Input.value.trim();
      CUSTOM_NAMES['user1'] = user1Input.value.trim();
      CUSTOM_NAMES['user2'] = user2Input.value.trim();
      CUSTOM_NAMES['user3'] = user3Input.value.trim();
      saveNames();
      populateModesUI();
      if(G.timerType!=='simple') renderHUD();
    });

    // Init
    if(!G.timeZone) G.timeZone='UTC';
    if(!G.selectedMode) G.selectedMode='maths';
    currentMode = G.selectedMode;
    S = loadState(currentMode);

    populateTimeZonesIfNeeded();
    populateModesUI();
    applyTimerTypeUI();

    renderLeavesFromState();
    applyProgress();
    renderHUD();
  </script>
</body>
</html>
