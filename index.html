<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pomodoro Tree â€” Real-Time Timer, Per-Mode/Timer Isolation</title>
  <style>
    :root{
      --bg:#eaf3ff; --surface:#ffffff; --surface-2:#eef6ff; --line:#caddf8;
      --text:#0b1a33; --dim:#4a6894;
      --radius-lg:18px; --shadow:0 10px 28px rgba(30,70,140,.1);
      --btn-primary:#2563eb; --btn-primary-hover:#1e40af;
      --btn-success:#16a34a; --btn-danger:#ef4444; --btn-neutral:#334155;

      --slider-done:#ef4444;  /* red base */
      --slider-left:#e6efff;  /* pale base */
      --slider-green:#16a34a; /* green completion */

      --soil-top:#d1a470; --soil-bottom:#b37b3e;

      --z-tabs: 10;
      --z-dropdown: 1000;
      --z-labels: 2000;
      --z-tree: 3000;
      --z-saplings: 4000; /* saplings above tree */
      --z-rain: 9999;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width:1140px; margin:0 auto; padding:20px 16px 120px; }

    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{ display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px; background:linear-gradient(180deg,#f0f6ff,#ffffff); border:1px solid var(--line); }
    h1{ margin:0; font-size:22px; }
    .modeTag{ display:flex; align-items:center; gap:8px; font-weight:800; color:#14563a; font-size:20px; white-space:nowrap; }
    #modeName{ display:inline-block; max-width:52vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .topStack{ display:flex; flex-direction:column; gap:12px; margin-top:12px; }
    .centerRow{ display:flex; justify-content:center; width:100%; }
    .fixedCard{ width:760px; max-width:100%; position:relative; z-index:0; }

    .timerTypeBar{ display:flex; flex-direction:column; gap:10px; background:#fff; border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow:var(--shadow); }
    .vstack{ display:flex; flex-direction:column; gap:10px; }
    .miniNote{ color:#4a6894; font-weight:700; }

    .timerCard{ display:flex; align-items:center; background:#fff; border:1px solid var(--line); border-radius:18px; padding:16px; box-shadow:var(--shadow); flex-direction:column; }
    .time{ font-size:112px; font-weight:800; color:#0e2a70; text-align:center; }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:10px; }
    button{
      border:none; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer; color:#fff; background:var(--btn-neutral);
      box-shadow:0 1px 0 rgba(0,0,0,.06), 0 6px 14px rgba(15,23,42,.14);
    }
    #startBtn{ background:var(--btn-success); }
    #resetBtn{ background:var(--btn-danger); }
    #applyCustomBtn, #applySimpleBtn, #lptSetBtn, #saveNamesBtn{ background:var(--btn-primary); }
    #applyCustomBtn:hover, #applySimpleBtn:hover, #lptSetBtn:hover, #saveNamesBtn:hover{ background:var(--btn-primary-hover); }

    .settings{ display:flex; flex-direction:column; gap:12px; margin-top:10px; color:var(--dim); width:100%; }
    .numWrap{ display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
    .numWrap input, .vstack select{ padding:8px 10px; border-radius:12px; border:1px solid var(--line); font-weight:800; width:100%; }

    .pctRow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:6px; }
    #pctRange{
      -webkit-appearance:none; appearance:none;
      width:100%; max-width:360px; height:12px; border-radius:999px; outline:none;
      background:var(--slider-left); border:1px solid var(--line);
      pointer-events:none;
    }
    #pctRange::-webkit-slider-runnable-track{ height:12px; background:transparent; border-radius:999px; }
    #pctRange::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:0; height:0; border:none; background:transparent; }
    #pctRange::-moz-range-thumb{ width:0; height:0; border:none; background:transparent; }
    #pctRange::-ms-thumb{ width:0; height:0; border:none; background:transparent; }
    #pctRange::-moz-range-track{ height:12px; background:var(--slider-left); border-radius:999px; }
    #pctValue{ min-width:44px; text-align:right; }

    .treePanel{ display:flex; align-items:center; background:#fff; border:1px solid var(--line); border-radius:18px; padding:14px; flex-direction:column; box-shadow:var(--shadow); }
    .treePanel.fixedCard{ width:760px; }

    .treeBox{ position:relative; width:560px; max-width:100%; height:560px; margin:6px auto; border:1px solid var(--line); border-radius:18px; overflow:hidden; }
    .sky{ position:absolute; inset:0; background:linear-gradient(180deg,#cfe8ff 0%, #8ec5ff 62%, var(--soil-top) 62%, var(--soil-bottom) 100%); z-index:0; }

    .skyOverlay{ position:absolute; left:14px; top:10px; font:800 18px/1.2 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#0b1a33; text-shadow:0 2px 0 rgba(255,255,255,.65); z-index:var(--z-labels); background:rgba(255,255,255,.55); padding:4px 8px; border-radius:10px; border:1px solid rgba(200,216,238,.8); }
    .todaySky{ position:absolute; left:14px; top:38px; font:800 18px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#14563a; text-shadow:0 2px 0 rgba(255,255,255,.65); z-index:var(--z-labels); background:rgba(255,255,255,.55); padding:4px 8px; border-radius:10px; border:1px solid rgba(200,216,238,.8); }

    /* Saplings on top */
    .saplingsLayer{ position:absolute; inset:0; pointer-events:none; z-index:var(--z-saplings); }

    #treeSVG{ position:absolute; left:50%; transform:translateX(-50%) scale(1.2); transform-origin:center bottom; bottom:12px; overflow:visible; width:680px; height:620px; z-index:var(--z-tree); }

    .rainTop{ position:absolute; inset:0; pointer-events:none; z-index:var(--z-rain); display:none; }
    .rainTop .drop{ position:absolute; top:-28px; width:1.2px; height:28px; background:rgba(14,42,112,.55); border-radius:2px; animation:rainFall 0.8s linear infinite; }
    .rainTop .drop.far{ opacity:.6; transform:scale(.9); animation-duration:1.1s; }
    @keyframes rainFall{ to{ transform:translateY(760px); } }

    @keyframes leafBlinkHue {
      0%{ fill:#22c55e; }
      50%{ fill:#15803d; }
      100%{ fill:#22c55e; }
    }
    .leaf-live path.leafFill{ animation: leafBlinkHue 900ms linear infinite; }
    @keyframes leafPop { 0%{ transform:scale(0); opacity:0; } 80%{ transform:scale(1.08); opacity:1; } 100%{ transform:scale(1); opacity:1; } }
    .leaf-pop{ animation: leafPop 380ms ease-out forwards; transform-origin:center; transform-box:fill-box; }

    .tabsWrap{ margin:12px auto; background:#fff; border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:14px; width:760px; max-width:100%; position:relative; z-index:var(--z-tabs); }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; padding:8px; border:1px solid var(--line); border-radius:999px; background:var(--surface-2); justify-content:center; }
    .tab{ display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; cursor:pointer; color:#4a6894; user-select:none; }
    .tab.active{ color:#0b1a33; background:linear-gradient(180deg,#e6f1ff,#ffffff); }
    .panelCard{ display:none; margin-top:12px; background:#fff; border:1px solid var(--line); border-radius:18px; padding:14px; gap:10px; flex-direction:column; position:relative; z-index:var(--z-tabs); }
    .modesBar{ display:flex; flex-direction:column; gap:10px; padding:12px; border-radius:14px; background:#fff; border:1px solid var(--line); box-shadow:var(--shadow); }

    .tzBar{ display:flex; flex-direction:column; gap:10px; padding:12px; border-radius:14px; background:#fff; border:1px solid var(--line); box-shadow:var(--shadow); margin-top:12px; width:560px; max-width:100%; position:relative; z-index:var(--z-dropdown); }
    .tzLeft{ display:flex; flex-direction:column; gap:8px; width:100%; }
    .searchWrap{ position:relative; }
    .searchWrap input{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); font-weight:700; }
    .dropdown{ position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #caddf8; border-radius:12px; max-height:260px; overflow:auto; box-shadow:0 10px 28px rgba(30,70,140,.15); z-index:999; display:none; }
    .drop-item{ padding:10px 12px; cursor:pointer; }
    .drop-item:hover{ background:#eef6ff; }
    .tzNote{ margin-top:6px; color:#0b1a33; font-weight:700; }

    .gridWrap{ margin:14px auto; background:#fff; border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:14px; width:760px; max-width:100%; display:flex; flex-direction:column; align-items:center; }
    .gridHead{ display:flex; align-items:center; justify-content:space-between; gap:8px; color:#4a6894; width:100%; }
    .grid{ display:grid; gap:6px; grid-template-columns:repeat(13, 1fr); width:100%; }
    .cell{ aspect-ratio:1/1; border-radius:10px; background:#f3f8ff; border:1px dashed #c8d8ee; color:#4e6ea0; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:12px; position:relative; }
    .cell.live{ background:linear-gradient(180deg,#e9fff1,#ffffff); border:2px solid #16a34a; color:#14563a; }
    .icon{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:16px; pointer-events:none; }

    .hidden{ display:none !important; }

    @media (max-width: 640px){
      .wrap{ padding-bottom:80px; }
      .treePanel.fixedCard{ width:100%; max-width:92vw; }
      .treeBox{ width:92vw; aspect-ratio:1/1; height:auto; margin:8px auto; position:relative; }
      #treeSVG, #saplingsSVG{ width:100%; height:100%; }
      .todaySky{ font-size:16px; top:36px; }
      h1{ font-size:18px; }
      .modeTag{ font-size:16px; }
      .grid{ grid-template-columns:repeat(8, 1fr); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><span style="font-weight:800;">ðŸŒ³</span><h1>Pomodoro Tree</h1></div>
      <div class="modeTag"><span>Mode:</span><span id="modeName">Study</span></div>
    </header>

    <div class="topStack">
      <div class="centerRow">
        <section class="timerTypeBar fixedCard vstack" aria-label="Timer type and minutes">
          <span class="miniNote">Change timer here</span>
          <select id="timerTypeSelect">
            <option value="pomodoro">Pomodoro timer (25 min)</option>
            <option value="custom">Custom timer</option>
            <option value="simplex">Simplex timer</option>
          </select>

          <div id="customInputs" class="vstack" style="display:none;">
            <span class="miniNote" id="customLabel">Editable only once per week</span>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <input id="customMin" type="number" min="1" max="999" step="1" value="25" />
              <button id="applyCustomBtn" title="Apply custom minutes">Set</button>
              <span id="customLockMsg" class="miniNote">Will be locked</span>
            </div>
          </div>

          <div id="simpleInputs" class="vstack hidden">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <input id="simpleMin" type="number" min="1" max="999" step="1" value="25" />
              <button id="applySimpleBtn" title="Apply simplex minutes">Set</button>
            </div>
          </div>
        </section>
      </div>

      <div class="centerRow">
        <section class="timerCard fixedCard" aria-label="Main timer">
          <div class="time" id="clock">25:00</div>
          <div class="controls">
            <button id="startBtn">Start 25:00</button>
            <button id="resetBtn">Reset</button>
          </div>

          <div class="settings vstack" id="settingsBlock">
            <div class="numWrap" id="lptWrap">
              <label for="lptInput" class="miniNote">Leaves per week (LPT)</label>
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="lptInput" type="number" min="1" max="200" step="1" value="9" />
                <button id="lptSetBtn">Set</button>
                <span id="lptLockNote" class="miniNote">Editable once per week</span>
              </div>
              <div class="pctRow">
                <input id="pctRange" type="range" min="0" max="100" step="1" value="0" />
                <span id="pctValue" class="miniNote">0%</span>
              </div>
              <span id="lptHelper" class="miniNote">LPT = No. of timer sessions per week</span>
              <div id="weeklyTarget" class="miniNote">Weekly target = 3 hrs 45 mins</div>
            </div>
          </div>
        </section>
      </div>

      <div class="centerRow">
        <section class="treePanel fixedCard" aria-label="Tree canvas">
          <h3 style="margin:0 0 8px 0; text-align:center;">Current Tree</h3>
          <div class="treeBox" id="treeBox">
            <div class="sky"></div>

            <div id="xySky" class="skyOverlay" style="display:none;">0 / 0 leaves</div>
            <div id="todaySky" class="todaySky">Total duration (today): 0 mins</div>

            <!-- Saplings on top layer -->
            <svg id="saplingsSVG" width="560" height="560" viewBox="0 0 560 560" class="saplingsLayer" aria-hidden="true">
              <g id="saplings" stroke="#2f6f3a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <defs>
                  <g id="sapling">
                    <path d="M0 0 C 0 -7, 5 -14, 9 -20" />
                    <path d="M9 -20 c 7 2, 10 5, 12 10 c -7 -2, -10 -5, -12 -10 z" fill="#2e7d32" stroke="#1b5e20"/>
                    <path d="M0 0 C 0 -6, -5 -12, -9 -18" />
                    <path d="M-9 -18 c -7 2, -10 5, -12 10 c 7 -2, 10 -5, 12 -10 z" fill="#2e7d32" stroke="#1b5e20"/>
                  </g>
                </defs>
                <!-- 72 saplings -->
                <g transform="translate(60 380)"><use href="#sapling"/></g><g transform="translate(120 380)"><use href="#sapling"/></g><g transform="translate(180 380)"><use href="#sapling"/></g><g transform="translate(240 380)"><use href="#sapling"/></g><g transform="translate(300 380)"><use href="#sapling"/></g><g transform="translate(360 380)"><use href="#sapling"/></g><g transform="translate(420 380)"><use href="#sapling"/></g><g transform="translate(480 380)"><use href="#sapling"/></g>
                <g transform="translate(60 400)"><use href="#sapling"/></g><g transform="translate(120 400)"><use href="#sapling"/></g><g transform="translate(180 400)"><use href="#sapling"/></g><g transform="translate(240 400)"><use href="#sapling"/></g><g transform="translate(300 400)"><use href="#sapling"/></g><g transform="translate(360 400)"><use href="#sapling"/></g><g transform="translate(420 400)"><use href="#sapling"/></g><g transform="translate(480 400)"><use href="#sapling"/></g>
                <g transform="translate(60 420)"><use href="#sapling"/></g><g transform="translate(120 420)"><use href="#sapling"/></g><g transform="translate(180 420)"><use href="#sapling"/></g><g transform="translate(240 420)"><use href="#sapling"/></g><g transform="translate(300 420)"><use href="#sapling"/></g><g transform="translate(360 420)"><use href="#sapling"/></g><g transform="translate(420 420)"><use href="#sapling"/></g><g transform="translate(480 420)"><use href="#sapling"/></g>
                <g transform="translate(60 440)"><use href="#sapling"/></g><g transform="translate(120 440)"><use href="#sapling"/></g><g transform="translate(180 440)"><use href="#sapling"/></g><g transform="translate(240 440)"><use href="#sapling"/></g><g transform="translate(300 440)"><use href="#sapling"/></g><g transform="translate(360 440)"><use href="#sapling"/></g><g transform="translate(420 440)"><use href="#sapling"/></g><g transform="translate(480 440)"><use href="#sapling"/></g>
                <g transform="translate(60 460)"><use href="#sapling"/></g><g transform="translate(120 460)"><use href="#sapling"/></g><g transform="translate(180 460)"><use href="#sapling"/></g><g transform="translate(240 460)"><use href="#sapling"/></g><g transform="translate(300 460)"><use href="#sapling"/></g><g transform="translate(360 460)"><use href="#sapling"/></g><g transform="translate(420 460)"><use href="#sapling"/></g><g transform="translate(480 460)"><use href="#sapling"/></g>
                <g transform="translate(60 480)"><use href="#sapling"/></g><g transform="translate(120 480)"><use href="#sapling"/></g><g transform="translate(180 480)"><use href="#sapling"/></g><g transform="translate(240 480)"><use href="#sapling"/></g><g transform="translate(300 480)"><use href="#sapling"/></g><g transform="translate(360 480)"><use href="#sapling"/></g><g transform="translate(420 480)"><use href="#sapling"/></g><g transform="translate(480 480)"><use href="#sapling"/></g>
                <g transform="translate(60 500)"><use href="#sapling"/></g><g transform="translate(120 500)"><use href="#sapling"/></g><g transform="translate(180 500)"><use href="#sapling"/></g><g transform="translate(240 500)"><use href="#sapling"/></g><g transform="translate(300 500)"><use href="#sapling"/></g><g transform="translate(360 500)"><use href="#sapling"/></g><g transform="translate(420 500)"><use href="#sapling"/></g><g transform="translate(480 500)"><use href="#sapling"/></g>
                <g transform="translate(60 520)"><use href="#sapling"/></g><g transform="translate(120 520)"><use href="#sapling"/></g><g transform="translate(180 520)"><use href="#sapling"/></g><g transform="translate(240 520)"><use href="#sapling"/></g><g transform="translate(300 520)"><use href="#sapling"/></g><g transform="translate(360 520)"><use href="#sapling"/></g><g transform="translate(420 520)"><use href="#sapling"/></g><g transform="translate(480 520)"><use href="#sapling"/></g>
                <g transform="translate(60 540)"><use href="#sapling"/></g><g transform="translate(120 540)"><use href="#sapling"/></g><g transform="translate(180 540)"><use href="#sapling"/></g><g transform="translate(240 540)"><use href="#sapling"/></g><g transform="translate(300 540)"><use href="#sapling"/></g><g transform="translate(360 540)"><use href="#sapling"/></g><g transform="translate(420 540)"><use href="#sapling"/></g><g transform="translate(480 540)"><use href="#sapling"/></g>
              </g>
            </svg>

            <svg id="treeSVG" width="680" height="620" viewBox="0 0 560 410" preserveAspectRatio="xMidYMid meet">
              <defs>
                <filter id="leafShadow" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="1" stdDeviation="1.0" flood-color="#000" flood-opacity="0.15" /></filter>
                <mask id="fillMask" maskUnits="userSpaceOnUse" x="100" y="150" width="380" height="220">
                  <rect fill="#000" x="100" y="150" width="380" height="220"/>
                  <rect id="fillRect" x="110" y="316" width="360" height="0" fill="#fff"/>
                </mask>
                <linearGradient id="canopyBaseDarker" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" stop-color="#a3e3b5" />
                  <stop offset="100%" stop-color="#7fce9d" />
                </linearGradient>
              </defs>

              <g id="canopyGroup" transform="translate(280 280) scale(1,1.2) translate(-280 -280)">
                <path id="canopyWhite" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="url(#canopyBaseDarker)"/>
                <path id="canopyFillGreen" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="#3aa85f" mask="url(#fillMask)"/>
                <path id="canopyOutline" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="transparent" stroke="#065f46" stroke-width="3" />
                <path d="M 280 380 C 280 350, 280 320, 280 284" fill="none" stroke="#4e342e" stroke-width="32" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M 280 284 C 270 270, 258 255, 248 238" fill="none" stroke="#4e342e" stroke-width="24" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M 280 284 C 290 270, 302 255, 312 238" fill="none" stroke="#4e342e" stroke-width="24" stroke-linecap="round" stroke-linejoin="round" />
                <g id="leafLayer" filter="url(#leafShadow)"></g>
              </g>
            </svg>

            <div id="rainTop" class="rainTop" aria-hidden="true"></div>
          </div>
        </section>
      </div>
    </div>

    <div class="centerRow">
      <div class="tzBar" id="tzBar" aria-label="Time zone chooser">
        <div class="tzLeft">
          <label for="countrySearch" class="miniNote">Time zone</label>
          <div class="searchWrap">
            <input id="countrySearch" type="text" placeholder="Type country name..." autocomplete="off" value="Japan" />
            <div id="countryList" class="dropdown"></div>
          </div>
          <div class="tzNote">Default time zone is Japan, select your country to match your time zone.</div>
        </div>
      </div>
    </div>

    <section class="tabsWrap" id="tabsWrap" aria-label="Settings tabs">
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="modesPanel" role="button" tabindex="0">Modes</div>
        <div class="tab" data-tab="subPanel" role="button" tabindex="0">Subscription</div>
        <div class="tab" data-tab="syncPanel" role="button" tabindex="0">Sync</div>
      </div>

      <div id="modesPanel" class="panelCard" style="display:flex;">
        <div class="modesBar">
          <label for="modeSelect" class="miniNote" id="modeLabel">Select mode here</label>
          <div class="modeEditRow">
            <select id="modeSelect" title="Switch mode" aria-labelledby="modeLabel"></select>
          </div>
          <div class="modeEditRow" id="editableNamesRow">
            <div class="editGroup"><span>Subject 1</span><input id="subject1Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>Subject 2</span><input id="subject2Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>Subject 3</span><input id="subject3Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>User 1</span><input id="user1Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>User 2</span><input id="user2Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>User 3</span><input id="user3Input" placeholder="Edit name" /></div>
            <button id="saveNamesBtn">Save names</button>
          </div>
        </div>
      </div>

      <div id="subPanel" class="panelCard">
        <div id="subStatus">Plan: Free â€” 4 weeks cap. Unlock remaining 48 weeks for $1/year.</div>
        <button id="subBtn">Unlock 48 weeks â€” $1</button>
      </div>

      <div id="syncPanel" class="panelCard">
        <div id="authState">Signed out</div>
        <input type="email" id="emailInput" placeholder="email@example.com" />
        <button id="sendLinkBtn">Send sign-in link</button>
        <button id="signOutBtn">Sign out</button>
      </div>
    </section>

    <section class="gridWrap" id="gridWrap">
      <div class="gridHead">
        <div class="chip">Completed Trees</div>
        <div class="chip" id="gridCount">0 / 52</div>
      </div>
      <div class="grid" id="treeGrid"></div>
    </section>

    <section class="bottomAuth" id="bottomAuth">
      <div class="authRow">
        <input type="email" id="emailInputBottom" placeholder="email@example.com" />
      </div>
      <div class="authRow">
        <button id="sendLinkBtnBottom">Sign in</button>
        <button id="signOutBtnBottom">Sign out</button>
      </div>
    </section>
  </div>

  <script>
    const APP_KEY='pomodoroTree_v15_realtime_timer_redSlider_canopySafeSaplingsTop';
    const GLOBAL_KEY=APP_KEY+'_global', NAMES_KEY=APP_KEY+'_names';
    const svgns='http://www.w3.org/2000/svg';
    const TIMER_TYPES={ pomodoro:'pomodoro', custom:'custom', simplex:'simplex' };
    const POMODORO_SECONDS=25*60;

    // Per-mode+timer storage isolation
    const load=(k,d)=>{ try{ return Object.assign({}, d||{}, JSON.parse(localStorage.getItem(k)||'{}')); }catch{ return Object.assign({}, d||{}); } }; /* [web:100][web:97] */
    const save=(k,v)=> localStorage.setItem(k, JSON.stringify(v)); /* [web:110] */

    // Global
    const G = load(GLOBAL_KEY, { timerType:TIMER_TYPES.pomodoro, selectedMode:'maths' });

    // Timer state
    const DEFAULT_TIMER_STATE = {
      leavesPerTree:9, placed:0, secondsLeft:POMODORO_SECONDS,
      weeklyTargetLocked:false, weeklyTargetSetValue:9, lockWeek:undefined, lockYear:undefined,
      customLocked:false, customLockWeek:undefined, customLockYear:undefined,
      grid:[], weeklyLeaves:0, totalFocusSeconds:0, weeklyFocusSeconds:0,
      _week:undefined, _year:undefined,
      canopyPoints:[], canopySeedWeek:undefined, canopySeedYear:undefined,
      customSeconds:25*60, simpleSeconds:25*60,
      todayDateKey: null, todayLeafCount: 0, todayExtraSeconds: 0,
      // real-time refs
      lastRealTS: null, // ms
      targetEndTS: null // ms absolute
    };

    const modeTimerKey=(modeId, timerType)=> `${APP_KEY}_mode_${modeId}_timer_${timerType}`;
    function loadState(mode,timer){ return load(modeTimerKey(mode,timer), DEFAULT_TIMER_STATE); }
    function saveState(mode,timer,S){ save(modeTimerKey(mode,timer), S); }

    let currentMode = G.selectedMode || 'maths';
    let currentTimerType = G.timerType || TIMER_TYPES.pomodoro;
    let S = loadState(currentMode, currentTimerType);

    const el=id=>document.getElementById(id);
    const timerTypeSelect=el('timerTypeSelect');
    const customInputs=el('customInputs'), customMin=el('customMin'), applyCustomBtn=el('applyCustomBtn'), customLockMsg=el('customLockMsg');
    const simpleInputs=el('simpleInputs'), simpleMin=el('simpleMin'), applySimpleBtn=el('applySimpleBtn');
    const clockEl=el('clock'), startBtn=el('startBtn'), resetBtn=el('resetBtn');
    const lptWrap=el('lptWrap'), lptInput=el('lptInput'), lptSetBtn=el('lptSetBtn'), weeklyTargetEl=el('weeklyTarget');
    const pctRange=el('pctRange'), pctValue=el('pctValue');
    const todaySky=el('todaySky'), xySky=el('xySky');
    const leafLayer=document.querySelector('#treeSVG #leafLayer'), canopyGroup=document.getElementById('canopyGroup');
    const rainTop=el('rainTop');
    const modeSelect=el('modeSelect'), modeNameHeader=el('modeName');
    const subject1Input=el('subject1Input'), subject2Input=el('subject2Input'), subject3Input=el('subject3Input');
    const user1Input=el('user1Input'), user2Input=el('user2Input'), user3Input=el('user3Input');
    const saveNamesBtn=el('saveNamesBtn');
    const treeGrid=el('treeGrid'), gridCount=el('gridCount');
    const countrySearch=el('countrySearch'), countryList=el('countryList');

    let CUSTOM_NAMES=load(NAMES_KEY,{});
    const DEFAULT_MODE_NAMES={
      exercise:'Exercise mode', cycling:'Cycling mode', digitalDetox:'Digital detox mode', bedTime:'Bed-time mode',
      quran:'Quran mode', dikhr:'Dikhr mode', maths:'Maths mode',
      subject1:'Subject 1 mode', subject2:'Subject 2 mode', subject3:'Subject 3 mode',
      user1:'User 1 mode', user2:'User 2 mode', user3:'User 3 mode'
    };
    const MODE_IDS=['exercise','cycling','digitalDetox','bedTime','quran','dikhr','maths','subject1','subject2','subject3','user1','user2','user3'];
    const nameFor=(id)=> (CUSTOM_NAMES[id]??'').trim() || (DEFAULT_MODE_NAMES[id]||id);

    function populateModeSelect(){
      modeSelect.innerHTML='';
      const f=document.createDocumentFragment();
      for(const id of MODE_IDS){
        const o=document.createElement('option'); o.value=id; o.textContent=nameFor(id); f.appendChild(o);
      }
      modeSelect.appendChild(f);
      modeSelect.value=currentMode;
      refreshModeHeader(); /* immediate reflect */
    }
    function refreshModeHeader(){
      const opt=modeSelect.options[modeSelect.selectedIndex];
      const label=opt? opt.text : nameFor(currentMode);
      modeNameHeader.textContent=label.replace(/ mode$/i,''); /* reflect now */ /* [web:133][web:139] */
    }

    // Countries (UI only)
    const COUNTRY_TZ=[{name:'Japan',tz:'Asia/Tokyo'},{name:'India',tz:'Asia/Kolkata'},{name:'United Kingdom',tz:'Europe/London'},{name:'United States',tz:'America/New_York'},{name:'Canada',tz:'America/Toronto'},{name:'Australia',tz:'Australia/Sydney'},{name:'UAE',tz:'Asia/Dubai'},{name:'Bangladesh',tz:'Asia/Dhaka'},{name:'China',tz:'Asia/Shanghai'},{name:'Germany',tz:'Europe/Berlin'},{name:'France',tz:'Europe/Paris'},{name:'Brazil',tz:'America/Sao_Paulo'}].sort((a,b)=> a.name.localeCompare(b.name));
    const countryList=el('countryList');
    function renderCountryList(filter=''){
      const q=filter.trim().toLowerCase(); const items=COUNTRY_TZ.filter(c=> c.name.toLowerCase().includes(q));
      if(items.length===0){ countryList.style.display='none'; countryList.innerHTML=''; return; }
      countryList.innerHTML=items.map(c=>`<div class="drop-item" data-tz="${c.tz}" data-name="${c.name}">${c.name}</div>`).join('');
      countryList.style.display='block';
    }
    countrySearch.addEventListener('input', ()=> renderCountryList(countrySearch.value) );
    countrySearch.addEventListener('focus', ()=> renderCountryList(countrySearch.value) );
    document.addEventListener('click', (e)=>{ if(!countryList.contains(e.target) && e.target!==countrySearch) countryList.style.display='none'; });
    countryList.addEventListener('click', (e)=>{ const it=e.target.closest('.drop-item'); if(!it) return; countrySearch.value=it.getAttribute('data-name'); countryList.style.display='none'; });

    // Sunday week
    function sundayWeekOf(date){
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const yearStart = new Date(d.getFullYear(), 0, 1);
      const startWeekday = yearStart.getDay(); // 0=Sun
      const offset = (7 - startWeekday) % 7;
      const dayOfYear = Math.floor((d - yearStart)/86400000);
      const week = (dayOfYear < offset) ? 1 : Math.floor((dayOfYear - offset)/7) + 1;
      return { week, year: d.getFullYear() };
    }

    function rolloverWeekIfNeeded(){
      const {week,year}=sundayWeekOf(new Date());
      if(S._week===undefined || S._year===undefined){ S._week=week; S._year=year; saveState(currentMode,currentTimerType,S); return; }
      if(S._week!==week || S._year!==year){
        const completed = S.placed>=S.leavesPerTree && S.leavesPerTree>0;
        S.grid.unshift({week:S._week,year:S._year,live:completed,ts:Date.now()});
        if(S.grid.length>52) S.grid.pop();

        S._week=week; S._year=year;
        S.weeklyLeaves=0; S.weeklyFocusSeconds=0;
        S.placed=0; leafLayer.innerHTML='';

        S.weeklyTargetLocked=false; S.lockWeek=undefined; S.lockYear=undefined;
        S.customLocked=false; S.customLockWeek=undefined; S.customLockYear=undefined;

        S.todayDateKey = null; S.todayLeafCount = 0; S.todayExtraSeconds = 0;

        saveState(currentMode,currentTimerType,S);
        renderGrid();
      }
    }

    function renderGrid(){
      treeGrid.innerHTML='';
      for(let i=0;i<52;i++){
        const cell=document.createElement('div'); cell.className='cell';
        const num=document.createElement('div'); num.className='num'; num.textContent=String(i+1);
        const icon=document.createElement('div'); icon.className='icon';
        const entry=S.grid[i];
        if(entry){ icon.textContent= entry.live?'ðŸŒ³':''; if(entry.live) cell.classList.add('live'); }
        cell.appendChild(num); cell.appendChild(icon); treeGrid.appendChild(cell);
      }
      gridCount.textContent=`${Math.min(S.grid.length,52)} / 52`;
    }

    // Pleasant alarm
    let audioCtx=null;
    function ensureAudio(){
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); /* [web:21] */
      if(audioCtx.state==='suspended'){ audioCtx.resume().catch(()=>{}); }
    }
    function playAlarm10s(){
      ensureAudio();
      const now = audioCtx.currentTime;
      const osc1 = audioCtx.createOscillator(); osc1.type='triangle'; osc1.frequency.setValueAtTime(660, now);
      const osc2 = audioCtx.createOscillator(); osc2.type='sawtooth'; osc2.frequency.setValueAtTime(990, now);
      const lfo = audioCtx.createOscillator(); lfo.type='sine'; lfo.frequency.setValueAtTime(5, now);
      const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 6;
      lfo.connect(lfoGain); lfoGain.connect(osc1.frequency);
      const biquad = audioCtx.createBiquadFilter(); biquad.type='lowpass'; biquad.frequency.setValueAtTime(2400, now);
      const gain = audioCtx.createGain(); gain.gain.setValueAtTime(0.0001, now);
      const attack=0.15, decay=0.25, sustain=0.18, release=0.6, dur=10;
      gain.gain.exponentialRampToValueAtTime(0.22, now+attack);
      gain.gain.exponentialRampToValueAtTime(sustain, now+attack+decay);
      gain.gain.setValueAtTime(sustain, now+dur-release);
      gain.gain.exponentialRampToValueAtTime(0.0001, now+dur);
      osc1.connect(biquad); osc2.connect(biquad);
      biquad.connect(gain); gain.connect(audioCtx.destination);
      lfo.start(now); osc1.start(now); osc2.start(now);
      osc1.stop(now+dur); osc2.stop(now+dur); lfo.stop(now+dur); /* [web:22] */
    }

    // Real-time timer: measure by absolute timestamps to survive throttling
    let ticker=null, isRunning=false;
    let currentLiveLeafIndex = null;

    function getSessionSeconds(){
      if(currentTimerType==='pomodoro') return 25*60;
      if(currentTimerType==='custom') return Math.max(60, Number(S.customSeconds)||1500);
      return Math.max(60, Number(S.simpleSeconds)||1500);
    }
    function format(s){ const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(Math.max(0,s%60)).padStart(2,'0'); return `${m}:${ss}`; }
    function setClockAndButtons(){
      clockEl.textContent = format(Math.max(0, Math.round(S.secondsLeft)));
      startBtn.textContent = isRunning ? 'Runningâ€¦' : `Start ${format(getSessionSeconds())}`;
    }

    function sessionMinutes(){ return Math.round(getSessionSeconds()/60); }
    function todayKey(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function ensureTodayCounters(){ const k=todayKey(); if(S.todayDateKey!==k){ S.todayDateKey=k; S.todayLeafCount=0; S.todayExtraSeconds=0; } }
    function renderTodayDuration(){
      ensureTodayCounters();
      const elapsedLive = isRunning && S.targetEndTS ? Math.max(0, Math.floor((Date.now() - (S.targetEndTS - getSessionSeconds()*1000))/1000)) : 0;
      const totalMins = S.todayLeafCount*sessionMinutes() + Math.floor((S.todayExtraSeconds + elapsedLive)/60);
      todaySky.textContent = `Total duration (today): ${totalMins} mins`; /* [web:139][web:133] */
    }

    // Weekly target line
    function renderWeeklyTarget(){
      const perLeafMin = Math.round(getSessionSeconds()/60);
      const totalMins = (Number(S.leavesPerTree)||0) * perLeafMin;
      const h = Math.floor(totalMins/60), m = totalMins%60;
      weeklyTargetEl.textContent = `Weekly target = ${h} hrs ${m} mins`;
    }

    // Red slider with green progress overlay (using background linear-gradient)
    function updateSliderFill(){
      const total = Math.max(1, Number(S.leavesPerTree)||1);
      const done = Math.min(S.weeklyLeaves||0, total);
      const pct = Math.round((done/total)*100);
      pctRange.value = String(pct);
      pctValue.textContent = `${pct}%`;
      pctRange.style.background = `linear-gradient(90deg, var(--slider-green) ${pct}%, var(--slider-done) ${pct}%)`; /* [web:59] */
    }

    // Canopy-safe anchors (no touch trunk/branches; avoid y>284 band)
    const CANOPY_BOX = { xMin:140, xMax:420, yMin:200, yMax:300, cx:280, cy:250 };
    const LEAF_R = 22;
    function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx, dy); }
    function insideCanopy(x,y){
      const cx=CANOPY_BOX.cx, cy=CANOPY_BOX.cy;
      const rx=160, ry=90;
      const nx=(x-cx)/rx, ny=(y-cy)/ry;
      return (nx*nx + ny*ny) <= 1.02;
    }
    function generateCanopyPoints(maxPoints){
      const pts = S.canopyPoints || [];
      if(pts.length>=maxPoints) return pts.slice(0,maxPoints);
      const base=pts.slice();
      const triesPerPoint=80;
      while(base.length<maxPoints){
        let placed=false, attempts=0;
        while(!placed && attempts<triesPerPoint){
          attempts++;
          const angle = Math.random()*Math.PI*2;
          const r = Math.sqrt(Math.random());
          const x = CANOPY_BOX.cx + r*Math.cos(angle)*160;
          const y = CANOPY_BOX.cy + r*Math.sin(angle)*90*0.95;
          if(!insideCanopy(x,y)) continue;
          if(y>284) continue; // no-go near branches/trunk
          let ok=true;
          for(const q of base){ if(dist({x,y}, q)<LEAF_R) { ok=false; break; } }
          if(ok){ base.push({x,y}); placed=true; }
        }
        if(!placed) break;
      }
      base.sort((a,b)=> dist(a, CANOPY_BOX) - dist(b, CANOPY_BOX)); // center-out growth
      S.canopyPoints = base;
      saveState(currentMode,currentTimerType,S);
      return base.slice(0,maxPoints);
    }
    function anchorForIndex(i){
      const pts = generateCanopyPoints(Math.max(S.leavesPerTree||9, i+1));
      return pts[i] || {x:CANOPY_BOX.cx, y:CANOPY_BOX.cy};
    }

    function makeLeafG(n, live=false){
      const wrap=document.createElementNS(svgns,'g');
      const g=document.createElementNS(svgns,'g'); g.setAttribute('class', live ? 'leaf leaf-live' : 'leaf');
      const p=document.createElementNS(svgns,'path');
      p.setAttribute('d','M 0 -16 C 10 -10, 12 0, 0 14 C -12 0, -10 -10, 0 -16 Z');
      p.setAttribute('class','leafFill');
      p.setAttribute('fill', live ? '#22c55e' : '#166534');
      p.setAttribute('stroke','#0b3d22'); p.setAttribute('stroke-width','1.2');
      const t=document.createElementNS(svgns,'text');
      t.setAttribute('x','0'); t.setAttribute('y','0'); t.setAttribute('fill','#fff'); t.setAttribute('font-weight','800'); t.setAttribute('font-size','13'); t.setAttribute('text-anchor','middle'); t.setAttribute('dominant-baseline','middle');
      t.textContent=String(n);
      g.appendChild(p); g.appendChild(t); wrap.appendChild(g); return wrap;
    }
    function placeLeaf(wrap,a){
      wrap.setAttribute('transform',`translate(${a.x} ${a.y}) scale(1.05)`);
      wrap.style.transformBox='fill-box'; wrap.style.transformOrigin='center';
    }

    function renderLeaves(){
      leafLayer.innerHTML='';
      for(let i=0;i<S.placed;i++){
        const w=makeLeafG(i+1,false);
        placeLeaf(w, anchorForIndex(i));
        leafLayer.appendChild(w);
      }
      if(isRunning){
        const idx = S.placed;
        const w=makeLeafG(idx+1,true);
        placeLeaf(w, anchorForIndex(idx));
        w.querySelector('.leaf')?.classList.add('leaf-pop');
        leafLayer.appendChild(w);
        currentLiveLeafIndex = idx;
      }else{
        currentLiveLeafIndex = null;
      }
      canopyGroup.appendChild(leafLayer);
    }

    function addStaticLeaf(){
      const idx = S.placed;
      const last = leafLayer.lastElementChild;
      if(last && last.querySelector('.leaf')?.classList.contains('leaf-live')){
        last.querySelector('.leaf')?.classList.remove('leaf-live');
        last.querySelector('.leafFill')?.style.removeProperty('animation');
      }else{
        const w=makeLeafG(idx+1,false);
        placeLeaf(w, anchorForIndex(idx));
        leafLayer.appendChild(w);
      }
      S.placed++;
      S.weeklyLeaves++;
      ensureTodayCounters();
      S.todayLeafCount = (S.todayLeafCount||0)+1;
      S.todayExtraSeconds = 0;
      currentLiveLeafIndex = null;
      saveState(currentMode,currentTimerType,S);
      updateSliderFill();
      renderTodayDuration();
    }
    function invalidateLiveLeaf(){
      const last = leafLayer.lastElementChild;
      if(last && last.querySelector('.leaf')?.classList.contains('leaf-live')){
        leafLayer.removeChild(last);
      }
      currentLiveLeafIndex = null;
    }

    function updateInSkyXY(){
      const show = (currentTimerType===TIMER_TYPES.pomodoro || currentTimerType===TIMER_TYPES.custom);
      xySky.style.display = show?'block':'none';
      if(show){
        const x = S.weeklyLeaves||0;
        const y = Math.max(1, Number(S.leavesPerTree)||1);
        xySky.textContent = `${x} / ${y} leaves`;
      }
    }

    function renderStats(){
      renderWeeklyTarget();
      updateInSkyXY();
      updateSliderFill();
      renderTodayDuration();
    }

    function getSessionDurationMs(){ return getSessionSeconds()*1000; }

    function startRealTimer(){
      // Set absolute target end timestamp so background throttling won't affect accuracy. [web:148][web:157]
      const now = Date.now();
      if(!S.targetEndTS){
        S.targetEndTS = now + Math.max(0, Math.round(S.secondsLeft))*1000;
      }
      S.lastRealTS = now;
      saveState(currentMode,currentTimerType,S);

      if(ticker) clearInterval(ticker);
      ticker = setInterval(()=>{
        const tnow = Date.now();
        if(S.targetEndTS){
          const remaining = Math.max(0, Math.round((S.targetEndTS - tnow)/1000));
          S.secondsLeft = remaining;
        }
        clockEl.textContent = format(S.secondsLeft);
        S.totalFocusSeconds++; S.weeklyFocusSeconds++;
        renderTodayDuration();
        if(S.secondsLeft<=0){
          stopTicker();
          onTimerEnd();
        }
        saveState(currentMode,currentTimerType,S);
      }, 500); // faster UI updates while remaining accurate by targetEndTS [web:144][web:151]
    }

    function stopTicker(){
      if(ticker){ clearInterval(ticker); ticker=null; }
      isRunning=false;
      rainTop.style.display='none';
      // accumulate any remainder into todayExtraSeconds
      if(S.targetEndTS){
        const elapsed = Math.max(0, Math.round((Date.now() - (S.targetEndTS - getSessionDurationMs()))/1000));
        if(elapsed>0){
          ensureTodayCounters();
          S.todayExtraSeconds += elapsed;
        }
      }
      S.targetEndTS = null;
      S.lastRealTS = null;
      setClockAndButtons();
      saveState(currentMode,currentTimerType,S);
      renderTodayDuration();
    }

    function onTimerEnd(){
      addStaticLeaf();
      if(currentMode!=='bedTime'){
        playAlarm10s();
      }
      S.secondsLeft = getSessionSeconds();
      S.targetEndTS = null;
      S.lastRealTS = null;
      saveState(currentMode,currentTimerType,S);
      renderLeaves();
      renderStats();
      setClockAndButtons();
    }

    function startTimer(){
      ensureAudio();
      isRunning=true;
      setClockAndButtons();
      rainTop.style.display='block';
      // compute targetEndTS using current secondsLeft
      S.targetEndTS = Date.now() + Math.max(0, Math.round(S.secondsLeft))*1000;
      S.lastRealTS = Date.now();
      saveState(currentMode,currentTimerType,S);
      renderLeaves();
      startRealTimer();
    }

    function resetTimer(){
      invalidateLiveLeaf();
      stopTicker();
      S.secondsLeft = getSessionSeconds();
      saveState(currentMode,currentTimerType,S);
      renderLeaves();
      renderStats();
      setClockAndButtons();
    }

    // Events
    startBtn.addEventListener('click', ()=>{
      if(isRunning) return;
      if(S.secondsLeft<=0 || S.secondsLeft>getSessionSeconds()){
        S.secondsLeft = getSessionSeconds();
      }
      if(rainTop.childElementCount===0) ensureRainDrops();
      startTimer();
    });
    resetBtn.addEventListener('click', resetTimer);

    // LPT
    lptSetBtn.addEventListener('click', ()=>{
      const v = Math.max(1, Math.min(200, Number(lptInput.value)||S.leavesPerTree));
      const {week,year}=sundayWeekOf(new Date());
      if(!S.weeklyTargetLocked){
        S.leavesPerTree = v;
        S.weeklyTargetSetValue = v;
        S.weeklyTargetLocked = true;
        S.lockWeek = week; S.lockYear = year;
        lptInput.value = String(v);
        saveState(currentMode,currentTimerType,S);
        renderStats();
      }else{
        if(S.lockWeek!==week || S.lockYear!==year){
          S.weeklyTargetLocked=false;
          S.lockWeek=undefined; S.lockYear=undefined;
          saveState(currentMode,currentTimerType,S);
        }else{
          lptInput.value = String(S.weeklyTargetSetValue||S.leavesPerTree||9);
        }
      }
      S.canopyPoints=[]; saveState(currentMode,currentTimerType,S);
      renderLeaves();
    });

    // Custom
    applyCustomBtn.addEventListener('click', ()=>{
      const mins = Math.max(1, Math.min(999, Number(customMin.value)||25));
      const secs = mins*60;
      const {week,year}=sundayWeekOf(new Date());
      if(!S.customLocked){
        currentTimerType = TIMER_TYPES.custom;
        S.customSeconds = secs;
        S.secondsLeft = secs;
        S.customLocked = true;
        S.customLockWeek = week; S.customLockYear = year;
        customMin.value = String(mins);
        saveState(currentMode,currentTimerType,S);
        timerTypeSelect.value = TIMER_TYPES.custom;
        updateModeVisibility();
        renderLeaves();
        renderStats();
        setClockAndButtons();
      }else{
        if(S.customLockWeek!==week || S.customLockYear!==year){
          S.customLocked=false;
          S.customLockWeek=undefined; S.customLockYear=undefined;
          saveState(currentMode,currentTimerType,S);
        }else{
          customMin.value = String(Math.round((S.customSeconds||1500)/60));
        }
      }
    });

    // Simplex
    applySimpleBtn.addEventListener('click', ()=>{
      const mins = Math.max(1, Math.min(999, Number(simpleMin.value)||25));
      const secs = mins*60;
      currentTimerType = TIMER_TYPES.simplex;
      S.simpleSeconds = secs;
      S.secondsLeft = secs;
      simpleMin.value = String(mins);
      saveState(currentMode,currentTimerType,S);
      timerTypeSelect.value = TIMER_TYPES.simplex;
      updateModeVisibility();
      renderLeaves();
      renderStats();
      setClockAndButtons();
    });

    function switchMode(newMode){
      saveState(currentMode,currentTimerType,S);
      currentMode = newMode;
      G.selectedMode = newMode;
      save(GLOBAL_KEY, G);
      S = loadState(currentMode, currentTimerType);
      rolloverWeekIfNeeded();
      refreshModeHeader(); /* reflect now */
      renderLeaves();
      renderGrid();
      updateModeVisibility();
      renderStats();
      setClockAndButtons();
      lptInput.value = String(S.weeklyTargetSetValue||S.leavesPerTree||9);
      customMin.value = String(Math.round((S.customSeconds||1500)/60));
      simpleMin.value = String(Math.round((S.simpleSeconds||1500)/60));
    }
    modeSelect.addEventListener('change', ()=> switchMode(modeSelect.value));

    function switchTimerType(newType){
      saveState(currentMode,currentTimerType,S);
      currentTimerType = newType;
      G.timerType = newType;
      save(GLOBAL_KEY, G);
      S = loadState(currentMode, currentTimerType);
      rolloverWeekIfNeeded();
      renderLeaves();
      renderGrid();
      updateModeVisibility();
      renderStats();
      setClockAndButtons();
      lptInput.value = String(S.weeklyTargetSetValue||S.leavesPerTree||9);
      customMin.value = String(Math.round((S.customSeconds||1500)/60));
      simpleMin.value = String(Math.round((S.simpleSeconds||1500)/60));
    }
    timerTypeSelect.addEventListener('change', ()=> switchTimerType(timerTypeSelect.value));

    function updateModeVisibility(){
      const t = timerTypeSelect.value || currentTimerType;
      if(t===TIMER_TYPES.simplex){
        lptWrap.style.display='none';
        customInputs.style.display='none';
        simpleInputs.classList.remove('hidden'); simpleInputs.style.display='flex';
      }else if(t===TIMER_TYPES.custom){
        lptWrap.style.display='flex';
        customInputs.style.display='flex';
        simpleInputs.style.display='none'; simpleInputs.classList.add('hidden');
      }else{
        lptWrap.style.display='flex';
        customInputs.style.display='none';
        simpleInputs.style.display='none'; simpleInputs.classList.add('hidden');
      }
      setClockAndButtons();
      updateSliderFill();
      renderWeeklyTarget();
      renderTodayDuration();
    }

    function ensureRainDrops(){
      if(rainTop.childElementCount>0) return;
      const mk=(n, cls='')=>{
        for(let i=0;i<n;i++){
          const d=document.createElement('div'); d.className=`drop ${cls}`;
          d.style.left=Math.round(Math.random()*100)+'%';
          d.style.animationDelay=(Math.random()*1.0).toFixed(2)+'s';
          const h = 20 + Math.random()*24;
          const w = 0.8 + Math.random()*0.9; /* narrow drizzle */
          d.style.height = h.toFixed(0)+'px';
          d.style.width = w.toFixed(1)+'px';
          d.style.animationDuration = (0.7 + Math.random()*0.7).toFixed(2)+'s';
          rainTop.appendChild(d);
        }
      };
      mk(180); mk(140,'far');
    }

    function init(){
      populateModeSelect();
      subject1Input.value=CUSTOM_NAMES.subject1||''; subject2Input.value=CUSTOM_NAMES.subject2||''; subject3Input.value=CUSTOM_NAMES.subject3||'';
      user1Input.value=CUSTOM_NAMES.user1||''; user2Input.value=CUSTOM_NAMES.user2||''; user3Input.value=CUSTOM_NAMES.user3||'';
      timerTypeSelect.value=currentTimerType;
      renderGrid();
      rolloverWeekIfNeeded();
      updateModeVisibility();
      renderLeaves();
      renderStats();
      setClockAndButtons();

      lptInput.value = String(S.weeklyTargetSetValue||S.leavesPerTree||9);
      customMin.value = String(Math.round((S.customSeconds||1500)/60));
      simpleMin.value = String(Math.round((S.simpleSeconds||1500)/60));

      ensureRainDrops();
    }

    // Handle background/visibility changes: recompute against absolute target to avoid drift. [web:148][web:157]
    document.addEventListener('visibilitychange', ()=>{
      if(isRunning){
        // On hide/show, recompute remaining by targetEndTS
        if(S.targetEndTS){
          S.secondsLeft = Math.max(0, Math.round((S.targetEndTS - Date.now())/1000));
          setClockAndButtons();
          renderTodayDuration();
          saveState(currentMode,currentTimerType,S);
        }
      }
    });

    window.addEventListener('focus', ()=>{
      if(isRunning && S.targetEndTS){
        S.secondsLeft = Math.max(0, Math.round((S.targetEndTS - Date.now())/1000));
        setClockAndButtons();
        renderTodayDuration();
      }
    });

    init();
  </script>
</body>
</html>
