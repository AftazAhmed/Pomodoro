<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pomodoro Tree â€” Run-time Rain + Leaf Blink</title>
  <style>
    :root{
      --bg:#eaf3ff; --surface:#ffffff; --surface-2:#eef6ff; --line:#caddf8;
      --text:#0b1a33; --dim:#4a6894;
      --radius-lg:18px; --shadow:0 10px 28px rgba(30,70,140,.1);
      --btn-primary:#2563eb; --btn-primary-hover:#1e40af;
      --btn-success:#16a34a; --btn-danger:#ef4444; --btn-neutral:#334155;

      --slider-done:#16a34a; --slider-left:#ef4444; --slider-track:#e6efff;

      --soil-top:#d1a470; --soil-bottom:#b37b3e;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width:1140px; margin:0 auto; padding:20px 16px 120px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{ display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px; background:linear-gradient(180deg,#f0f6ff,#ffffff); border:1px solid var(--line); }
    h1{ margin:0; font-size:22px; }
    .modeTag{ font-weight:800; color:#14563a; font-size:20px; white-space:nowrap; }
    #modeName{ display:inline-block; max-width:52vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .topStack{ display:flex; flex-direction:column; gap:12px; margin-top:12px; }
    .centerRow{ display:flex; justify-content:center; width:100%; }
    .fixedCard{ width:760px; max-width:100%; }

    .timerTypeBar{ display:flex; flex-direction:column; gap:10px; background:#fff; border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow:var(--shadow); }
    .vstack{ display:flex; flex-direction:column; gap:10px; }
    .vstack select, .vstack input[type=number]{ padding:8px 10px; border-radius:12px; border:1px solid var(--line); font-weight:800; width:100%; }
    .miniNote{ color:#4a6894; font-weight:700; }

    .timerCard{ display:flex; align-items:center; background:#fff; border:1px solid var(--line); border-radius:18px; padding:16px; box-shadow:var(--shadow); flex-direction:column; }
    .time{ font-size:112px; font-weight:800; color:#0e2a70; text-align:center; }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:10px; }
    button{
      border:none; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer; color:#fff; background:var(--btn-neutral);
      box-shadow:0 1px 0 rgba(0,0,0,.06), 0 6px 14px rgba(15,23,42,.14);
    }
    #startBtn{ background:var(--btn-success); }
    #resetBtn{ background:var(--btn-danger); }
    #applyCustomBtn, #lptSetBtn, #saveNamesBtn{ background:var(--btn-primary); }
    #applyCustomBtn:hover, #lptSetBtn:hover, #saveNamesBtn:hover{ background:var(--btn-primary-hover); }

    .settings{ display:flex; flex-direction:column; gap:12px; margin-top:10px; color:var(--dim); width:100%; }
    .numWrap{ display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
    .numWrap input{ width:160px; }

    /* Slider directly under Set button */
    .pctRow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:6px; }
    #pctRange{
      -webkit-appearance:none; appearance:none;
      width:100%; max-width:360px; height:12px; border-radius:999px; outline:none;
      background:var(--slider-track); border:1px solid var(--line);
    }
    #pctRange::-webkit-slider-runnable-track{ height:12px; background:transparent; border-radius:999px; }
    #pctRange::-webkit-slider-thumb{
      -webkit-appearance:none; width:18px; height:18px; border-radius:50%;
      background:#2563eb; border:2px solid #fff; margin-top:-3px; cursor:pointer; box-shadow:0 0 0 1px rgba(0,0,0,.1);
      position:relative; z-index:2;
    }
    #pctRange::-moz-range-track{ height:12px; background:var(--slider-track); border-radius:999px; }
    #pctRange::-moz-range-progress{ height:12px; background:var(--slider-done); border-radius:999px; }
    #pctValue{ min-width:44px; text-align:right; }

    .treePanel{ display:flex; align-items:center; background:#fff; border:1px solid var(--line); border-radius:18px; padding:14px; flex-direction:column; box-shadow:var(--shadow); }
    .treePanel.fixedCard{ width:760px; }
    .treeBox{ position:relative; width:560px; max-width:100%; height:560px; margin:6px auto; border:1px solid var(--line); border-radius:18px; overflow:hidden; }
    .sky{ position:absolute; inset:0; background:linear-gradient(180deg,#cfe8ff 0%, #8ec5ff 62%, var(--soil-top) 62%, var(--soil-bottom) 100%); z-index:0; }

    .saplingsLayer{ position:absolute; inset:0; pointer-events:none; z-index:1; }
    #treeSVG{ position:absolute; left:50%; transform:translateX(-50%) scale(1.2); transform-origin:center bottom; bottom:12px; overflow:visible; width:680px; height:620px; z-index:2; }

    .soilPct{ position:absolute; left:14px; bottom:10px; font:900 56px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#ffffff; text-shadow:0 2px 0 rgba(0,0,0,.2); z-index:3; }
    .xyLabel{ position:absolute; left:14px; top:12px; font:900 24px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#0b1a33; text-shadow:0 2px 0 rgba(255,255,255,.65); z-index:3; }
    /* Move 'Total duration' slightly down so rain sits above it visually */
    .todaySky{ position:absolute; left:14px; top:44px; font:800 18px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#14563a; text-shadow:0 2px 0 rgba(255,255,255,.65); z-index:3; background:rgba(255,255,255,.55); padding:4px 8px; border-radius:10px; border:1px solid rgba(200,216,238,.8); }

    /* Rain absolute top layer above everything (last in DOM + highest z-index) */
    .rainTop{ position:absolute; inset:0; pointer-events:none; z-index:9999; display:none; }
    .rainTop .drop{ position:absolute; top:-16px; width:3px; height:18px; background:rgba(14,42,112,.55); border-radius:2px; animation:rainFall 1.1s linear infinite; }
    .rainTop .drop.far{ opacity:.6; transform:scale(.9); animation-duration:1.4s; }
    @keyframes rainFall{ to{ transform:translateY(640px); } }

    @keyframes canopyBlink { 0%,100%{ stroke:#065f46;} 50%{ stroke:#000; } }
    .blink-canopy{ animation: canopyBlink 900ms linear infinite; }

    /* Leaf blink on wrapper g; pop on completion */
    @keyframes leafBlink { 0%,100%{ opacity:1; } 50%{ opacity:0.35; } }
    .blink-leaf{ animation: leafBlink 900ms linear infinite; }
    @keyframes leafPop { 0%{ transform:scale(0); opacity:0; } 80%{ transform:scale(1.08); opacity:1; } 100%{ transform:scale(1); opacity:1; } }
    .leaf-pop{ animation: leafPop 380ms ease-out forwards; transform-origin:center; transform-box:fill-box; }

    .tabsWrap{ margin:12px auto; background:#fff; border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:14px; width:760px; max-width:100%; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; padding:8px; border:1px solid var(--line); border-radius:999px; background:var(--surface-2); justify-content:center; }
    .tab{ display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; cursor:pointer; color:#4a6894; }
    .tab.active{ color:#0b1a33; background:linear-gradient(180deg,#e6f1ff,#ffffff); }
    .panelCard{ display:none; margin-top:12px; background:#fff; border:1px solid var(--line); border-radius:18px; padding:14px; gap:10px; flex-direction:column; }
    .modesBar{ display:flex; flex-direction:column; gap:10px; padding:12px; border-radius:14px; background:#fff; border:1px solid var(--line); box-shadow:var(--shadow); }
    .modeEditRow{ display:flex; flex-direction:column; gap:10px; }
    .modeEditRow .editGroup{ display:flex; align-items:center; gap:6px; background:#f8fbff; border:1px solid var(--line); padding:6px 8px; border-radius:10px; }
    .modeEditRow input{ padding:6px 8px; border-radius:8px; border:1px solid var(--line); font-weight:700; width:100%; }

    .gridWrap{ margin:14px auto; background:#fff; border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:14px; width:420px; max-width:92vw; display:flex; flex-direction:column; align-items:center; }
    .gridHead{ display:flex; align-items:center; justify-content:space-between; gap:8px; color:#4a6894; width:100%; max-width:420px; }
    .grid{ display:grid; gap:6px; grid-template-columns:repeat(6, 1fr); width:100%; }
    .cell{ aspect-ratio:1/1; border-radius:10px; background:#f3f8ff; border:1px dashed #c8d8ee; color:#4e6ea0; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:14px; position:relative; }
    .icon{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:18px; pointer-events:none; }
    .cell.live{ background:linear-gradient(180deg,#e9fff1,#ffffff); border:2px solid #16a34a; color:#14563a; }

    @media (max-width: 640px){
      .wrap{ padding-bottom:80px; }
      .treePanel.fixedCard{ width:100%; max-width:92vw; }
      .treeBox{ width:92vw; aspect-ratio:1/1; height:auto; margin:8px auto; position:relative; }
      #treeSVG, #saplingsSVG{ width:100%; height:100%; }
      .soilPct{ font-size:42px; }
      .xyLabel{ font-size:18px; }
      .todaySky{ font-size:16px; top:42px; }
      h1{ font-size:18px; }
      .modeTag{ font-size:16px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><span style="font-weight:800;">ðŸŒ³</span><h1>Pomodoro Tree</h1></div>
      <div class="modeTag">Mode: <span id="modeName">Study</span></div>
    </header>

    <div class="topStack">
      <div class="centerRow">
        <section class="timerTypeBar fixedCard vstack">
          <select id="timerTypeSelect">
            <option value="pomodoro">Pomodoro timer (25 min)</option>
            <option value="custom">Custom timer</option>
            <option value="simple">Simple timer</option>
          </select>
          <div id="customInputs" class="vstack" style="display:none;">
            <span class="miniNote" id="durationLabel">Timer value can be edited only once per week</span>
            <input id="customMin" type="number" min="1" max="999" step="1" value="25" />
            <button id="applyCustomBtn">Apply</button>
            <span id="customLockMsg" class="miniNote">Will be locked</span>
          </div>
        </section>
      </div>

      <div class="centerRow">
        <section class="timerCard fixedCard">
          <div class="time" id="clock">25:00</div>
          <div class="controls">
            <button id="startBtn">Start 25:00</button>
            <button id="resetBtn">Reset</button>
          </div>

          <div class="settings vstack" id="settingsBlock">
            <div class="numWrap" id="lptWrap">
              <label for="lptInput"><strong>Leaves per week (LPT)</strong></label>
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="lptInput" type="number" min="1" max="200" step="1" value="9" />
                <button id="lptSetBtn">Set</button>
                <span id="lptLockNote" class="miniNote">Will be locked</span>
              </div>
              <div class="pctRow">
                <input id="pctRange" type="range" min="0" max="100" step="1" value="0" />
                <span id="pctValue" class="miniNote">0%</span>
              </div>
              <span id="lptHelper" class="miniNote">LPT = No. of timer sessions per week</span>
              <span id="lockHint" class="miniNote">Editable once per ISO week</span>
            </div>

            <div id="weeklyTarget" class="miniNote">Weekly target = 3 hrs 45 mins</div>
          </div>
        </section>
      </div>

      <div class="centerRow">
        <section class="treePanel fixedCard">
          <h3 style="margin:0 0 8px 0; text-align:center;">Current Tree</h3>
          <div class="treeBox" id="treeBox">
            <div class="sky"></div>

            <svg id="saplingsSVG" width="560" height="560" viewBox="0 0 560 560" class="saplingsLayer">
              <g id="saplings" stroke="#2f6f3a" stroke-width="2" fill="none" stroke-linecap="round"></g>
            </svg>

            <div id="soilPct" class="soilPct">0%</div>
            <div id="xyLabel" class="xyLabel">0/9 leaves</div>
            <div id="todaySky" class="todaySky">Total duration (today): 0 mins</div>

            <svg id="treeSVG" width="680" height="620" viewBox="0 0 560 410" preserveAspectRatio="xMidYMid meet">
              <defs>
                <filter id="leafShadow" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="1" stdDeviation="1.0" flood-color="#000" flood-opacity="0.15" /></filter>
                <mask id="fillMask" maskUnits="userSpaceOnUse" x="100" y="150" width="380" height="220">
                  <rect fill="#000" x="100" y="150" width="380" height="220"/>
                  <rect id="fillRect" x="110" y="316" width="360" height="0" fill="#fff"/>
                </mask>
                <linearGradient id="canopyBaseDarker" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" stop-color="#a3e3b5" />
                  <stop offset="100%" stop-color="#7fce9d" />
                </linearGradient>
              </defs>

              <g id="canopyGroup" transform="translate(280 280) scale(1,1.2) translate(-280 -280)">
                <path id="canopyWhite" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="url(#canopyBaseDarker)"/>
                <path id="canopyFillGreen" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="#3aa85f" mask="url(#fillMask)"/>
                <path id="canopyOutline" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="transparent" stroke="#065f46" stroke-width="3" />
                <path d="M 280 380 C 280 350, 280 320, 280 284" fill="none" stroke="#4e342e" stroke-width="32" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M 280 284 C 270 270, 258 255, 248 238" fill="none" stroke="#4e342e" stroke-width="24" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M 280 284 C 290 270, 302 255, 312 238" fill="none" stroke="#4e342e" stroke-width="24" stroke-linecap="round" stroke-linejoin="round" />
                <g id="leafLayer" filter="url(#leafShadow)"></g>
              </g>
            </svg>

            <!-- Topmost rain overlay -->
            <div id="rainTop" class="rainTop" aria-hidden="true"></div>
          </div>
        </section>
      </div>
    </div>

    <section class="tabsWrap" id="tabsWrap">
      <div class="tabs">
        <div class="tab active" data-tab="modesPanel">Modes</div>
        <div class="tab" data-tab="subPanel">Subscription</div>
        <div class="tab" data-tab="syncPanel">Sync</div>
      </div>

      <div id="modesPanel" class="panelCard" style="display:flex;">
        <div class="modesBar">
          <div class="modeEditRow">
            <select id="modeSelect" title="Switch mode"></select>
          </div>
          <div class="modeEditRow" id="editableNamesRow">
            <div class="editGroup"><span>Subject 1</span><input id="subject1Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>Subject 2</span><input id="subject2Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>Subject 3</span><input id="subject3Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>User 1</span><input id="user1Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>User 2</span><input id="user2Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>User 3</span><input id="user3Input" placeholder="Edit name" /></div>
            <button id="saveNamesBtn">Save names</button>
          </div>
        </div>
      </div>

      <div id="subPanel" class="panelCard">
        <div id="subStatus">Plan: Free â€” 4 weeks cap. Unlock remaining 48 weeks for $1/year.</div>
        <button id="subBtn">Unlock 48 weeks â€” $1</button>
      </div>

      <div id="syncPanel" class="panelCard">
        <div id="authState">Signed out</div>
        <input type="email" id="emailInput" placeholder="email@example.com" />
        <button id="sendLinkBtn">Send sign-in link</button>
        <button id="signOutBtn">Sign out</button>
      </div>
    </section>

    <section class="gridWrap" id="gridWrap">
      <div class="gridHead">
        <div class="chip">Completed Trees</div>
        <div class="chip" id="gridCount">0 / 52</div>
      </div>
      <div class="grid" id="treeGrid"></div>
    </section>
  </div>

  <script>
    const APP_KEY='pomodoroTree_RunOnlyAnim_Reset_v1';
    const GLOBAL_KEY=APP_KEY+'_global', NAMES_KEY=APP_KEY+'_names';
    const svgns='http://www.w3.org/2000/svg';

    const TIMER_TYPES={ pomodoro:'pomodoro', custom:'custom', simple:'simple' };
    const POMODORO_SECONDS=25*60;

    const load=(k,d)=>{ try{ return Object.assign({}, d||{}, JSON.parse(localStorage.getItem(k)||'{}')); }catch{ return Object.assign({}, d||{}); } };
    const save=(k,v)=> localStorage.setItem(k, JSON.stringify(v));

    const G = load(GLOBAL_KEY, { timerType:TIMER_TYPES.pomodoro, customSeconds:25*60 });
    let S = load(APP_KEY+'_state', { leavesPerTree:9, placed:0, secondsLeft:POMODORO_SECONDS });

    // Els
    const el=id=>document.getElementById(id);
    const timerTypeSelect=el('timerTypeSelect'), customInputs=el('customInputs'), customMin=el('customMin'), applyCustomBtn=el('applyCustomBtn');
    const clockEl=el('clock'), startBtn=el('startBtn'), resetBtn=el('resetBtn');
    const lptInput=el('lptInput'), lptSetBtn=el('lptSetBtn'), lptLockNote=el('lptLockNote');
    const pctRange=el('pctRange'), pctValue=el('pctValue');
    const soilPct=el('soilPct'), xyLabel=el('xyLabel'), todaySky=el('todaySky');
    const leafLayer=document.querySelector('#treeSVG #leafLayer'), fillRect=document.getElementById('fillRect');
    const rainTop=el('rainTop');

    // Timer helpers
    function getSessionSeconds(){
      if(G.timerType==='pomodoro') return 25*60;
      if(G.timerType==='custom') return Math.max(60, Number(G.customSeconds)||1500);
      return Math.max(60, Number(G.customSeconds)||1500);
    }
    function format(s){ const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }
    function setClockAndButtons(){
      const secs=getSessionSeconds();
      if(S.secondsLeft<=0 || S.secondsLeft>secs) S.secondsLeft=secs;
      clockEl.textContent=format(S.secondsLeft);
      startBtn.textContent=`Start ${format(secs)}`;
    }

    // Progress + slider
    function setFillPercent(p){
      const CANOPY_BOTTOM=316, FILL_OVERSCAN=165;
      const h=FILL_OVERSCAN*(p/100), y=CANOPY_BOTTOM-h;
      fillRect.setAttribute('y', String(y));
      fillRect.setAttribute('height', String(h));
      soilPct.textContent = Math.round(p)+'%';
    }
    function updateProgressInstant(){
      const total=Math.max(1, Number(S.leavesPerTree)||1);
      const done=Math.min(S.placed,total);
      const pct=Math.round((done/total)*100);
      setFillPercent(pct);
      xyLabel.textContent=`${done}/${total} leaves`;
      pctRange.value=String(pct);
      pctValue.textContent=`${pct}%`;
      pctRange.style.background = `linear-gradient(90deg, var(--slider-done) ${pct}%, var(--slider-left) ${pct}%)`;
    }
    pctRange.addEventListener('input', ()=>{
      const pct=Math.max(0, Math.min(100, Number(pctRange.value)||0));
      pctValue.textContent=`${pct}%`;
      pctRange.style.background = `linear-gradient(90deg, var(--slider-done) ${pct}%, var(--slider-left) ${pct}%)`;
      const total=Math.max(1, Number(S.leavesPerTree)||1);
      S.placed = Math.min(total, Math.max(0, Math.round((pct/100)*total)));
      renderLeaves();
      setFillPercent(pct);
      xyLabel.textContent=`${S.placed}/${total} leaves`;
      save(APP_KEY+'_state', S);
    });

    // Leaves + animations
    function baseAnchors(){ return [{x:280,y:250},{x:220,y:255},{x:350,y:250},{x:220,y:300},{x:340,y:300},{x:255,y:205},{x:340,y:205},{x:390,y:260},{x:190,y:260}]; }
    function anchorForIndex(i){
      const b=baseAnchors();
      if(i<b.length) return b[i];
      const k=i-b.length+1, a=k*137.508*Math.PI/180, r=30+0.9*Math.sqrt(k)*8, cx=280, cy=260;
      return {x:cx+r*Math.cos(a), y:cy+r*Math.sin(a)*0.7};
    }
    function makeLeafG(n){
      const wrap=document.createElementNS(svgns,'g');
      const g=document.createElementNS(svgns,'g'); g.setAttribute('class','leaf');
      const p=document.createElementNS(svgns,'path'); p.setAttribute('d','M 0 -16 C 10 -10, 12 0, 0 14 C -12 0, -10 -10, 0 -16 Z'); p.setAttribute('fill','#166534'); p.setAttribute('stroke','#0b3d22'); p.setAttribute('stroke-width','1.2');
      const t=document.createElementNS(svgns,'text'); t.setAttribute('x','0'); t.setAttribute('y','0'); t.setAttribute('fill','#fff'); t.setAttribute('font-weight','800'); t.setAttribute('font-size','13'); t.setAttribute('text-anchor','middle'); t.setAttribute('dominant-baseline','middle'); t.textContent=String(n);
      g.appendChild(p); g.appendChild(t); wrap.appendChild(g); return wrap;
    }
    function placeLeaf(wrap,a){
      wrap.setAttribute('transform',`translate(${a.x} ${a.y}) scale(1.05)`);
      wrap.style.transformBox='fill-box'; wrap.style.transformOrigin='center';
    }
    function renderLeaves(){
      leafLayer.innerHTML='';
      for(let i=0;i<S.placed;i++){
        const w=makeLeafG(i+1); placeLeaf(w, anchorForIndex(i)); leafLayer.appendChild(w);
      }
    }

    // Blink placeholder lives only while running
    let blinkWrap=null;
    function startBlinkPlaceholder(){
      stopBlinkPlaceholder();
      const idx=S.placed;
      blinkWrap=makeLeafG(idx+1);
      placeLeaf(blinkWrap, anchorForIndex(idx));
      // restart CSS animation reliably by forcing reflow between class toggles
      const inner=blinkWrap.firstElementChild;
      inner.classList.remove('blink-leaf');
      void inner.offsetWidth; // reflow
      inner.classList.add('blink-leaf'); // blink starts now
      leafLayer.appendChild(blinkWrap);
    }
    function stopBlinkPlaceholder(){
      if(blinkWrap){
        const inner=blinkWrap.firstElementChild;
        inner.classList.remove('blink-leaf');
        try{ leafLayer.removeChild(blinkWrap); }catch{}
        blinkWrap=null;
      }
    }
    function finalizeLeafPop(){
      if(blinkWrap){
        const inner=blinkWrap.firstElementChild;
        inner.classList.remove('blink-leaf');
        inner.classList.add('leaf-pop');
        blinkWrap=null;
      }else{
        const idx=S.placed-1;
        const w=makeLeafG(S.placed);
        placeLeaf(w, anchorForIndex(idx));
        w.firstElementChild.classList.add('leaf-pop');
        leafLayer.appendChild(w);
      }
    }

    // Rain (top-most) only while running
    function ensureRainDrops(){
      if(rainTop.childElementCount>0) return;
      const mk=(n, cls='')=>{
        for(let i=0;i<n;i++){
          const d=document.createElement('div'); d.className='drop'+cls;
          d.style.left=(Math.random()*560)+'px';
          d.style.animationDelay=(Math.random()*1.0)+'s';
          d.style.animationDuration=(cls? (1.1+Math.random()*0.9)+'s' : (0.8+Math.random()*0.7)+'s');
          rainTop.appendChild(d);
        }
      };
      mk(160,''); mk(140,' far');
    }
    function rain(on){
      ensureRainDrops();
      rainTop.style.display = on ? 'block' : 'none';
    }

    // Canopy blink on run
    function canopyBlink(on){
      const outline=document.getElementById('canopyOutline');
      outline?.classList.toggle('blink-canopy', !!on);
    }

    // Timer
    let ticker=null;
    function startSession(){
      if(ticker) return;
      const maxSecs=getSessionSeconds();
      if(S.secondsLeft<=0 || S.secondsLeft>maxSecs) S.secondsLeft=maxSecs;

      canopyBlink(true);
      rain(true);
      startBlinkPlaceholder();

      const target=Date.now()+S.secondsLeft*1000;
      const tick=()=>{
        const msLeft=Math.max(0, target - Date.now());
        S.secondsLeft=Math.ceil(msLeft/1000);
        clockEl.textContent=format(S.secondsLeft);
        if(msLeft<=0){
          stopSession();
          onComplete();
        }
      };
      tick();
      ticker=setInterval(tick, 200);
    }
    function stopSession(){
      if(ticker){ clearInterval(ticker); ticker=null; }
      canopyBlink(false);
      rain(false);
      stopBlinkPlaceholder();
    }
    function onComplete(){
      const dur=getSessionSeconds();
      S.placed+=1;
      finalizeLeafPop();
      S.secondsLeft=getSessionSeconds();
      save(APP_KEY+'_state', S);
      setClockAndButtons();
      updateProgressInstant();
    }

    // Controls
    const timerTypeSelectEl=timerTypeSelect;
    timerTypeSelectEl.addEventListener('change', ()=>{
      G.timerType=timerTypeSelectEl.value; save(GLOBAL_KEY,G);
      if(G.timerType==='pomodoro') S.secondsLeft=25*60;
      setClockAndButtons(); updateProgressInstant();
    });
    applyCustomBtn.addEventListener('click', ()=>{
      const mins=Math.max(1, Math.floor(Number(customMin.value)||0));
      if(G.timerType==='custom' || G.timerType==='simple'){ G.customSeconds=mins*60; save(GLOBAL_KEY,G); }
      S.secondsLeft=getSessionSeconds(); setClockAndButtons(); updateProgressInstant();
    });

    lptSetBtn.addEventListener('click', ()=>{
      const v=Math.max(1, Math.min(200, Math.floor(Number(lptInput.value)||1)));
      S.leavesPerTree=v; lptInput.value=String(v);
      S.placed=0; leafLayer.innerHTML='';
      updateProgressInstant();
      save(APP_KEY+'_state', S);
    });

    startBtn.addEventListener('click', startSession);
    resetBtn.addEventListener('click', ()=>{
      // Stop everything and clear the blinking leaf
      stopSession();
      // Reset session time and do NOT keep the placeholder
      S.secondsLeft=getSessionSeconds();
      setClockAndButtons();
      // Reset effects: percent stays from placed; leaf blink removed
      updateProgressInstant();
      save(APP_KEY+'_state', S);
    });

    // Saplings
    const saplingsG=document.getElementById('saplings');
    function buildSaplings(){
      saplingsG.innerHTML='';
      const rows=6, cols=7, left=24, right=536;
      const soilTopY=Math.round(560*0.62)+14, y0=Math.max(soilTopY, 340), rowGap=24;
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const x=Math.round(left + c*((right-left)/(cols-1)));
          const y=y0 + r*rowGap;
          const stem=document.createElementNS(svgns,'path');
          stem.setAttribute('d', `M ${x} ${y} l 0 -14`);
          stem.setAttribute('stroke','#2f6f3a'); stem.setAttribute('stroke-width','2'); stem.setAttribute('fill','none'); stem.setAttribute('stroke-linecap','round');
          const leafL=document.createElementNS(svgns,'path'); leafL.setAttribute('d', `M ${x} ${y-12} c -6 -2, -10 -6, -12 -10`);
          leafL.setAttribute('stroke','#2f6f3a'); leafL.setAttribute('stroke-width','2'); leafL.setAttribute('fill','none'); leafL.setAttribute('stroke-linecap','round'); leafL.setAttribute('stroke-linejoin','round');
          const leafR=document.createElementNS(svgns,'path'); leafR.setAttribute('d', `M ${x} ${y-12} c 6 -2, 10 -6, 12 -10`);
          leafR.setAttribute('stroke','#2f6f3a'); leafR.setAttribute('stroke-width','2'); leafR.setAttribute('fill','none'); leafR.setAttribute('stroke-linecap','round'); leafR.setAttribute('stroke-linejoin','round');
          saplingsG.appendChild(stem); saplingsG.appendChild(leafL); saplingsG.appendChild(leafR);
        }
      }
    }

    // Init
    function init(){
      buildSaplings();
      setClockAndButtons();
      updateProgressInstant();
      // Prepare rain DOM (no animation until start)
      (function ensureRain(){ if(rainTop.childElementCount===0){ const mk=(n, cls='')=>{ for(let i=0;i<n;i++){ const d=document.createElement('div'); d.className='drop'+cls; d.style.left=(Math.random()*560)+'px'; d.style.animationDelay=(Math.random()*1.0)+'s'; d.style.animationDuration=(cls? (1.1+Math.random()*0.9)+'s' : (0.8+Math.random()*0.7)+'s'); rainTop.appendChild(d);} }; mk(160,''); mk(140,' far'); } })();
    }
    init();
  </script>
</body>
</html>
