<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pomodoro Tree â€” Study Mode</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#eaf3ff; --surface:#ffffff; --surface-2:#eef6ff; --line:#caddf8;
      --text:#0b1a33; --dim:#4a6894;
      --radius-lg:18px; --shadow:0 10px 28px rgba(30,70,140,.1);
      --btn-text:#ffffff; --btn-primary:#2563eb; --btn-primary-hover:#1e40af;
      --btn-success:#16a34a; --btn-success-hover:#0f6a33;
      --btn-danger:#ef4444; --btn-danger-hover:#b91c1c;
      --btn-neutral:#334155; --btn-neutral-hover:#1f2937; --btn-focus:#0ea5e9;
      --progress-green:#16a34a; --progress-red:#ef4444; --track-bg:#e6efff;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width:1140px; margin:0 auto; padding:20px 16px 120px; }

    /* Header single-line on mobile */
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:nowrap; }
    .brand{ display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px; background:linear-gradient(180deg,#f0f6ff,#ffffff); border:1px solid var(--line); white-space:nowrap; }
    h1{ margin:0; font-size:22px; }
    .modeTag{ font-weight:800; color:#14563a; font-size:20px; white-space:nowrap; }

    @media (max-width: 420px){
      h1{ font-size:18px; }
      .modeTag{ font-size:16px; }
      header{ gap:8px; }
    }

    .topStack{ display:flex; flex-direction:column; gap:12px; margin-top:12px; width:100%; }
    .centerRow{ width:100%; display:flex; justify-content:center; }
    .fixedCard{ width:760px; max-width:100%; }

    /* Timer type + duration (vertical; minutes only) */
    .timerTypeBar{ display:flex; flex-direction:column; gap:10px; background:#fff; border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow:var(--shadow); }
    .vstack{ display:flex; flex-direction:column; gap:10px; }
    .vstack select, .vstack input[type=number]{ padding:8px 10px; border-radius:12px; border:1px solid var(--line); font-weight:800; width:100%; }
    .miniNote{ color:#4a6894; font-weight:700; }

    /* Timer card */
    .timerCard{ display:flex; align-items:center; background:#fff; border:1px solid var(--line); border-radius:var(--radius-lg); padding:16px; box-shadow:var(--shadow); flex-direction:column; }
    .time{ font-size:112px; font-weight:800; color:#0e2a70; text-align:center; }
    .controls{ display:flex; align-items:center; gap:8px; margin-top:10px; flex-wrap:wrap; justify-content:center; }
    button{
      border:none; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer;
      color:#fff; background:var(--btn-neutral);
      box-shadow:0 1px 0 rgba(0,0,0,.06), 0 6px 14px rgba(15,23,42,.14);
      transition:background-color .18s ease, transform .08s ease, box-shadow .18s ease;
      border:1px solid rgba(255,255,255,.06);
    }
    #startBtn{ background:var(--btn-success); }
    #resetBtn{ background:var(--btn-danger); }
    #applyCustomBtn{ background:var(--btn-primary); }

    .settings{ display:flex; flex-direction:column; gap:12px; margin-top:10px; color:var(--dim); width:100%; }
    .numWrap{ display:flex; flex-direction:column; gap:8px; align-items:flex-start; }
    .numWrap input{ width:160px; }

    .progressWrap{ display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
    #lptRange{
      -webkit-appearance:none; appearance:none; width:240px; height:10px; border-radius:999px; overflow:hidden; background:var(--track-bg); border:1px solid var(--line);
      background-image:linear-gradient(90deg, #16a34a 0%, #ef4444 0%);
      background-size:100% 100%; background-repeat:no-repeat;
    }
    #lptRange::-webkit-slider-thumb{ -webkit-appearance:none; width:0; height:0; background:transparent; }
    #lptRange::-moz-range-thumb{ width:0; height:0; background:transparent; border:none; }

    /* Tree canvas; responsive fit */
    .treePanel{ display:flex; align-items:center; background:#fff; border:1px solid var(--line); border-radius:var(--radius-lg); padding:14px; flex-direction:column; box-shadow:var(--shadow); }
    .treePanel.fixedCard{ width:760px; }
    .treeBox{ position:relative; width:560px; max-width:100%; height:560px; margin:6px auto; border:1px solid var(--line); border-radius:18px; overflow:hidden; }
    .sky{ position:absolute; inset:0; background:linear-gradient(180deg,#cfe8ff 0%, #8ec5ff 62%, #bfeec7 62%, #8edaa0 100%); }
    .percentLabel{ position:absolute; left:14px; bottom:8px; font:900 64px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#ef4444; text-shadow:0 3px 0 #fff, 0 0 10px rgba(255,255,255,.75); z-index:2; }
    .xyLabel{ position:absolute; left:14px; top:12px; font:900 24px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#0b1a33; text-shadow:0 2px 0 rgba(255,255,255,.65); z-index:2; }
    .todaySky{ position:absolute; left:14px; top:46px; font:800 18px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#14563a; text-shadow:0 2px 0 rgba(255,255,255,.65); z-index:2; background:rgba(255,255,255,.55); padding:4px 8px; border-radius:10px; border:1px solid rgba(200,216,238,.8); }

    #treeSVG{ position:absolute; left:50%; transform:translateX(-50%); bottom:20px; overflow:visible; width:680px; height:620px; }

    /* TZ + stats */
    .tzBar{ display:flex; flex-direction:column; gap:10px; padding:12px; border-radius:14px; background:#fff; border:1px solid var(--line); box-shadow:var(--shadow); margin-top:12px; width:560px; max-width:100%; }
    .tzLeft{ display:flex; flex-direction:column; gap:8px; width:100%; }
    .tzLeft select{ padding:8px 10px; border-radius:12px; border:1px solid var(--line); background:#fff; color:#0b1a33; font-weight:700; width:100%; }
    .stats{ display:flex; flex-direction:column; gap:8px; width:100%; }
    .chip{ display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:#fff; border:1px solid var(--line); color:#4a6894; width:100%; justify-content:center; }

    /* Tabs + Modes vertical */
    .tabsWrap{ margin:12px auto; background:#fff; border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:14px; width:760px; max-width:100%; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; padding:8px; border:1px solid var(--line); border-radius:999px; background:var(--surface-2); justify-content:center; }
    .tab{ display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; cursor:pointer; color:#4a6894; }
    .tab.active{ color:#0b1a33; background:linear-gradient(180deg,#e6f1ff,#ffffff); }
    .panelCard{ display:none; margin-top:12px; background:#fff; border:1px solid var(--line); border-radius:18px; padding:14px; gap:10px; flex-direction:column; }
    .modesBar{ display:flex; flex-direction:column; gap:10px; padding:12px; border-radius:14px; background:#fff; border:1px solid var(--line); box-shadow:var(--shadow); }
    .modeEditRow{ display:flex; flex-direction:column; gap:10px; }
    .modeEditRow .editGroup{ display:flex; align-items:center; gap:6px; background:#f8fbff; border:1px solid var(--line); padding:6px 8px; border-radius:10px; }
    .modeEditRow input{ padding:6px 8px; border-radius:8px; border:1px solid var(--line); font-weight:700; width:100%; }

    /* Completed Trees: 6 columns */
    .gridWrap{ margin:14px auto; background:#fff; border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:14px; width:420px; max-width:92vw; display:flex; flex-direction:column; align-items:center; }
    .gridHead{ display:flex; align-items:center; justify-content:space-between; gap:8px; color:#4a6894; width:100%; max-width:420px; }
    .grid{ display:grid; gap:6px; grid-template-columns:repeat(6, 1fr); width:100%; }
    .cell{ aspect-ratio:1/1; border-radius:10px; background:#f3f8ff; border:1px dashed #c8d8ee; color:#4e6ea0; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:14px; position:relative; }
    .icon{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:18px; pointer-events:none; }
    .cell.live{ background:linear-gradient(180deg,#e9fff1,#ffffff); border:2px solid #16a34a; color:#14563a; }

    .bottomAuth{ margin:18px auto 0; max-width:560px; justify-content:center; gap:10px; flex-wrap:wrap; color:#4a6894; display:flex; flex-direction:column; align-items:stretch; }

    .hidden{ display:none !important; }

    /* Mobile: shrink canvas to avoid clipping; keep header 1-line */
    @media (max-width: 640px){
      .treeBox{ width:92vw; height:92vw; max-width:92vw; }
      #treeSVG{ width:92vw; height:auto; left:50%; transform:translateX(-50%); }
      .percentLabel{ font-size:48px; }
      .xyLabel{ font-size:18px; }
      .todaySky{ font-size:16px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><span style="font-weight:800;">ðŸŒ³</span><h1>Pomodoro Tree</h1></div>
      <div class="modeTag">Mode: <span id="modeName">Study</span></div>
    </header>

    <div class="topStack">
      <!-- Timer type and duration (minutes only) -->
      <div class="centerRow">
        <section class="timerTypeBar fixedCard vstack" aria-label="Timer type and custom duration">
          <select id="timerTypeSelect">
            <option value="pomodoro">Pomodoro timer (25 min)</option>
            <option value="custom">Custom timer</option>
            <option value="simple">Simple timer</option>
          </select>
          <div id="customInputs" class="vstack" style="display:none;">
            <div class="vstack">
              <span class="miniNote">Custom duration (minutes)</span>
              <input id="customMin" type="number" min="1" max="999" step="1" value="15" />
              <button id="applyCustomBtn" title="Apply custom minutes">Apply</button>
              <span id="customLockMsg" class="miniNote"></span>
            </div>
          </div>
        </section>
      </div>

      <!-- Timer -->
      <div class="centerRow">
        <section class="timerCard fixedCard">
          <div class="time" id="clock">25:00</div>
          <div class="controls">
            <button id="startBtn">Start 25:00</button>
            <button id="resetBtn">Reset</button>
          </div>
          <div class="settings vstack" id="settingsBlock">
            <div class="numWrap">
              <label for="lptInput"><strong>Leaves per week</strong></label>
              <input id="lptInput" type="number" min="1" max="200" step="1" value="9" />
              <button id="lptSetBtn">Set</button>
              <span id="lockHint" class="miniNote">Editable once per ISO week</span>
            </div>
            <div class="progressWrap" id="progressBlock">
              <label class="miniNote">Weekly completion</label>
              <input type="range" id="lptRange" min="0" max="100" step="1" value="0" readonly />
              <span id="progressPct">0%</span>
            </div>
            <div id="weeklyTarget" class="miniNote">Weekly target = 3 hrs 45 mins</div>
          </div>
        </section>
      </div>

      <!-- Tree canvas -->
      <div class="centerRow">
        <section class="treePanel fixedCard">
          <h3 style="margin:0 0 8px 0; text-align:center;">Current Tree</h3>
          <div class="treeBox">
            <div class="sky"></div>
            <div id="percentLabel" class="percentLabel">0%</div>
            <div id="xyLabel" class="xyLabel">0/9 leaves</div>
            <div id="todaySky" class="todaySky">Total duration (today): 0 mins</div>
            <div id="rainLayer" class="rain"></div>

            <svg width="560" height="560" viewBox="0 0 560 560" style="position:absolute; inset:0; pointer-events:none;">
              <g id="saplings" stroke="#2f6f3a" stroke-width="2" fill="none" stroke-linecap="round"></g>
            </svg>

            <svg id="treeSVG" width="680" height="620" viewBox="0 0 560 410" preserveAspectRatio="xMidYMid meet">
              <defs>
                <filter id="leafShadow" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="1" stdDeviation="1.0" flood-color="#000" flood-opacity="0.15" /></filter>
                <mask id="fillMask" maskUnits="userSpaceOnUse" x="100" y="150" width="380" height="220">
                  <rect fill="#000" x="100" y="150" width="380" height="220"/>
                  <rect id="fillRect" x="110" y="316" width="360" height="0" fill="#fff"/>
                </mask>
                <linearGradient id="canopyBaseDarker" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" stop-color="#a3e3b5" />
                  <stop offset="100%" stop-color="#7fce9d" />
                </linearGradient>
              </defs>

              <g id="canopyGroup" transform="translate(280 280) scale(1,1.2) translate(-280 -280)">
                <path id="canopyWhite" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="url(#canopyBaseDarker)"/>
                <path id="canopyFillGreen" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="#3aa85f" mask="url(#fillMask)"/>
                <path id="canopyOutline" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="transparent" stroke="#065f46" stroke-width="3" />
                <path d="M 280 380 C 280 350, 280 320, 280 284" fill="none" stroke="#4e342e" stroke-width="32" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M 280 284 C 270 270, 258 255, 248 238" fill="none" stroke="#4e342e" stroke-width="24" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M 280 284 C 290 270, 302 255, 312 238" fill="none" stroke="#4e342e" stroke-width="24" stroke-linecap="round" stroke-linejoin="round" />
                <g id="leafLayer" filter="url(#leafShadow)"></g>
              </g>
            </svg>
          </div>
        </section>
      </div>
    </div>

    <!-- TZ + stats -->
    <div class="centerRow">
      <div class="tzBar" id="tzBar">
        <div class="tzLeft">
          <select id="tzSelect" aria-label="Time zone"></select>
        </div>
        <div class="stats" id="statsChips">
          <div class="chip" id="todayChip"><strong>Pomodoro hrs (week)</strong>: 0 hrs 0 mins</div>
          <div class="chip" id="totalTimeChip"><strong>Pomodoro hrs (overall)</strong>: 0 hrs 0 mins</div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <section class="tabsWrap" id="tabsWrap">
      <div class="tabs">
        <div class="tab" data-tab="subPanel">Subscription</div>
        <div class="tab" data-tab="syncPanel">Sync</div>
        <div class="tab active" data-tab="modesPanel">Modes</div>
      </div>

      <div id="subPanel" class="panelCard">
        <div id="subStatus">Plan: Free â€” 4 weeks cap. Unlock remaining 48 weeks for $1/year.</div>
        <button id="subBtn">Unlock 48 weeks â€” $1</button>
      </div>

      <div id="syncPanel" class="panelCard">
        <div id="authState">Signed out</div>
        <input type="email" id="emailInput" placeholder="email@example.com" />
        <button id="sendLinkBtn">Send sign-in link</button>
        <button id="signOutBtn">Sign out</button>
      </div>

      <div id="modesPanel" class="panelCard" style="display:flex;">
        <div class="modesBar">
          <div class="modeEditRow">
            <select id="modeSelect" title="Switch mode"></select>
          </div>
          <div class="modeEditRow" id="editableNamesRow">
            <div class="editGroup"><span>Subject 1</span><input id="subject1Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>Subject 2</span><input id="subject2Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>Subject 3</span><input id="subject3Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>User 1</span><input id="user1Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>User 2</span><input id="user2Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span>User 3</span><input id="user3Input" placeholder="Edit name" /></div>
            <button id="saveNamesBtn">Save names</button>
          </div>
          <div class="miniNote">Modes and inputs are stacked vertically.</div>
        </div>
      </div>
    </section>

    <!-- Completed Trees: 6 columns -->
    <section class="gridWrap" id="gridWrap">
      <div class="gridHead">
        <div class="chip">Completed Trees</div>
        <div class="chip" id="gridCount">0 / 52</div>
      </div>
      <div class="grid" id="treeGrid"></div>
    </section>

    <div class="bottomAuth" id="bottomAuth">
      <input type="email" id="emailInputBottom" placeholder="email@example.com" />
      <button id="sendLinkBtnBottom">Sign in</button>
      <button id="signOutBtnBottom">Sign out</button>
    </div>
  </div>

  <script>
    const APP_KEY = 'pomodoroTree_CustomLockMinutes_V1';
    const GLOBAL_KEY = APP_KEY + '_global';
    const NAMES_KEY = APP_KEY + '_names';
    const svgns='http://www.w3.org/2000/svg';

    const TIMER_TYPES = { pomodoro:'pomodoro', custom:'custom', simple:'simple' };
    const POMODORO_SECONDS = 25*60;

    const DEFAULT_MODE_NAMES = {
      'exercise': 'Exercise mode', 'cycling': 'Cycling mode', 'digitalDetox': 'Digital detox mode', 'bedTime': 'Bed-time mode',
      'quran': 'Quran mode', 'dikhr': 'Dikhr mode', 'maths': 'Maths mode', 'subject1': 'Subject 1 mode',
      'subject2': 'Subject 2 mode', 'subject3': 'Subject 3 mode', 'user1': 'User 1 mode', 'user2': 'User 2 mode', 'user3': 'User 3 mode'
    };

    const load = (k,d)=>{ try{ return Object.assign({}, d||{}, JSON.parse(localStorage.getItem(k)||'{}')); }catch{ return Object.assign({}, d||{}); } };
    const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

    const G = load(GLOBAL_KEY, { timeZone:'UTC', selectedMode:'maths', timerType:TIMER_TYPES.pomodoro, customSeconds: 15*60 });
    const CUSTOM_NAMES = load(NAMES_KEY, {});

    const modeKey = (modeId)=> `${APP_KEY}_mode_${modeId}`;
    const DEFAULT_STATE = {
      leavesPerTree:9, placed:0, secondsLeft:POMODORO_SECONDS, running:false,
      leavesTotal:0, leavesToday:0, weeklyLeaves:0,
      weeklyFocusSeconds:0, totalFocusSeconds:0, completedSessions:0,
      grid:[], subActive:true, plan:'Free',
      week:undefined, year:undefined,
      weeklyComplete:false,
      weeklyTargetLocked:false, weeklyTargetSetValue:9,
      customLocked:false, customLockWeek:undefined, customLockYear:undefined,
    };

    function loadState(modeId){ return load(modeKey(modeId), DEFAULT_STATE); }
    function saveState(modeId,S){ save(modeKey(modeId), S); }

    let currentMode = G.selectedMode || 'maths';
    let S = loadState(currentMode);

    const el=id=>document.getElementById(id);
    const clockEl=el('clock'), startBtn=el('startBtn'), resetBtn=el('resetBtn');
    const timerTypeSelect=el('timerTypeSelect'), customInputs=el('customInputs'), customMinInput=el('customMin'), applyCustomBtn=el('applyCustomBtn'), customLockMsg=el('customLockMsg');
    const lptInput=el('lptInput'), lptSetBtn=el('lptSetBtn'), lockHint=el('lockHint');
    const progressBlock=el('progressBlock'), lptRange=el('lptRange'), progressPct=el('progressPct'), weeklyTargetEl=el('weeklyTarget');
    const percentLabel=el('percentLabel'), xyLabel=el('xyLabel'), todaySky=el('todaySky');
    const treeGrid=el('treeGrid'), gridCount=el('gridCount'), modeNameEl=el('modeName');
    const tzSelect=el('tzSelect');

    function nowInTZ(){
      try{
        const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: G.timeZone, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false });
        const parts = fmt.formatToParts(new Date());
        const get = k => Number(parts.find(p=>p.type===k)?.value);
        const y=get('year'), m=get('month'), d=get('day'), hh=get('hour'), mm=get('minute'), ss=get('second');
        return new Date(Date.UTC(y, m-1, d, hh, mm, ss));
      }catch{ return new Date(); }
    }
    function isoWeekOf(date){
      const d = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const week = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return { week, year: d.getUTCFullYear() };
    }

    function rolloverWeekIfNeeded(){
      const {week,year}=isoWeekOf(nowInTZ());
      if(S.week===undefined || S.year===undefined){ S.week=week; S.year=year; saveAll(); return; }
      if(S.week!==week || S.year!==year){
        // carry last week's completion to grid
        const completed = S.placed>=S.leavesPerTree && S.leavesPerTree>0;
        S.grid.unshift({week:S.week,year:S.year,live:completed,ts:Date.now()});
        if(S.grid.length>52) S.grid.pop();
        // reset week stats and unlock weekly settings
        S.week=week; S.year=year;
        S.weeklyLeaves=0; S.leavesToday=0; S.weeklyFocusSeconds=0; S.weeklyComplete=false;
        S.weeklyTargetLocked=false; S.weeklyTargetSetValue=S.leavesPerTree;
        // unlock custom timer for this week
        S.customLocked=false; S.customLockWeek=undefined; S.customLockYear=undefined;
        // reset progress and placeholder leaf visuals
        S.placed=0; S.secondsLeft=getSessionSeconds();
        document.querySelector('#treeSVG #leafLayer').innerHTML='';
        saveAll();
      }
    }

    function getSessionSeconds(){
      if(G.timerType==='pomodoro') return POMODORO_SECONDS;
      if(G.timerType==='custom') return Math.max(60, Number(G.customSeconds)||900);
      if(G.timerType==='simple') return Math.max(60, Number(G.customSeconds)||900);
      return POMODORO_SECONDS;
    }

    function format(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}`; }

    // Accurate countdown via wall-clock target
    const intervals={};
    function clearTicker(){ if(intervals[currentMode]){ clearInterval(intervals[currentMode]); intervals[currentMode]=null; } }
    function startSession(){
      if(intervals[currentMode]) return;
      const maxSecs=getSessionSeconds();
      if(S.secondsLeft<=0 || S.secondsLeft>maxSecs) S.secondsLeft=maxSecs;

      const target = Date.now() + S.secondsLeft*1000;
      const tick = ()=>{
        const msLeft = Math.max(0, target - Date.now());
        S.secondsLeft = Math.ceil(msLeft/1000);
        clockEl.textContent = format(S.secondsLeft);
        if(msLeft<=0){
          clearTicker();
          onComplete();
        }
      };
      tick();
      clearTicker();
      intervals[currentMode]=setInterval(tick,1000);
    }

    function stopSession(){
      clearTicker();
    }

    function onComplete(){
      // record work only for pomodoro/custom
      if(G.timerType!=='simple'){
        const dur=getSessionSeconds();
        S.weeklyFocusSeconds=(S.weeklyFocusSeconds||0)+dur;
        S.totalFocusSeconds=(S.totalFocusSeconds||0)+dur;
        S.completedSessions=(S.completedSessions||0)+1;
        S.placed+=1; S.leavesTotal+=1; S.leavesToday+=1; S.weeklyLeaves+=1;
        if(S.placed>=S.leavesPerTree){ S.weeklyComplete=true; }
        updateProgressUI();
      }else{
        S.placed+=1; S.leavesTotal+=1; S.leavesToday+=1;
      }
      // reset for next session
      S.secondsLeft=getSessionSeconds();
      clockEl.textContent=format(S.secondsLeft);
      saveAll();
      renderAll();
    }

    function setClockAndButtons(){
      const secs=getSessionSeconds();
      if(S.secondsLeft<=0 || S.secondsLeft>secs) S.secondsLeft=secs;
      clockEl.textContent=format(S.secondsLeft);
      startBtn.textContent=`Start ${format(secs)}`;
    }

    function updateWeeklyTargetText(){
      const per=getSessionSeconds();
      const totalSec = per * (S.leavesPerTree||0);
      const h=Math.floor(totalSec/3600), m=Math.round((totalSec%3600)/60);
      weeklyTargetEl.textContent=`Weekly target = ${h>0? h+' hrs ':''}${m} mins`;
    }

    function updateProgressUI(){
      // slider shows completion of placed/leavesPerTree in greenâ†’red
      const total=Math.max(1, Number(S.leavesPerTree)||1);
      const done=Math.min(S.placed,total);
      const pct=Math.round((done/total)*100);
      lptRange.value=String(pct);
      lptRange.style.backgroundImage=`linear-gradient(90deg, var(--progress-green) ${pct}%, var(--progress-red) ${pct}%)`;
      progressPct.textContent=`${pct}%`;
      percentLabel.textContent=`${pct}%`;
      xyLabel.textContent=`${done}/${total} leaves`;
    }

    function renderGrid(){
      treeGrid.innerHTML='';
      for(let i=0;i<52;i++){
        const cell=document.createElement('div'); cell.className='cell';
        const num=document.createElement('div'); num.className='num'; num.textContent=String(i+1);
        const icon=document.createElement('div'); icon.className='icon';
        const entry=S.grid[i];
        if(entry){ icon.textContent= entry.live?'ðŸŒ³':''; if(entry.live) cell.classList.add('live'); }
        cell.appendChild(num); cell.appendChild(icon); treeGrid.appendChild(cell);
      }
      gridCount.textContent=`${Math.min(S.grid.length,52)} / 52`;
    }

    function populateTimeZones(){
      if(tzSelect.options.length===0){
        let zones=[];
        try{ zones=Intl.supportedValuesOf('timeZone'); }catch{ zones=['UTC','Asia/Kolkata','Europe/London','America/New_York']; }
        const frag=document.createDocumentFragment();
        for(const z of ['UTC',...zones]){
          const opt=document.createElement('option'); opt.value=z; opt.textContent=z; frag.appendChild(opt);
        }
        tzSelect.appendChild(frag);
      }
      tzSelect.value=G.timeZone||'UTC';
    }

    function applyTimerTypeUI(){
      // show custom minutes input for custom or simple; lock message on custom
      customInputs.style.display = (G.timerType==='custom' || G.timerType==='simple') ? 'block' : 'none';
      const isCustom = (G.timerType==='custom');
      const {week,year}=isoWeekOf(nowInTZ());
      if(isCustom){
        // compute lock state
        const locked = !!S.customLocked && S.customLockWeek===S.week && S.customLockYear===S.year;
        customMinInput.disabled = locked;
        applyCustomBtn.disabled = locked;
        customLockMsg.textContent = locked
          ? `Custom minutes locked for ISO Week ${S.week}-${S.year}`
          : 'Can be set once per ISO week';
      }else{
        customLockMsg.textContent = '';
      }
      // show slider always for pomodoro and custom, hide for simple
      progressBlock.classList.toggle('hidden', G.timerType==='simple');
      setClockAndButtons();
      updateWeeklyTargetText();
      updateProgressUI();
    }

    function switchMode(toId){
      if(!toId || toId===currentMode) return;
      stopSession();
      currentMode=toId; G.selectedMode=toId; save(GLOBAL_KEY,G);
      S=loadState(currentMode);
      rolloverWeekIfNeeded();
      setClockAndButtons();
      applyTimerTypeUI();
      renderAll();
    }

    function saveAll(){ saveState(currentMode,S); save(GLOBAL_KEY,G); }

    // UI hooks
    startBtn.addEventListener('click', startSession);
    resetBtn.addEventListener('click', ()=>{ stopSession(); S.secondsLeft=getSessionSeconds(); setClockAndButtons(); saveAll(); });

    timerTypeSelect.addEventListener('change', ()=>{
      G.timerType=timerTypeSelect.value;
      if(G.timerType==='pomodoro') S.secondsLeft=POMODORO_SECONDS;
      setClockAndButtons();
      applyTimerTypeUI();
      saveAll();
    });

    applyCustomBtn.addEventListener('click', ()=>{
      // lock once per current ISO week
      rolloverWeekIfNeeded();
      if(S.customLocked && S.customLockWeek===S.week && S.customLockYear===S.year) return;
      const mins = Math.max(1, Math.floor(Number(customMinInput.value)||0));
      G.customSeconds = mins*60;
      S.customLocked=true; S.customLockWeek=S.week; S.customLockYear=S.year;
      S.secondsLeft=getSessionSeconds();
      setClockAndButtons();
      applyTimerTypeUI();
      saveAll();
    });

    lptSetBtn.addEventListener('click', ()=>{
      rolloverWeekIfNeeded();
      if(S.weeklyTargetLocked) return;
      const v = Math.max(1, Math.min(200, Math.floor(Number(lptInput.value)||1)));
      S.leavesPerTree=v;
      S.weeklyTargetLocked=true;
      S.weeklyTargetSetValue=v;
      S.placed=0;
      document.querySelector('#treeSVG #leafLayer').innerHTML='';
      updateWeeklyTargetText();
      updateProgressUI();
      saveAll();
      renderAll();
    });

    tzSelect.addEventListener('change', ()=>{ G.timeZone=tzSelect.value||'UTC'; save(GLOBAL_KEY,G); rolloverWeekIfNeeded(); renderAll(); });

    // Minimal tree leaves renderers (re-using previous helpers)
    const baseAnchors=[{x:280,y:250},{x:220,y:255},{x:350,y:250},{x:220,y:300},{x:340,y:300},{x:255,y:205},{x:340,y:205},{x:390,y:260},{x:190,y:260}];
    function anchorForIndex(i){
      if(i<baseAnchors.length) return baseAnchors[i];
      const k=i-baseAnchors.length+1, a=k*137.508*Math.PI/180, r=30+0.9*Math.sqrt(k)*8, cx=280, cy=260;
      return {x:cx+r*Math.cos(a), y:cy+r*Math.sin(a)*0.7};
    }
    function createLeafG(n){
      const g=document.createElementNS(svgns,'g'); g.setAttribute('filter','url(#leafShadow)');
      const p=document.createElementNS(svgns,'path'); p.setAttribute('d','M 0 -16 C 10 -10, 12 0, 0 14 C -12 0, -10 -10, 0 -16 Z');
      p.setAttribute('fill','#166534'); p.setAttribute('stroke','#0b3d22'); p.setAttribute('stroke-width','1.2');
      const t=document.createElementNS(svgns,'text'); t.setAttribute('x','0'); t.setAttribute('y','0'); t.setAttribute('fill','#fff'); t.setAttribute('font-weight','800'); t.setAttribute('font-size','13'); t.setAttribute('text-anchor','middle'); t.setAttribute('dominant-baseline','middle'); t.textContent=String(n);
      g.appendChild(p); g.appendChild(t); return g;
    }
    function placeLeaf(g,a){ g.setAttribute('transform',`translate(${a.x} ${a.y}) scale(1.05)`); }

    function renderLeaves(){
      const layer=document.querySelector('#treeSVG #leafLayer');
      layer.innerHTML='';
      for(let i=0;i<S.placed;i++){ const g=createLeafG(i+1); placeLeaf(g, anchorForIndex(i)); layer.appendChild(g); }
    }

    function renderAll(){
      renderLeaves();
      renderGrid();
      updateWeeklyTargetText();
      updateProgressUI();
      setClockAndButtons();
    }

    // Init
    if(!G.timeZone) G.timeZone='UTC';
    if(!G.selectedMode) G.selectedMode='maths';
    populateTimeZones();
    // Populate modes
    const modeSelect=document.getElementById('modeSelect');
    const ids=['exercise','cycling','digitalDetox','bedTime','quran','dikhr','maths','subject1','subject2','subject3','user1','user2','user3'];
    const frag=document.createDocumentFragment();
    for(const id of ids){
      const label=(CUSTOM_NAMES[id] && CUSTOM_NAMES[id].trim()) ? CUSTOM_NAMES[id] : (DEFAULT_MODE_NAMES[id]||id);
      const opt=document.createElement('option'); opt.value=id; opt.textContent=label; frag.appendChild(opt);
    }
    modeSelect.appendChild(frag);
    modeSelect.value=currentMode;
    modeSelect.addEventListener('change', ()=> switchMode(modeSelect.value) );
    if(modeNameEl){
      const label=(CUSTOM_NAMES[currentMode] && CUSTOM_NAMES[currentMode].trim()) ? CUSTOM_NAMES[currentMode] : (DEFAULT_MODE_NAMES[currentMode]||currentMode);
      modeNameEl.textContent=label.replace(/ mode$/i,'');
    }

    // Prepare UI per type
    timerTypeSelect.value=G.timerType;
    customMinInput.value=String(Math.max(1, Math.floor((G.customSeconds||900)/60)));
    rolloverWeekIfNeeded();
    applyTimerTypeUI();
    renderAll();
  </script>
</body>
</html>
