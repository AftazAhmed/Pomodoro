<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pomodoro Tree â€” Blink Leaf + Bedtime Silent</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#eaf3ff; --surface:#ffffff; --surface-2:#eef6ff; --line:#caddf8;
      --text:#0b1a33; --dim:#4a6894;
      --radius-lg:16px; --shadow:0 10px 28px rgba(30,70,140,.1);

      --btn-text:#ffffff; --btn-primary:#2563eb; --btn-success:#16a34a; --btn-danger:#ef4444;
      --btn-primary-hover:#1e40af; --btn-success-hover:#0f6a33; --btn-danger-hover:#b91c1c; --btn-neutral:#334155; --btn-neutral-hover:#1f2937; --btn-focus:#0ea5e9;

      --soil-top:#e8d0b0; --soil-deep:#caa879;
      --progress-green:#16a34a; --progress-red:#ef4444;

      --fs-xxl: 64px; --fs-lg: 20px; --fs-md: 15px; --fs-sm: 12px;
      --gap: 10px; --pad: 12px;
    }

    html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height:1.25; }

    .wrap{ max-width:980px; margin:0 auto; padding:16px 12px 72px; }
    header,.tzBar,.stats,.chip,.timerCard,.controls,.settings,.tabs,.tab,.panelCard,.gridWrap,.gridHead,.grid,.bottomAuth,.modesBar,.modeEditRow { display:flex; align-items:center; }

    header{ justify-content:space-between; gap:var(--gap); flex-wrap:wrap; }
    h1{ margin:0; font-size:var(--fs-lg); }
    .brand{ gap:10px; padding:8px 12px; border-radius:999px; background:linear-gradient(180deg,#f0f6ff,#ffffff); border:1px solid var(--line); }
    .modeTag{ font-weight:800; color:#14563a; font-size:var(--fs-md); }

    .timerCard{ background:#fff; border:1px solid var(--line); border-radius:var(--radius-lg); padding:var(--pad); box-shadow:var(--shadow); flex-direction:column; width:100%; }
    .time{ font-size:var(--fs-xxl); font-weight:800; color:#0e2a70; text-align:center; }
    .controls{ gap:8px; margin-top:8px; flex-wrap:wrap; justify-content:center; }
    button{
      border:none; padding:10px 12px; border-radius:12px; font-weight:800; cursor:pointer; color:#fff; background:var(--btn-neutral);
      box-shadow:0 1px 0 rgba(0,0,0,.06), 0 6px 14px rgba(15,23,42,.14);
      transition:background-color .18s ease, transform .08s ease, box-shadow .18s ease; border:1px solid rgba(255,255,255,.06); font-size:var(--fs-md);
    }
    button:hover{ background:var(--btn-neutral-hover); }
    button:active{ transform:translateY(1px); }
    button:focus-visible{ outline:3px solid var(--btn-focus); outline-offset:2px; }
    #startBtn{ background:var(--btn-success); } #startBtn:hover{ background:var(--btn-success-hover); }
    #resetBtn{ background:var(--btn-danger); } #resetBtn:hover{ background:var(--btn-danger-hover); }
    #lptSetBtn{ background:var(--btn-primary); } #lptSetBtn:hover{ background:var(--btn-primary-hover); }

    .settings{ gap:10px; margin-top:8px; flex-wrap:wrap; justify-content:center; color:var(--dim); flex-direction:column; align-items:center; }
    .numWrap{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:center; }
    .numWrap input{ width:96px; padding:8px 10px; border-radius:12px; border:1px solid var(--line); text-align:center; font-weight:800; font-size:var(--fs-md); }
    .miniNote{ color:#4a6894; font-weight:700; font-size:var(--fs-sm); }
    .noteBig{ font-size:var(--fs-md); color:#0b1a33; font-weight:800; }

    .canvas{
      position:relative;
      width:100%;
      max-width:560px;
      margin:10px auto;
      isolation:isolate;
    }
    .canvas .aspect{
      position:relative;
      width:100%;
      height:0;
      padding-bottom:100%;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:14px;
      background:#cfe8ff;
    }

    .skySvg{ position:absolute; inset:0; width:100%; height:100%; display:block; }

    .treeSvg{
      position:absolute; inset:0; width:100%; height:100%;
      display:block; overflow:visible; pointer-events:none;
      transform-origin: 50% 72%;
      transform: scale(1.5);
    }

    .xyLabel{
      position:absolute; left:10px; top:10px;
      font:900 18px/1 Inter, system-ui; color:#0b1a33; text-shadow:0 2px 0 rgba(255,255,255,.65); pointer-events:none; z-index:5;
    }
    .todaySky{
      position:absolute; right:10px; top:10px;
      font:800 16px/1 Inter, system-ui; color:#14563a; text-shadow:0 2px 0 rgba(255,255,255,.65); pointer-events:none; z-index:5;
      background:rgba(255,255,255,.55); padding:3px 8px; border-radius:10px; border:1px solid rgba(200,216,238,.8);
    }

    .rain{ position:absolute; top:0; right:0; bottom:0; left:0; pointer-events:none; display:none; z-index:4; }
    .rain .drop{
      position:absolute; left:0; width:2px; height:16px; background:rgba(14,42,112,.6); border-radius:1px;
      top:-10%; animation:rainTop 0.8s linear infinite;
    }
    .rain .drop.far{ opacity:.7; transform:scale(0.9); animation-duration:1.2s; }
    @keyframes rainTop{ 0%{ top:-10%; } 100%{ top:110%; } }

    .tzBar{ gap:10px; padding:10px 12px; border-radius:14px; background:#fff; border:1px solid var(--line); box-shadow:var(--shadow); justify-content:space-between; flex-wrap:wrap; margin-top:12px; }
    .countryWrap{ display:flex; gap:8px; align-items:center; }
    .countryWrap input{ padding:8px 10px; border-radius:12px; border:1px solid var(--line); font-weight:700; min-width:220px; font-size:var(--fs-md); }
    .stats{ gap:8px; flex-wrap:wrap; }
    .chip{ gap:8px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid var(--line); color:#4a6894; font-size:var(--fs-sm); }

    .tabsWrap{ margin:12px auto; max-width:980px; background:#fff; border:1px solid var(--line); border-radius:var(--radius-lg); box-shadow:var(--shadow); padding:var(--pad); }
    .tabs{ gap:6px; flex-wrap:wrap; padding:6px; border:1px solid var(--line); border-radius:999px; background:var(--surface-2); }
    .tab{ gap:6px; padding:6px 10px; border-radius:999px; cursor:pointer; color:#4a6894; font-size:var(--fs-sm); }
    .tab.active{ color:#0b1a33; background:linear-gradient(180deg,#e6f1ff,#ffffff); }
    .panelCard{ display:none; margin-top:10px; background:#fff; border:1px solid var(--line); border-radius:var(--radius-lg); padding:var(--pad); gap:8px; flex-wrap:wrap; }

    .modesBar{ gap:8px; padding:10px; border-radius:14px; background:#fff; border:1px solid var(--line); box-shadow:var(--shadow); justify-content:space-between; flex-wrap:wrap; margin:0; width:100%; }
    .modesBar select{ padding:8px 10px; border-radius:12px; border:1px solid var(--line); font-weight:800; color:#0b1a33; min-width:220px; font-size:var(--fs-md); }
    .modeEditRow{ gap:8px; flex-wrap:wrap; }
    .modeEditRow .editGroup{ display:flex; align-items:center; gap:6px; background:#f8fbff; border:1px solid var(--line); padding:6px 8px; border-radius:10px; }
    .modeEditRow input{ padding:6px 8px; border-radius:8px; border:1px solid var(--line); font-weight:700; min-width:140px; font-size:var(--fs-md); }
    .modeNote{ color:#4a6894; font-weight:700; flex-basis:100%; font-size:var(--fs-sm); }

    .gridWrap{ margin:12px auto; max-width:980px; background:#fff; border:1px solid var(--line); border-radius:var(--radius-lg); box-shadow:var(--shadow); padding:var(--pad); flex-direction:column; }
    .gridHead{ justify-content:space-between; gap:8px; color:#4a6894; width:100%; }
    .grid{ display:grid; gap:8px; grid-template-columns:repeat(8, minmax(0, 1fr)); width:100%; margin-top:8px; }
    .cell{ position:relative; aspect-ratio:1/1; border-radius:12px; background:#f3f8ff; border:1px dashed #c8d8ee; color:#4e6ea0; display:flex; align-items:center; justify-content:center; font-weight:800; overflow:hidden; font-size:var(--fs-md); }
    .num{ position:relative; z-index:1; color:#4e6ea0; }
    .icon{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:20px; z-index:2; pointer-events:none; }
    .cell.live{ background:linear-gradient(180deg,#e9fff1,#ffffff); border:2px solid #16a34a; color:#14563a; }

    .indicator{ display:flex; width:220px; height:12px; border-radius:999px; overflow:hidden; border:1px solid var(--line); background:#fff; }
    .indicator .done{ background:var(--progress-green); height:100%; transition:width .25s steps(1, start); }
    .indicator .rem{ background:var(--progress-red); height:100%; transition:width .25s steps(1, start); }

    @keyframes leafBlink { 0%,49%{ fill:#166534;} 50%,100%{ fill:#28a745;} }
    .animate-leaf path{ animation: leafBlink 0.9s steps(1, start) infinite; }

    @keyframes canopyBlink { 0%,100%{ stroke:#065f46;} 50%{ stroke:#000; } }
    .blink-canopy{ animation: canopyBlink 900ms linear infinite; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><span style="font-weight:800;">ðŸŒ³</span><h1>Pomodoro Tree</h1></div>
      <div class="modeTag">Mode: <span id="modeName">Study</span></div>
    </header>

    <section class="timerCard">
      <div class="time" id="clock">25:00</div>
      <div class="controls">
        <button id="startBtn">Start 25:00</button>
        <button id="resetBtn">Reset</button>
      </div>

      <div class="settings">
        <div class="numWrap" style="order:-2;">
          <label class="miniNote" for="timerType">Timer type</label>
          <select id="timerType">
            <option value="pomodoro">Pomodoro</option>
            <option value="custom">Custom</option>
          </select>
          <div id="customTimeRow" class="numWrap" style="display:none;">
            <label class="miniNote" for="customMinutes">Min</label>
            <input id="customMinutes" type="number" min="1" max="180" step="1" value="20" />
            <label class="miniNote" for="customSeconds">Sec</label>
            <input id="customSeconds" type="number" min="0" max="59" step="1" value="0" />
            <button id="applyCustomBtn">Apply</button>
          </div>
        </div>

        <div class="numWrap" style="order:1;">
          <label for="lptInput" class="noteBig"><strong>LPT = No. of timer session per week</strong></label>
          <input id="lptInput" type="number" min="1" max="200" step="1" value="9" />
          <button id="lptSetBtn">Set</button>
          <span id="lockHint" class="miniNote">LPT (LEAF PER TREE) <br> locks after first entry every week</span>
        </div>

        <div class="numWrap" style="order:2;">
          <div class="indicator" aria-label="Progress">
            <div id="indDone" class="done" style="width:0%"></div>
            <div id="indRem" class="rem" style="width:100%"></div>
          </div>
          <span id="lptVal">9</span>
        </div>

        <div id="customWeekTotal" class="miniNote" style="display:none; order:3;">Total duration (week): 0 hrs 0 mins</div>
        <div id="weeklyTarget" class="miniNote" style="order:3;">Weekly target = 225 mins (as per LPT Ã— 25)</div>
      </div>
    </section>

    <section class="canvas" id="canvas">
      <div class="aspect">
        <svg class="skySvg" viewBox="0 0 560 560" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
          <defs>
            <linearGradient id="gradSky" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#cfe8ff"/>
              <stop offset="100%" stop-color="#8ec5ff"/>
            </linearGradient>
          </defs>
          <rect x="0" y="0" width="560" height="347.2" fill="url(#gradSky)"/>
          <rect x="0" y="347.2" width="560" height="60" fill="#e8d0b0"/>
          <rect x="0" y="407.2" width="560" height="152.8" fill="#caa879"/>
          <g id="saplings" stroke="#2f6f3a" stroke-width="2" fill="none" stroke-linecap="round"></g>
        </svg>

        <div id="xyLabel" class="xyLabel">0/9 leaves (week)</div>
        <div id="todaySky" class="todaySky">Today: 0 leaves</div>
        <div id="rainLayer" class="rain"></div>

        <svg id="treeSVG" class="treeSvg" viewBox="0 0 560 410" preserveAspectRatio="xMidYMid meet">
          <defs>
            <filter id="leafShadow" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="1" stdDeviation="1.0" flood-color="#000" flood-opacity="0.15" />
            </filter>
            <mask id="fillMask" maskUnits="userSpaceOnUse" x="100" y="150" width="380" height="220">
              <rect fill="#000" x="100" y="150" width="380" height="220"/>
              <rect id="fillRect" x="110" y="316" width="360" height="0" fill="#fff"/>
            </mask>
            <linearGradient id="canopyBaseDarker" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#a3e3b5" />
              <stop offset="100%" stop-color="#7fce9d" />
            </linearGradient>
          </defs>

          <g id="canopyGroup" transform="translate(280 280) scale(1,1.2) translate(-280 -280)">
            <path id="canopyWhite" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="url(#canopyBaseDarker)"/>
            <path id="canopyFillGreen" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="#3aa85f" mask="url(#fillMask)"/>
            <path id="canopyOutline" d="M 130 210 C 160 172, 205 158, 235 172 C 255 152, 275 150, 295 165 C 315 150, 335 152, 345 172 C 365 158, 410 170, 430 210 C 446 236, 454 260, 430 284 C 405 306, 360 314, 340 304 C 312 322, 248 322, 220 304 C 195 314, 150 306, 130 284 C 110 262, 112 232, 130 210 Z" fill="transparent" stroke="#065f46" stroke-width="3" />
            <path d="M 280 380 C 280 350, 280 320, 280 284" fill="none" stroke="#4e342e" stroke-width="32" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M 280 284 C 270 270, 258 255, 248 238" fill="none" stroke="#4e342e" stroke-width="24" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M 280 284 C 290 270, 302 255, 312 238" fill="none" stroke="#4e342e" stroke-width="24" stroke-linecap="round" stroke-linejoin="round" />
            <g id="leafLayer" filter="url(#leafShadow)"></g>
          </g>
        </svg>
      </div>
    </section>

    <div class="tzBar">
      <div class="countryWrap">
        <label for="countryInput" class="miniNote">Country</label>
        <input id="countryInput" list="countryList" placeholder="Type country name (e.g., India)" />
        <datalist id="countryList"></datalist>
        <span id="tzLabel" class="miniNote">TZ: Asia/Kolkata</span>
      </div>
      <div class="stats">
        <div class="chip" id="todayChip"><strong>Total hrs (week)</strong>: 0 hrs 0 mins</div>
        <div class="chip" id="totalTimeChip"><strong>Total hrs (overall)</strong>: 0 hrs 0 mins</div>
      </div>
    </div>

    <section class="tabsWrap">
      <div class="tabs">
        <div class="tab" data-tab="subPanel">Subscription</div>
        <div class="tab" data-tab="syncPanel">Sync</div>
        <div class="tab active" data-tab="modesPanel">Modes</div>
      </div>

      <div id="subPanel" class="panelCard">
        <div id="subStatus" class="miniNote">Plan: Free â€” 4 weeks cap. Unlock remaining 48 weeks for $1/year.</div>
        <button id="subBtn">Unlock 48 weeks â€” $1</button>
      </div>

      <div id="syncPanel" class="panelCard">
        <div id="authState" class="miniNote">Signed out</div>
        <input type="email" id="emailInput" placeholder="email@example.com" />
        <button id="sendLinkBtn">Send sign-in link</button>
        <button id="signOutBtn">Sign out</button>
      </div>

      <div id="modesPanel" class="panelCard" style="display:flex;">
        <div class="modesBar">
          <div class="modeEditRow" style="flex-basis:100%;">
            <label for="modeSelect" class="modeNote">Mode</label>
            <select id="modeSelect" title="Switch mode"></select>
          </div>
          <div class="modeEditRow" id="editableNamesRow">
            <div class="editGroup"><span class="miniNote">Subject 1</span><input id="subject1Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span class="miniNote">Subject 2</span><input id="subject2Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span class="miniNote">Subject 3</span><input id="subject3Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span class="miniNote">User 1</span><input id="user1Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span class="miniNote">User 2</span><input id="user2Input" placeholder="Edit name" /></div>
            <div class="editGroup"><span class="miniNote">User 3</span><input id="user3Input" placeholder="Edit name" /></div>
            <button id="saveNamesBtn">Save names</button>
          </div>
        </div>
      </div>
    </section>

    <section class="gridWrap">
      <div class="gridHead">
        <div class="chip">Completed Trees (Week Numbers)</div>
        <div class="chip" id="gridCount">0 / 52</div>
      </div>
      <div class="grid" id="treeGrid"></div>
    </section>

    <div class="bottomAuth" style="gap:8px;">
      <input type="email" id="emailInputBottom" placeholder="email@example.com" />
      <button id="sendLinkBtnBottom">Sign in</button>
      <button id="signOutBtnBottom">Sign out</button>
    </div>
  </div>

  <script>
    // Keys and constants
    const APP_KEY = 'pomodoroTree_BlinkLeaf_BedtimeSilent_V1';
    const NAMES_KEY = APP_KEY + '_names';
    const GLOBAL_KEY = APP_KEY + '_global';
    const svgns = 'http://www.w3.org/2000/svg';

    const LEAF_SECONDS = 60;
    const POMODORO_SECONDS = 25*60;
    const DEFAULT_CUSTOM_MIN = 20;
    const MAX_CUSTOM_MIN = 180;

    const PRESET_MODES = ['cycling','exercise','quran','dhikr','digitalDetox','bedTime'];
    const MODE_IDS = [...PRESET_MODES, 'maths','subject1','subject2','subject3','user1','user2','user3'];

    const DEFAULT_MODE_NAMES = {
      cycling:'Cycling mode', exercise:'Exercise mode', quran:'Quran mode', dhikr:'Dhikr mode',
      digitalDetox:'Digital detox mode', bedTime:'Bedtime mode', maths:'Maths mode',
      subject1:'Subject 1 mode', subject2:'Subject 2 mode', subject3:'Subject 3 mode',
      user1:'User 1 mode', user2:'User 2 mode', user3:'User 3 mode'
    };

    // Comprehensive Country to timezone mapping
    const COUNTRY_TIMEZONES = {
      'Afghanistan': 'Asia/Kabul',
      'Albania': 'Europe/Tirane',
      'Algeria': 'Africa/Algiers',
      'Argentina': 'America/Argentina/Buenos_Aires',
      'Armenia': 'Asia/Yerevan',
      'Australia': 'Australia/Sydney',
      'Austria': 'Europe/Vienna',
      'Azerbaijan': 'Asia/Baku',
      'Bahrain': 'Asia/Bahrain',
      'Bangladesh': 'Asia/Dhaka',
      'Belarus': 'Europe/Minsk',
      'Belgium': 'Europe/Brussels',
      'Bolivia': 'America/La_Paz',
      'Bosnia and Herzegovina': 'Europe/Sarajevo',
      'Brazil': 'America/Sao_Paulo',
      'Bulgaria': 'Europe/Sofia',
      'Cambodia': 'Asia/Phnom_Penh',
      'Canada': 'America/Toronto',
      'Chile': 'America/Santiago',
      'China': 'Asia/Shanghai',
      'Colombia': 'America/Bogota',
      'Costa Rica': 'America/Costa_Rica',
      'Croatia': 'Europe/Zagreb',
      'Cuba': 'America/Havana',
      'Cyprus': 'Asia/Nicosia',
      'Czech Republic': 'Europe/Prague',
      'Denmark': 'Europe/Copenhagen',
      'Ecuador': 'America/Guayaquil',
      'Egypt': 'Africa/Cairo',
      'Estonia': 'Europe/Tallinn',
      'Ethiopia': 'Africa/Addis_Ababa',
      'Finland': 'Europe/Helsinki',
      'France': 'Europe/Paris',
      'Georgia': 'Asia/Tbilisi',
      'Germany': 'Europe/Berlin',
      'Ghana': 'Africa/Accra',
      'Greece': 'Europe/Athens',
      'Guatemala': 'America/Guatemala',
      'Honduras': 'America/Tegucigalpa',
      'Hong Kong': 'Asia/Hong_Kong',
      'Hungary': 'Europe/Budapest',
      'Iceland': 'Atlantic/Reykjavik',
      'India': 'Asia/Kolkata',
      'Indonesia': 'Asia/Jakarta',
      'Iran': 'Asia/Tehran',
      'Iraq': 'Asia/Baghdad',
      'Ireland': 'Europe/Dublin',
      'Israel': 'Asia/Jerusalem',
      'Italy': 'Europe/Rome',
      'Jamaica': 'America/Jamaica',
      'Japan': 'Asia/Tokyo',
      'Jordan': 'Asia/Amman',
      'Kazakhstan': 'Asia/Almaty',
      'Kenya': 'Africa/Nairobi',
      'Kuwait': 'Asia/Kuwait',
      'Latvia': 'Europe/Riga',
      'Lebanon': 'Asia/Beirut',
      'Lithuania': 'Europe/Vilnius',
      'Luxembourg': 'Europe/Luxembourg',
      'Malaysia': 'Asia/Kuala_Lumpur',
      'Mexico': 'America/Mexico_City',
      'Mongolia': 'Asia/Ulaanbaatar',
      'Morocco': 'Africa/Casablanca',
      'Nepal': 'Asia/Kathmandu',
      'Netherlands': 'Europe/Amsterdam',
      'New Zealand': 'Pacific/Auckland',
      'Nigeria': 'Africa/Lagos',
      'North Korea': 'Asia/Pyongyang',
      'Norway': 'Europe/Oslo',
      'Oman': 'Asia/Muscat',
      'Pakistan': 'Asia/Karachi',
      'Panama': 'America/Panama',
      'Peru': 'America/Lima',
      'Philippines': 'Asia/Manila',
      'Poland': 'Europe/Warsaw',
      'Portugal': 'Europe/Lisbon',
      'Qatar': 'Asia/Qatar',
      'Romania': 'Europe/Bucharest',
      'Russia': 'Europe/Moscow',
      'Saudi Arabia': 'Asia/Riyadh',
      'Serbia': 'Europe/Belgrade',
      'Singapore': 'Asia/Singapore',
      'Slovakia': 'Europe/Bratislava',
      'Slovenia': 'Europe/Ljubljana',
      'South Africa': 'Africa/Johannesburg',
      'South Korea': 'Asia/Seoul',
      'Spain': 'Europe/Madrid',
      'Sri Lanka': 'Asia/Colombo',
      'Sweden': 'Europe/Stockholm',
      'Switzerland': 'Europe/Zurich',
      'Syria': 'Asia/Damascus',
      'Taiwan': 'Asia/Taipei',
      'Thailand': 'Asia/Bangkok',
      'Tunisia': 'Africa/Tunis',
      'Turkey': 'Europe/Istanbul',
      'UAE': 'Asia/Dubai',
      'Ukraine': 'Europe/Kiev',
      'United Kingdom': 'Europe/London',
      'United States': 'America/New_York',
      'USA': 'America/New_York',
      'US': 'America/New_York',
      'America': 'America/New_York',
      'Uruguay': 'America/Montevideo',
      'Uzbekistan': 'Asia/Tashkent',
      'Venezuela': 'America/Caracas',
      'Vietnam': 'Asia/Ho_Chi_Minh'
    };

    // Global + names
    const loadGlobal = () => JSON.parse(localStorage.getItem(GLOBAL_KEY) || '{}');
    const G = Object.assign({ timeZone:'Asia/Kolkata', selectedMode:'maths', country:'India' }, loadGlobal());
    const NAMES = JSON.parse(localStorage.getItem(NAMES_KEY) || '{}');
    const saveGlobal = ()=>localStorage.setItem(GLOBAL_KEY, JSON.stringify(G));
    const saveNames = ()=>localStorage.setItem(NAMES_KEY, JSON.stringify(NAMES));

    // Mode state helpers
    const modeKey = (modeId)=> `${APP_KEY}_mode_${modeId}`;
    const DEFAULT_STATE = {
      leavesPerTree:9, 
      completedLeaves:0, // Tracks completed (static) leaves
      timers: {
        pomodoro: { secondsLeft:POMODORO_SECONDS, running:false, weeklySeconds:0, totalSeconds:0 },
        custom:   { secondsLeft:DEFAULT_CUSTOM_MIN*60, running:false, weeklySeconds:0, totalSeconds:0, sessionSeconds:DEFAULT_CUSTOM_MIN*60 }
      },
      activeTimer:'pomodoro',
      weeklyLeaves:0, leavesToday:0, leavesTotal:0,
      weeklyFocusSeconds:0, totalFocusSeconds:0,
      grid:[], week:undefined, year:undefined, weeklyComplete:false,
      weeklyTargetLocked:false, weeklyTargetSetValue:9
    };

    function loadState(modeId){
      const raw = localStorage.getItem(modeKey(modeId));
      try{ return Object.assign({}, DEFAULT_STATE, raw? JSON.parse(raw): {}); }
      catch{ return Object.assign({}, DEFAULT_STATE); }
    }
    function saveState(modeId, S){ localStorage.setItem(modeKey(modeId), JSON.stringify(S)); }
    function save(){ saveState(currentMode, S); saveGlobal(); }

    let currentMode = G.selectedMode || 'maths';
    let S = loadState(currentMode);

    const intervals = { pomodoro:null, custom:null };

    // DOM
    const el=id=>document.getElementById(id);
    const clockEl=el('clock'), startBtn=el('startBtn'), resetBtn=el('resetBtn');
    const timerTypeSel=el('timerType'), customTimeRow=el('customTimeRow'), customMinutes=el('customMinutes'), customSecondsEl=el('customSeconds'), applyCustomBtn=el('applyCustomBtn');
    const lptInput=el('lptInput'), lptSetBtn=el('lptSetBtn'), lptVal=el('lptVal'), lockHint=el('lockHint');
    const weeklyTargetEl=el('weeklyTarget'), customWeekTotalEl=el('customWeekTotal');
    const indDone=el('indDone'), indRem=el('indRem');
    const todayChip=el('todayChip'), totalTimeChip=el('totalTimeChip');
    const xyLabel=el('xyLabel'), rainLayer=el('rainLayer'), treeGrid=el('treeGrid'), gridCount=el('gridCount');
    const leafLayer=document.querySelector('#treeSVG #leafLayer'), fillRect=document.getElementById('fillRect'), todaySky=el('todaySky'), modeNameEl=document.getElementById('modeName');
    const modeSelect=el('modeSelect'), countryInput=el('countryInput'), countryList=el('countryList'), tzLabel=el('tzLabel');

    // Build saplings once
    (function buildSaplings(){
      const g=document.getElementById('saplings'); if(!g) return;
      const rows=6, cols=7, startX=28, endX=532, soilYStart=560*0.62 + 20, rowGap=30;
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const jitterX = (Math.random()*4-2), jitterY = (Math.random()*3-1.5);
          const x = Math.round(startX + c * ((endX - startX)/(cols-1)) + jitterX);
          const y = Math.round(soilYStart + r*rowGap + jitterY);
          const bend = (Math.random()*8-4);

          const stem = document.createElementNS(svgns,'path');
          stem.setAttribute('d', `M ${x} ${y} Q ${x + bend} ${y-11}, ${x} ${y-22}`);
          stem.setAttribute('stroke','#2f6f3a'); stem.setAttribute('stroke-width','2'); stem.setAttribute('fill','none'); stem.setAttribute('stroke-linecap','round');

          const leftLeaf = document.createElementNS(svgns,'path');
          leftLeaf.setAttribute('d', `M ${x} ${y-18} q -9 -5, -14 -12`);
          leftLeaf.setAttribute('stroke','#2f6f3a'); leftLeaf.setAttribute('stroke-width','2'); leftLeaf.setAttribute('fill','none'); leftLeaf.setAttribute('stroke-linecap','round');

          const rightLeaf = document.createElementNS(svgns,'path');
          rightLeaf.setAttribute('d', `M ${x} ${y-18} q 8 -3, 13 -9`);
          rightLeaf.setAttribute('stroke','#2f6f3a'); rightLeaf.setAttribute('stroke-width','2'); rightLeaf.setAttribute('fill','none'); rightLeaf.setAttribute('stroke-linecap','round');

          const seed = document.createElementNS(svgns,'circle');
          seed.setAttribute('cx', String(x)); seed.setAttribute('cy', String(y)); seed.setAttribute('r','1.7'); seed.setAttribute('fill','#2f6f3a');

          g.appendChild(stem); g.appendChild(leftLeaf); g.appendChild(rightLeaf); g.appendChild(seed);
        }
      }
    })();

    // Populate country list
    function populateCountryList() {
      countryList.innerHTML = '';
      Object.keys(COUNTRY_TIMEZONES).forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        countryList.appendChild(option);
      });
    }

    // Country selection handler
    countryInput.addEventListener('input', () => {
      const selectedCountry = countryInput.value;
      if (COUNTRY_TIMEZONES[selectedCountry]) {
        G.country = selectedCountry;
        G.timeZone = COUNTRY_TIMEZONES[selectedCountry];
        tzLabel.textContent = `TZ: ${G.timeZone}`;
        saveGlobal();
      }
    });

    // ISO Week calculation with timezone support
    function isoWeekYear(date=new Date()){
      try {
        const tzDate = new Date(date.toLocaleString("en-US", {timeZone: G.timeZone}));
        const d=new Date(Date.UTC(tzDate.getFullYear(),tzDate.getMonth(),tzDate.getDate()));
        const dayNum = d.getUTCDay()||7;
        d.setUTCDate(d.getUTCDate()+4-dayNum);
        const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
        const week = Math.ceil((((d - yearStart)/86400000)+1)/7);
        return {week, year:d.getUTCFullYear()};
      } catch(e) {
        // Fallback to UTC if timezone fails
        const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate()));
        const dayNum = d.getUTCDay()||7;
        d.setUTCDate(d.getUTCDate()+4-dayNum);
        const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
        const week = Math.ceil((((d - yearStart)/86400000)+1)/7);
        return {week, year:d.getUTCFullYear()};
      }
    }

    function format(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}`; }

    function startWallClock(timerId){
      stopTimer(timerId);
      const tState = S.timers[timerId];
      const targetEpoch = Date.now() + (tState.secondsLeft * 1000);
      const tick = ()=>{
        const remainingMs = Math.max(0, targetEpoch - Date.now());
        tState.secondsLeft = Math.ceil(remainingMs / 1000);
        if(S.activeTimer===timerId) clockEl.textContent = format(tState.secondsLeft);
        if(remainingMs <= 0){ stopTimer(timerId); onSessionComplete(timerId); }
      };
      setRunning(timerId, true);
      intervals[timerId] = setInterval(tick, 250);
      tick();
    }
    function stopTimer(timerId){ if(intervals[timerId]){ clearInterval(intervals[timerId]); intervals[timerId]=null; } setRunning(timerId, false); }

    function getSessionSecondsFor(timerId){ return timerId==='pomodoro' ? POMODORO_SECONDS : Math.max(1, S.timers.custom.sessionSeconds|0); }

    const baseAnchors=[{x:280,y:250},{x:220,y:255},{x:350,y:250},{x:220,y:300},{x:340,y:300},{x:255,y:205},{x:340,y:205},{x:390,y:260},{x:190,y:260}];
    function anchorForIndex(i){
      if(i<baseAnchors.length) return baseAnchors[i];
      const k=i-baseAnchors.length+1, a=k*137.508*Math.PI/180, r=30+0.9*Math.sqrt(k)*8, cx=280, cy=260;
      return {x:cx+r*Math.cos(a), y:cy+r*Math.sin(a)*0.7};
    }

    function createLeafG(n){
      const g=document.createElementNS(svgns,'g'); g.setAttribute('filter','url(#leafShadow)');
      const p=document.createElementNS(svgns,'path');
      p.setAttribute('d','M 0 -16 C 10 -10, 12 0, 0 14 C -12 0, -10 -10, 0 -16 Z');
      p.setAttribute('fill','#166534'); p.setAttribute('stroke','#0b3d22'); p.setAttribute('stroke-width','1.2');
      const t=document.createElementNS(svgns,'text');
      t.setAttribute('x','0'); t.setAttribute('y','0');
      t.setAttribute('text-anchor','middle'); t.setAttribute('dominant-baseline','central');
      t.style.fontWeight='800'; t.style.fontSize='12px'; t.style.fill='#ffffff';
      t.textContent=String(n);
      g.appendChild(p); g.appendChild(t); return g;
    }

    function placeLeaf(g,a){ g.setAttribute('transform',`translate(${a.x} ${a.y}) scale(1.05)`); }

    // FIXED LEAF LOGIC: Perfect implementation as per instructions
    function updateLeafDisplay(){
      if(!leafLayer) return;
      
      // Clear all leaves first
      leafLayer.innerHTML='';
      
      // Step 1: Render all completed (static) leaves
      for(let i=0; i < S.completedLeaves; i++){ 
        const g = createLeafG(i + 1); 
        placeLeaf(g, anchorForIndex(i)); 
        leafLayer.appendChild(g); 
      }
      
      // Step 2: If timer is running, show current leaf (next one) and make it blink
      const isRunning = S.timers[S.activeTimer].running;
      if(isRunning) {
        const currentLeafNumber = S.completedLeaves + 1;
        const g = createLeafG(currentLeafNumber);
        placeLeaf(g, anchorForIndex(S.completedLeaves));
        g.classList.add('animate-leaf'); // Make it blink
        leafLayer.appendChild(g);
      }
    }

    const CANOPY_BOTTOM=316, FILL_OVERSCAN=165;
    function setFillPercent(pct){
      const p=Math.max(0, Math.min(100, Number(pct)||0));
      const targetH=FILL_OVERSCAN*(p/100);
      const targetY=CANOPY_BOTTOM-targetH;
      fillRect.setAttribute('x','110'); fillRect.setAttribute('width','360');
      fillRect.setAttribute('y', String(targetY)); fillRect.setAttribute('height', String(targetH));
    }

    function percentFromState(){ 
      const denom = Math.max(1, S.leavesPerTree|0); 
      return (S.completedLeaves / denom) * 100; 
    }
    function applyProgress(){ const p=S.weeklyComplete?100:percentFromState(); setFillPercent(p); }

    // Update all UI elements with proper leaf counts
    function updateAllUI() {
      paintIndicator();
      renderTotals();
      applyProgress();
      buildGrid();
      updateLeafDisplay();
      save();
    }

    // Paint indicator with correct completed leaves count
    function paintIndicator(){
      const total = Math.max(1, Number(S.leavesPerTree)||1);
      const done = Math.max(0, S.completedLeaves);
      const pct = (done/total)*100;
      indDone.style.width = pct + '%';
      indRem.style.width = (100 - pct) + '%';
      // Allow x > y display when LPT is exceeded
      xyLabel.textContent = `${done}/${total} leaves (week)`;
    }

    function formatTimeHM(sec){ const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); return {h,m}; }

    function renderTotals(){
      const w=formatTimeHM(S.weeklyFocusSeconds||0), o=formatTimeHM(S.totalFocusSeconds||0);
      todayChip.innerHTML = `<strong>Total hrs (week)</strong>: ${w.h} hrs ${w.m} mins`;
      totalTimeChip.innerHTML = `<strong>Total hrs (overall)</strong>: ${o.h} hrs ${o.m} mins`;
      todaySky.textContent = `Today: ${S.leavesToday||0} leaves`;
    }

    function setRunning(timerId, on){
      S.timers[timerId].running = on;
      if(S.activeTimer===timerId){
        startBtn.textContent = on ? 'Runningâ€¦' : `Start ${format(S.timers[timerId].secondsLeft)}`;
        startBtn.disabled = !!on;
        document.getElementById('canopyOutline')?.classList.toggle('blink-canopy', !!on);
        updateLeafDisplay(); // Update leaf display based on running state
        showRain(!!on);
      }
      save();
    }

    // Rain functions
    function createRainDrop() {
      const drop = document.createElement('div');
      drop.className = 'drop' + (Math.random() > 0.5 ? ' far' : '');
      drop.style.left = Math.random() * 100 + '%';
      drop.style.animationDelay = Math.random() * 2 + 's';
      return drop;
    }

    function showRain(show) {
      if (show) {
        rainLayer.style.display = 'block';
        rainLayer.innerHTML = '';
        for (let i = 0; i < 80; i++) {
          rainLayer.appendChild(createRainDrop());
        }
      } else {
        rainLayer.style.display = 'none';
        rainLayer.innerHTML = '';
      }
    }

    // Alarm: silent in Bedtime mode
    function playAlarmIfAllowed(){
      if(currentMode==='bedTime') return;
      try{
        const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return;
        const ctx = new AC();
        const now = ctx.currentTime;
        const master = ctx.createGain(); master.gain.setValueAtTime(0.0001, now); master.gain.linearRampToValueAtTime(0.9, now + 0.03);
        master.gain.setValueAtTime(0.9, now + 9.7); master.gain.linearRampToValueAtTime(0.0001, now + 10.0); master.connect(ctx.destination);
        const oscA = ctx.createOscillator(); oscA.type='square'; oscA.frequency.setValueAtTime(880, now);
        const oscB = ctx.createOscillator(); oscB.type='sawtooth'; oscB.frequency.setValueAtTime(440, now);
        const trem = ctx.createOscillator(); trem.type='sine'; trem.frequency.setValueAtTime(6, now);
        const tremGain = ctx.createGain(); tremGain.gain.setValueAtTime(0.5, now);
        trem.connect(tremGain); tremGain.connect(master.gain); oscA.connect(master); oscB.connect(master);
        trem.start(now); oscA.start(now); oscB.start(now); oscA.stop(now + 10.1); oscB.stop(now + 10.1); trem.stop(now + 10.1);
      }catch(e){}
    }

    // FIXED: Session completion with proper leaf management
    function onSessionComplete(timerId){
      const {week, year} = isoWeekYear(new Date());
      if(!S.week){ S.week=week; S.year=year; }
      if(S.week!==week || S.year!==year){
        // New week - reset weekly counters but keep timer functionality
        S.week=week; S.year=year;
        S.weeklyTargetLocked=false;
        S.weeklyLeaves=0;
        S.leavesToday=0;
        S.weeklyFocusSeconds=0;
        S.completedLeaves=0; // Reset completed leaves for new week
        S.weeklyComplete=false;
      }
      if(!S.weeklyTargetLocked){ S.weeklyTargetLocked=true; S.weeklyTargetSetValue=S.leavesPerTree; }

      playAlarmIfAllowed();

      // Update time tracking
      if(timerId==='pomodoro'){
        S.timers.pomodoro.weeklySeconds += POMODORO_SECONDS;
        S.timers.pomodoro.totalSeconds  += POMODORO_SECONDS;
      }else{
        const used = S.timers.custom.sessionSeconds||DEFAULT_CUSTOM_MIN*60;
        S.timers.custom.weeklySeconds += used;
        S.timers.custom.totalSeconds  += used;
      }

      // Update focus time and leaf counts
      S.weeklyFocusSeconds = (S.weeklyFocusSeconds||0) + LEAF_SECONDS;
      S.totalFocusSeconds  = (S.totalFocusSeconds||0)  + LEAF_SECONDS;
      
      // PERFECT LEAF LOGIC: Increment completed leaves (current blinking leaf becomes static)
      S.completedLeaves += 1;
      S.leavesTotal += 1;
      S.leavesToday += 1;
      S.weeklyLeaves += 1;

      // Check if LPT is complete (but continue allowing timer usage)
      if(S.completedLeaves >= S.leavesPerTree && !S.weeklyComplete){
        S.weeklyComplete=true;
        S.grid.unshift({week:S.week,year:S.year,live:true,ts:Date.now()});
        if(S.grid.length>52) S.grid.pop();
      }

      // Update all UI elements
      updateAllUI();

      // Reset timer for next session
      S.timers[timerId].secondsLeft = getSessionSecondsFor(timerId);
      clockEl.textContent = format(S.timers[timerId].secondsLeft);
      startBtn.textContent = `Start ${format(S.timers[timerId].secondsLeft)}`;

      setRunning(timerId, false);
      showRain(false);
      reflectLockUI();
      reflectModeSpecificUI();
    }

    function startFlow(){
      const {week, year} = isoWeekYear(new Date());
      if(!S.week){ S.week=week; S.year=year; }
      if(S.week!==week || S.year!==year){
        S.week=week; S.year=year;
        S.weeklyTargetLocked=false;
        S.weeklyLeaves=0;
        S.leavesToday=0;
        S.weeklyFocusSeconds=0;
        S.completedLeaves=0;
        S.weeklyComplete=false;
      }
      if(S.timers[S.activeTimer].secondsLeft<=0 || S.timers[S.activeTimer].secondsLeft>24*3600){
        S.timers[S.activeTimer].secondsLeft = getSessionSecondsFor(S.activeTimer);
      }
      clockEl.textContent = format(S.timers[S.activeTimer].secondsLeft);
      startWallClock(S.activeTimer);
      reflectLockUI();
      reflectModeSpecificUI();
    }

    // FIXED: Reset only removes current blinking leaf (if any), keeps completed leaves
    function resetTimer(){
      stopTimer(S.activeTimer); 
      showRain(false);
      
      // Reset only affects the timer, not completed leaves
      S.timers[S.activeTimer].secondsLeft = getSessionSecondsFor(S.activeTimer);
      clockEl.textContent = format(S.timers[S.activeTimer].secondsLeft);
      startBtn.textContent = `Start ${format(S.timers[S.activeTimer].secondsLeft)}`;
      
      // Update leaf display - this will remove current blinking leaf and keep completed ones
      updateLeafDisplay();
      
      updateAllUI();
      reflectLockUI();
      reflectModeSpecificUI();
    }

    // Build grid with week numbers 1-52
    function buildGrid() {
      if (!treeGrid) return;
      treeGrid.innerHTML = '';
      
      for (let weekNum = 1; weekNum <= 52; weekNum++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        
        const num = document.createElement('span');
        num.className = 'num';
        num.textContent = weekNum;
        cell.appendChild(num);
        
        const completed = S.grid.find(g => g.week === weekNum && g.live);
        if (completed) {
          cell.classList.add('live');
          const icon = document.createElement('div');
          icon.className = 'icon';
          icon.innerHTML = 'ðŸŒ³';
          cell.appendChild(icon);
        }
        
        treeGrid.appendChild(cell);
      }
      
      const completedCount = S.grid.filter(g => g.live).length;
      gridCount.textContent = `${completedCount} / 52`;
    }

    // LPT input behavior and locking (don't alter slider after LPT complete)
    const clamp = (v)=>Math.max(1, Math.min(200, Number(v)||1));
    lptInput.addEventListener('input', ()=>{
      if(S.weeklyTargetLocked) return; // Don't change if locked
      const v = clamp(lptInput.value);
      lptVal.textContent = String(v);
      weeklyTargetEl.textContent = `Weekly target = ${v*25} mins (as per LPT Ã— 25)`;
      xyLabel.textContent = `${S.completedLeaves}/${v} leaves (week)`;
    });

    lptSetBtn.addEventListener('click', ()=>{
      const {week, year} = isoWeekYear(new Date());
      if(!S.week){ S.week=week; S.year=year; }
      if(S.week!==week || S.year!==year){
        S.week=week; S.year=year; S.weeklyTargetLocked=false; S.completedLeaves=0; S.weeklyLeaves=0;
      }
      if(S.weeklyTargetLocked) return;
      const v = clamp(lptInput.value);
      S.leavesPerTree = v;
      S.weeklyTargetSetValue = v;
      S.weeklyTargetLocked = true;
      S.completedLeaves = 0; S.weeklyLeaves = 0; S.weeklyComplete = false;
      updateAllUI();
      lptVal.textContent = String(S.leavesPerTree);
      reflectLockUI();
      reflectModeSpecificUI();
    });

    function reflectLockUI(){
      lockHint.textContent = 'LPT locks after first entry every week';
      lptInput.disabled = !!S.weeklyTargetLocked;
      lptSetBtn.disabled = !!S.weeklyTargetLocked;
      lptInput.value = S.leavesPerTree;
      lptVal.textContent = String(S.leavesPerTree);
      xyLabel.textContent = `${S.completedLeaves}/${S.leavesPerTree} leaves (week)`;
      weeklyTargetEl.textContent = `Weekly target = ${S.leavesPerTree*25} mins (as per LPT Ã— 25)`;
    }

    function reflectModeSpecificUI(){
      if(S.activeTimer==='custom'){
        weeklyTargetEl.style.display = 'none';
        const secs = S.timers.custom.weeklySeconds||0;
        const h = Math.floor(secs/3600), m = Math.floor((secs%3600)/60);
        customWeekTotalEl.textContent = `Total duration (week): ${h} hrs ${m} mins`;
        customWeekTotalEl.style.display = 'block';
      }else{
        customWeekTotalEl.style.display = 'none';
        weeklyTargetEl.style.display = 'block';
      }
    }

    // Timer type switching
    timerTypeSel.addEventListener('change', ()=>{
      const next = timerTypeSel.value==='custom' ? 'custom' : 'pomodoro';
      if(next===S.activeTimer) return;
      stopTimer(S.activeTimer);
      S.activeTimer = next;
      customTimeRow.style.display = (next==='custom') ? 'flex' : 'none';
      const sec = getSessionSecondsFor(S.activeTimer);
      S.timers[S.activeTimer].secondsLeft = sec;
      clockEl.textContent = format(sec);
      startBtn.textContent = `Start ${format(sec)}`;
      updateLeafDisplay();
      reflectModeSpecificUI();
      save();
    });

    // Custom timer controls
    applyCustomBtn.addEventListener('click', ()=>{
      const m = Math.max(1, Math.min(MAX_CUSTOM_MIN, Number(customMinutes.value)||1));
      const s = Math.max(0, Math.min(59, Number(customSecondsEl.value)||0));
      const total = m*60 + s;
      S.timers.custom.sessionSeconds = total;
      S.timers.custom.secondsLeft = total;
      clockEl.textContent = format(total);
      startBtn.textContent = `Start ${format(total)}`;
      save();
    });

    // Mode switching
    function populateModeSelect() {
      modeSelect.innerHTML = '';
      MODE_IDS.forEach(id => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = NAMES[id] || DEFAULT_MODE_NAMES[id] || id;
        modeSelect.appendChild(option);
      });
      modeSelect.value = currentMode;
    }

    modeSelect.addEventListener('change', () => {
      const newMode = modeSelect.value;
      if (newMode === currentMode) return;
      
      saveState(currentMode, S);
      currentMode = newMode;
      G.selectedMode = currentMode;
      S = loadState(currentMode);
      
      modeNameEl.textContent = NAMES[currentMode] || DEFAULT_MODE_NAMES[currentMode] || currentMode;
      
      timerTypeSel.value = S.activeTimer;
      customTimeRow.style.display = (S.activeTimer==='custom') ? 'flex' : 'none';
      
      clockEl.textContent = format(S.timers[S.activeTimer].secondsLeft);
      startBtn.textContent = `Start ${format(S.timers[S.activeTimer].secondsLeft)}`;
      
      updateAllUI();
      
      reflectLockUI();
      reflectModeSpecificUI();
      saveGlobal();
    });

    // Name editing
    document.getElementById('saveNamesBtn').addEventListener('click', () => {
      NAMES.subject1 = document.getElementById('subject1Input').value.trim() || DEFAULT_MODE_NAMES.subject1;
      NAMES.subject2 = document.getElementById('subject2Input').value.trim() || DEFAULT_MODE_NAMES.subject2;
      NAMES.subject3 = document.getElementById('subject3Input').value.trim() || DEFAULT_MODE_NAMES.subject3;
      NAMES.user1 = document.getElementById('user1Input').value.trim() || DEFAULT_MODE_NAMES.user1;
      NAMES.user2 = document.getElementById('user2Input').value.trim() || DEFAULT_MODE_NAMES.user2;
      NAMES.user3 = document.getElementById('user3Input').value.trim() || DEFAULT_MODE_NAMES.user3;
      
      saveNames();
      populateModeSelect();
      modeNameEl.textContent = NAMES[currentMode] || DEFAULT_MODE_NAMES[currentMode] || currentMode;
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panelCard').forEach(p => p.style.display = 'none');
        
        tab.classList.add('active');
        const panelId = tab.dataset.tab;
        const panel = document.getElementById(panelId);
        if (panel) panel.style.display = 'flex';
      });
    });

    // Main timer controls
    startBtn.addEventListener('click', startFlow);
    resetBtn.addEventListener('click', resetTimer);

    // Initialize app
    function initApp() {
      populateCountryList();
      populateModeSelect();
      modeNameEl.textContent = NAMES[currentMode] || DEFAULT_MODE_NAMES[currentMode] || currentMode;
      
      // Set up timezone UI
      countryInput.value = G.country || 'India';
      tzLabel.textContent = `TZ: ${G.timeZone}`;
      
      timerTypeSel.value = S.activeTimer;
      customTimeRow.style.display = (S.activeTimer==='custom') ? 'flex' : 'none';
      
      customMinutes.value = Math.floor((S.timers.custom.sessionSeconds||DEFAULT_CUSTOM_MIN*60)/60);
      customSecondsEl.value = (S.timers.custom.sessionSeconds||0) % 60;
      
      clockEl.textContent = format(S.timers[S.activeTimer].secondsLeft);
      startBtn.textContent = `Start ${format(S.timers[S.activeTimer].secondsLeft)}`;
      
      document.getElementById('subject1Input').value = NAMES.subject1 || '';
      document.getElementById('subject2Input').value = NAMES.subject2 || '';
      document.getElementById('subject3Input').value = NAMES.subject3 || '';
      document.getElementById('user1Input').value = NAMES.user1 || '';
      document.getElementById('user2Input').value = NAMES.user2 || '';
      document.getElementById('user3Input').value = NAMES.user3 || '';
      
      updateAllUI();
      reflectLockUI();
      reflectModeSpecificUI();
    }

    initApp();
  </script>
</body>
</html>
